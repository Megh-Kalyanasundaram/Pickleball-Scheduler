<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pickleball Tournament Scheduler</title>
<meta name="description" content="Pickleball Tournament Scheduler — fixtures, scores, rankings, knockouts.">
<style>
  :root{
    --page-bg:#f5f6f7;
    --card-bg:#0f2435;
    --gold:#d4af37;
    --gold-hover:#e5c157;
    --muted:#9aa6b4;
    --card-text:#e7f3ff;
    --white:#ffffff;
    --radius:10px;
    --maxwidth:1240px;
    --shadow:0 8px 24px rgba(2,8,25,0.15);
    --input-height:42px;
    --toast-bg:#102238ee;
    --toast-text:#eaf4ff;
    --gap:12px;
  }
  *, *::before, *::after { box-sizing:border-box; }
  html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Arial,sans-serif;background:var(--page-bg);color:#102238;-webkit-font-smoothing:antialiased;}
  body { padding-top: 38px; }

  .banner{
    position:fixed;top:0;left:0;right:0;height:38px;display:flex;align-items:center;justify-content:center;
    padding:0 16px;background:var(--card-bg);color:var(--card-text);box-shadow:0 4px 16px rgba(0,0,0,0.2);
    z-index:999;font-weight:700;font-size:13px;letter-spacing:0.3px;
  }
  .wrap{max-width:var(--maxwidth);margin:0 auto;padding:12px 16px;}
  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:var(--gap);
  }
  @media (min-width:900px){
    .grid{grid-template-columns:1fr 360px;}
  }

  .card{
    background:var(--card-bg);
    color:var(--card-text);
    border-radius:var(--radius);
    padding:16px;
    box-shadow:var(--shadow);
  }
  .title{
    font-weight:700;
    color:#eaf4ff;
    margin:0 0 12px;
    font-size:15px;
  }

  /* Unified form controls */
  input[type="text"], input[type="number"], .score-input {
    width:100%;
    height:var(--input-height);
    padding:0 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(255,255,255,0.04);
    color:var(--card-text);
    font-size:14px;
    transition:all 0.2s ease;
  }
  input::placeholder, .score-input::placeholder { color:rgba(231,243,255,0.5); }
  input:focus, .score-input:focus {
    outline:none;
    border-color:var(--gold);
    background:rgba(255,255,255,0.08);
    box-shadow:0 0 0 3px rgba(212,175,55,0.2);
  }

  .score-input { width:76px; text-align:center; font-weight:600; }

  label{
    display:block;
    font-size:12.5px;
    color:var(--muted);
    margin-bottom:6px;
    font-weight:500;
  }

  /* Form layout */
  .form-row{
    display:flex;
    gap:var(--gap);
    align-items:end;
    width:100%;
    flex-wrap:wrap;
  }
  .form-item{
    display:flex;
    flex-direction:column;
    flex: 1 1 0;
    min-width:120px;
  }

  .checkbox-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-top:8px;
  }
  .checkbox-row input[type="checkbox"]{
    width:18px;height:18px;cursor:pointer;
  }

  .btn{
    height:var(--input-height);
    padding:0 16px;
    background:var(--gold);
    color:#102238;
    border:none;
    border-radius:8px;
    font-weight:700;
    font-size:13.5px;
    cursor:pointer;
    transition:all 0.2s;
    white-space:nowrap;
  }
  .btn:hover{ background:var(--gold-hover); transform:translateY(-1px); }
  .btn.ghost{
    background:transparent;
    color:var(--card-text);
    border:1px solid rgba(255,255,255,0.12);
  }
  .btn.small{ height:36px; font-size:12.5px; padding:0 12px; }
  .btn.block{ width:100%; }

  .action-row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:16px;
    justify-content:flex-end;
  }
  .action-row .btn{ flex:1; max-width:180px; }
  @media (min-width:480px){
    .action-row .btn{ flex:none; }
  }

  .match-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
    gap:var(--gap);
    margin-top:12px;
  }
  .match-card{
    background:rgba(255,255,255,0.025);
    border:1px solid rgba(255,255,255,0.06);
    border-radius:10px;
    padding:14px;
  }
  .match-title{
    font-size:13px;
    font-weight:700;
    color:#eaf4ff;
    margin-bottom:10px;
  }
  .team-label{
    font-weight:700;
    font-size:14px;
    color:#eaf4ff;
  }
  .team-players{
    font-size:12px;
    color:var(--muted);
    margin-top:4px;
    line-height:1.3;
  }

  .white-table{
    width:100%;
    border-collapse:collapse;
    background:var(--white);
    color:#102238;
    border-radius:8px;
    overflow:hidden;
    margin-top:12px;
    font-size:13px;
  }
  .white-table th{
    background:#f1f5f8;
    color:#667085;
    font-weight:700;
    text-align:left;
    padding:10px 8px;
  }
  .white-table td{
    padding:8px;
    border-bottom:1px solid #e6eaee;
  }

  .toast-container{
    position:fixed;
    z-index:12000;
    right:16px;
    bottom:16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:flex-end;
  }
  @media (max-width:600px){
    .toast-container{ left:50%; right:auto; transform:translateX(-50%); align-items:center; }
  }
  .toast{
    min-width:260px;
    max-width:420px;
    background:var(--toast-bg);
    color:var(--toast-text);
    border-radius:10px;
    padding:12px 16px;
    box-shadow:0 12px 32px rgba(0,0,0,0.3);
    display:flex;
    gap:12px;
    align-items:center;
    animation:toastIn 300ms ease forwards;
    position:relative;
    overflow:hidden;
  }
  .toast .accent{
    width:6px; height:100%; background:var(--gold); border-radius:4px; position:absolute; left:0; top:0;
  }
  @keyframes toastIn{ from{opacity:0;transform:translateY(10px) scale(0.98);} to{opacity:1;transform:none;} }
  @keyframes toastOut{ to{opacity:0;transform:translateY(-10px);} }
  .toast.fadeOut{ animation:toastOut 240ms ease forwards; }

  footer{
    margin-top:24px;
    text-align:center;
    font-size:12px;
    color:var(--muted);
  }

  /* Responsive: make the setup fit on narrower screens (iPhone 12 ~390px) */
  @media (max-width:428px){
    :root{ --input-height:36px; --gap:8px; }
    .card{ padding:12px; }
    .title{ font-size:14px; margin-bottom:8px; }
    label{ font-size:12px; margin-bottom:4px; }
    input[type="text"], input[type="number"], .score-input { font-size:13px; height:var(--input-height); padding:0 10px; }
    .form-row{ gap:8px; }
    .form-item{ min-width:0; flex-basis:100%; } /* stack */
    .action-row{ margin-top:10px; gap:8px; }
    .team-players{ font-size:12px; }
    .match-grid{ grid-template-columns:1fr; }
    footer{ font-size:11px; }
  }

  /* -------------------- Custom dropdown styles -------------------- */
  .custom-select-wrapper { position:relative; width:100%; }
  .custom-select {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    cursor:pointer;
    background:rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.08);
    height:var(--input-height);
    padding:0 12px;
    border-radius:8px;
    color:var(--card-text);
    font-size:14px;
    user-select:none;
  }
  .custom-select:focus { outline:none; box-shadow:0 0 0 3px rgba(212,175,55,0.12); border-color:var(--gold); }
  .custom-select .label { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; flex:1; text-align:left; }
  .custom-select .arrow { width:18px; height:18px; display:inline-block; opacity:0.9; transform:rotate(0deg); transition:transform 180ms ease; }
  .custom-select.open .arrow { transform:rotate(180deg); }
  .custom-options {
    position:absolute;
    left:0; right:0;
    margin-top:8px;
    background:var(--card-bg);
    color:var(--card-text);
    border-radius:8px;
    box-shadow:0 10px 36px rgba(2,6,20,0.6);
    max-height:280px;
    overflow:auto;
    z-index:1500;
    padding:6px 6px;
  }
  .custom-option {
    padding:10px 12px;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    color:var(--card-text);
    display:flex;
    align-items:center;
  }
  .custom-option + .custom-option { margin-top:6px; }
  .custom-option:hover,
  .custom-option.highlight,
  .custom-option[aria-selected="true"] {
    background:rgba(255,255,255,0.08);
    color:var(--card-text);
  }
  /* small selects (used for club dropdowns) */
  .custom-select.small { height:36px; font-size:13px; padding:0 10px; border-radius:6px; }
  .custom-options.small { max-height:220px; }

</style>
</head>
<body>
  <div class="banner" id="stageBanner">Current Stage: Round Robin</div>
  <div class="wrap">
    <div class="grid">
      <div>
        <!-- Setup -->
        <div class="card">
          <div class="title">Setup</div>
          <div class="form-row">
            <div class="form-item">
              <label>Game Type</label>
              <select id="gameType" onchange="onGameTypeChange()">
                <option value="doubles" selected>Doubles</option>
                <option value="singles">Singles</option>
              </select>
            </div>
            <div class="form-item">
              <label id="numLabel">No. of Teams</label>
              <input id="numTeams" type="number" min="2" value="8" oninput="updateQualifierDefaults()">
            </div>
            <div class="form-item">
              <label>No. of Courts</label>
              <input id="numCourts" type="number" min="1" value="2">
            </div>
            <div class="form-item">
              <label>Court Allocation</label>
              <select id="courtAlloc">
                <option value="roundwise" selected>Round-wise</option>
                <option value="sequential">Sequential (Simple)</option>
                <option value="balanced">Sequential (Balanced)</option>
              </select>
            </div>
            <div class="form-item">
              <label>No. of Groups</label>
              <input id="numGroups" type="number" min="1" value="2" oninput="updateQualifierDefaults()">
            </div>
            <div class="form-item">
              <label>Round-Robin Type</label>
              <select id="rrType" onchange="onRRTypeChange()">
                <option value="within" selected>Within Groups</option>
                <option value="across">Across All</option>
                <option value="club">Across Clubs</option>
              </select>
            </div>
            <div class="form-item">
              <label>Qualifiers/group</label>
              <select id="qualPerGroup" onchange="onQualPerGroupManual()">
                <option value="1">1</option>
                <option value="2" selected>2</option>
                <option value="4">4</option>
                <option value="8">8</option>
              </select>
            </div>
            <div class="form-item checkbox-row" style="align-items:center;">
              <input id="enableQF" type="checkbox">
              <label for="enableQF" style="margin:0;cursor:pointer;">Enable Quarterfinals</label>
            </div>
            <div class="form-item checkbox-row" style="align-items:center;">
              <input id="enableDUPR" type="checkbox">
              <label for="enableDUPR" style="margin:0;cursor:pointer;">Enable DUPR IDs</label>
            </div>
          </div>

          <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px;">
            <button id="manageClubsBtn" class="btn small ghost" style="display:none;" onclick="openClubDialog()">Manage Clubs</button>
          </div>

          <div class="action-row">
            <button class="btn" id="startEntryBtn" onclick="startEntry()">Next: Enter Details</button>
            <button class="btn ghost" id="resetBtn" onclick="if(confirm('Reset everything?'))location.reload()">Reset All</button>
            <button class="btn ghost small" id="loadBtn" onclick="openLoadDialog()">Load</button>
          </div>
        </div>

        <!-- Entry -->
        <div id="entryCard" class="card" style="margin-top:12px;display:none;">
          <div class="title" id="entryTitle">Enter Teams & Players</div>
          <div id="entryInner"></div>
        </div>

        <!-- Tournament Info -->
        <div id="tournamentInfo" class="card" style="margin-top:12px;display:none;align-items:center;justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:12px;flex:1;">
            <input id="tourneyName" type="text" style="background:transparent;border:0;color:var(--card-text);font-weight:700;font-size:15px;flex:1;" placeholder="Tournament Name">
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="muted" id="tourneyMeta" style="font-size:12px;"></div>
            <button class="btn small ghost" onclick="renameActiveTournament()">Rename</button>
          </div>
        </div>

        <!-- Summary -->
        <div id="summaryCard" class="card" style="margin-top:12px;display:none;">
          <div class="title">Group Summary</div>
          <div id="summaryInner"></div>
        </div>

        <!-- Fixtures -->
        <div id="fixturesCard" class="card" style="margin-top:12px;display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div class="title">Fixtures — Enter Scores</div>
            <button class="btn small" onclick="saveActiveTournament(true)">Save</button>
          </div>
          <div id="fixturesGrid" class="match-grid"></div>
          <div style="margin-top:12px;color:var(--muted);font-size:12.5px;">Enter both scores to count a match • No ties</div>
          <div class="action-row">
            <button class="btn" onclick="generateRankings()">Generate Rankings</button>
            <button class="btn ghost" onclick="showGroupSummary()">Back</button>
          </div>
        </div>

        <!-- Rankings -->
        <div id="rankingsCard" class="card" style="margin-top:12px;display:none;">
          <div class="title">Round-Robin Rankings</div>
          <div id="rankingsInner"></div>
          <div class="action-row">
            <button class="btn" onclick="proceedToKnockouts()">Proceed to Knockouts</button>
            <button class="btn ghost" onclick="exportCSV()">Export CSV</button>
            <button class="btn ghost" onclick="exportSummaryPDF()">Export Summary (PDF)</button>
            <button class="btn ghost" onclick="exportSchedulePDF()">Export Schedule (PDF)</button>
            <button class="btn ghost" onclick="window.print()">Print</button>
            <button class="btn ghost" onclick="printSchedule()">Print Schedule</button>
          </div>
        </div>

        <!-- Knockouts -->
        <div id="knockoutsCard" class="card" style="margin-top:12px;display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div class="title">Knockout Stage</div>
            <button class="btn small" onclick="saveActiveTournament(true)">Save</button>
          </div>
          <div id="knockoutsInner"></div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div>
        <div class="card">
          <div class="title">Quick Actions</div>
          <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
            <button class="btn small" onclick="generateFixtures()">Generate Fixtures</button>
            <button class="btn small" onclick="generateRankings()">Generate Rankings</button>
            <button class="btn small ghost" onclick="exportSchedulePDF()">Export Schedule (PDF)</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="title">Notes</div>
          <div style="margin-top:8px;font-size:12.5px;color:var(--muted);line-height:1.5;">
            • Round-robin excludes knockouts<br>
            • 4 qualifiers → Semifinals<br>
            • QF enabled → Quarterfinals<br>
            • Both scores required • No ties allowed
          </div>
        </div>
      </div>
    </div>

    <footer>Prompt-designed by Megh Kalyanasundaram</footer>
  </div>

  <div class="toast-container" id="toastContainer" aria-live="polite"></div>

<script>
/* ================== Utilities & existing app code (preserved) ================== */

const $ = id => document.getElementById(id);
function updateBanner(stage){ $('stageBanner').textContent = `Current Stage: ${stage}`; }
function showToast(message, type = 'success') {
  const container = $('toastContainer');
  if (!container) return console.log('Toast:', message);
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<div class="accent"></div><div style="flex:1;white-space:pre-wrap">${message}</div>`;
  container.appendChild(t);
  const timeout = setTimeout(() => {
    t.classList.add('fadeOut');
    setTimeout(() => t.remove(), 260);
  }, 3500);
  t.addEventListener('click', () => { clearTimeout(timeout); t.classList.add('fadeOut'); setTimeout(()=>t.remove(),220); });
}
function clampInt(v, min=0) { const n=Number(v); return Number.isNaN(n) ? min : Math.max(min, Math.floor(n)); }
function generateId(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6); }

/* ---------- App state (unchanged) ---------- */
let teams = [];
let fixtures = [];
let rankings = {};
let knockout = {};
let clubs = [];
let autosaveTimer = null;
const AUTOSAVE_DELAY = 800;
const TOAST_DURATION = 3500;
const TOURNAMENT_STORE_KEY = 'pickle_tournaments_v1';
const ACTIVE_TOURNAMENT_KEY = 'pickle_active_tournament_id';

/* ---------- Storage helpers (unchanged) ---------- */
function readTournamentStore(){ try { const raw = localStorage.getItem(TOURNAMENT_STORE_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ console.error(e); return []; } }
function writeTournamentStore(arr){ try { localStorage.setItem(TOURNAMENT_STORE_KEY, JSON.stringify(arr)); } catch(e){ console.error(e); showToast('Unable to write to local storage.','error'); } }
function getActiveTournamentId(){ return localStorage.getItem(ACTIVE_TOURNAMENT_KEY) || null; }
function setActiveTournamentId(id){ if (id) localStorage.setItem(ACTIVE_TOURNAMENT_KEY, id); else localStorage.removeItem(ACTIVE_TOURNAMENT_KEY); renderLoadControl(); renderTournamentInfo(); }
function getActiveTournament(){ const id = getActiveTournamentId(); if (!id) return null; return readTournamentStore().find(t => t.id === id) || null; }

/* ================== CUSTOM DROPDOWN: transform native <select> into custom UI ================== */

/*
  Strategy:
   - Keep the original <select> in the DOM but hide it with display:none.
   - Insert a custom-styled div (.custom-select-wrapper) after it which mirrors options and keeps the select.value synced.
   - Works for selects that exist at load and for selects created dynamically (call transformSelect on them).
   - Keyboard (ArrowUp/Down, Enter, Escape) and pointer supported.
*/

function transformSelect(sel){
  if (!sel || sel.dataset.customized === '1') return;
  // hide native select but keep it in DOM
  sel.style.display = 'none';
  sel.dataset.customized = '1';

  const wrapper = document.createElement('div');
  wrapper.className = 'custom-select-wrapper';
  const custom = document.createElement('div');
  custom.className = 'custom-select';
  custom.tabIndex = 0;
  const label = document.createElement('div');
  label.className = 'label';
  const arrow = document.createElement('div');
  arrow.className = 'arrow';
  arrow.innerHTML = '&#9662;'; // down caret
  custom.appendChild(label);
  custom.appendChild(arrow);

  // build options container but hidden by default
  const optionsBox = document.createElement('div');
  optionsBox.className = 'custom-options';
  optionsBox.style.display = 'none';

  // helper to build option nodes
  function buildOptions(){
    optionsBox.innerHTML = '';
    Array.from(sel.options).forEach((opt, index) => {
      const o = document.createElement('div');
      o.className = 'custom-option';
      o.tabIndex = -1;
      o.dataset.value = opt.value;
      o.dataset.index = index;
      o.textContent = opt.textContent;
      if (opt.disabled) { o.style.opacity = '0.5'; o.style.pointerEvents = 'none'; }
      if (opt.selected) o.setAttribute('aria-selected','true');
      o.addEventListener('click', () => {
        selectIndex(index);
        closeOptions();
        sel.dispatchEvent(new Event('change', { bubbles:true }));
      });
      optionsBox.appendChild(o);
    });
  }

  // find initially selected
  function syncLabel(){
    const selected = sel.options[sel.selectedIndex];
    label.textContent = selected ? selected.textContent : '';
    // highlight selected option in optionsBox
    const opts = optionsBox.querySelectorAll('.custom-option');
    opts.forEach(o => o.removeAttribute('aria-selected'));
    if (selected){
      const selOpt = optionsBox.querySelector(`.custom-option[data-index="${sel.selectedIndex}"]`);
      if (selOpt) selOpt.setAttribute('aria-selected','true');
    }
  }

  function openOptions(){
    if (optionsBox.childElementCount === 0) buildOptions();
    optionsBox.style.display = 'block';
    custom.classList.add('open');
    // set highlight on current selection
    highlightIndex(sel.selectedIndex || 0);
    // focus so keyboard events work
    custom.focus();
    document.addEventListener('click', onDocClick);
  }

  function closeOptions(){
    optionsBox.style.display = 'none';
    custom.classList.remove('open');
    clearHighlight();
    document.removeEventListener('click', onDocClick);
  }

  function onDocClick(e){
    if (!wrapper.contains(e.target)) closeOptions();
  }

  function selectIndex(idx){
    const index = Number(idx);
    if (isNaN(index)) return;
    sel.selectedIndex = index;
    syncLabel();
    // ensure the underlying select's value is available immediately for your code
    // (most event handlers read select.value)
  }

  // keyboard navigation
  let highlighted = -1;
  function highlightIndex(idx){
    const items = optionsBox.querySelectorAll('.custom-option');
    if (!items || items.length===0) return;
    if (highlighted>=0 && items[highlighted]) items[highlighted].classList.remove('highlight');
    highlighted = Math.max(0, Math.min(items.length-1, idx));
    if (items[highlighted]) {
      items[highlighted].classList.add('highlight');
      // ensure visible
      const rect = items[highlighted].getBoundingClientRect();
      const boxRect = optionsBox.getBoundingClientRect();
      if (rect.top < boxRect.top) items[highlighted].scrollIntoView({ block: 'nearest' });
      if (rect.bottom > boxRect.bottom) items[highlighted].scrollIntoView({ block: 'nearest' });
    }
  }
  function clearHighlight(){ const items = optionsBox.querySelectorAll('.custom-option'); items.forEach(i=>i.classList.remove('highlight')); highlighted = -1; }

  // handle key events
  custom.addEventListener('keydown', (ev) => {
    if (optionsBox.style.display === 'none') {
      if (ev.key === 'Enter' || ev.key === ' ' || ev.key === 'ArrowDown' || ev.key === 'ArrowUp'){
        ev.preventDefault();
        openOptions();
      }
      return;
    }
    const items = optionsBox.querySelectorAll('.custom-option');
    if (ev.key === 'ArrowDown'){ ev.preventDefault(); highlightIndex((highlighted+1) || 0); }
    else if (ev.key === 'ArrowUp'){ ev.preventDefault(); highlightIndex((highlighted-1)>=0 ? (highlighted-1) : (items.length-1)); }
    else if (ev.key === 'Enter'){
      ev.preventDefault();
      if (highlighted>=0 && items[highlighted]) {
        const idx = Number(items[highlighted].dataset.index);
        selectIndex(idx);
        closeOptions();
        sel.dispatchEvent(new Event('change', { bubbles:true }));
      }
    } else if (ev.key === 'Escape'){
      ev.preventDefault();
      closeOptions();
    }
  });

  // pointer open/close
  custom.addEventListener('click', (e) => {
    if (optionsBox.style.display === 'none') openOptions();
    else closeOptions();
  });

  // when the original select changes elsewhere, sync label
  sel.addEventListener('change', () => syncLabel());

  // when select's options change (useful for dynamic club selects), rebuild
  const mo = new MutationObserver(mutations => {
    // if options changed, rebuild
    if (Array.from(mutations).some(m => m.type === 'childList')) {
      buildOptions();
      syncLabel();
    }
  });
  mo.observe(sel, { childList: true, subtree: true });

  // append nodes
  wrapper.appendChild(sel);
  wrapper.appendChild(custom);
  wrapper.appendChild(optionsBox);

  // place wrapper where select used to be (select is now child inside wrapper)
  sel.parentNode.insertBefore(wrapper, sel.nextSibling);

  // initial populate
  buildOptions();
  syncLabel();

  // store refs for later
  sel._custom = { wrapper, custom, optionsBox, label };
}

/* Transform all selects on the page (call on load) */
function transformAllSelects(){
  document.querySelectorAll('select').forEach(s => transformSelect(s));
}

/* ----------------- Override/augment code that inserts dynamic selects --------------- */
/* We'll re-run transformSelect on any newly created select elements where needed.
   The two places in your code that create dynamic selects are:
    - Entry generation (club_x selects)
    - updateClubDropdowns() which replaces club selects' innerHTML
   We'll make sure to call transformSelect appropriately after those operations.
*/

/* ---------- Existing functions modified slightly where needed ---------- */

/* onRRTypeChange: show/hide manage clubs button (select is still present, value readable) */
function onRRTypeChange(){
  const rr = $('rrType').value;
  $('manageClubsBtn').style.display = (rr==='club') ? 'inline-block' : 'none';
}

/* startEntry: if club RR and no clubs, open dialog; else generate entry HTML then transform any created selects */
function startEntry(){
  const n = clampInt($('numTeams').value, 2);
  if (n < 2) return showToast('Minimum 2 participants','warn');
  const type = $('gameType').value;
  const dupr = $('enableDUPR').checked;
  const clubRR = $('rrType').value === 'club';
  if (clubRR && clubs.length===0) {
    openClubDialog();
    showToast('Please add clubs before entry','warn');
    return;
  }

  let html = '';
  for(let i=1;i<=n;i++){
    const idx = i;
    html += `<div style="background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;margin-bottom:12px;">`;
    if(type==='singles'){
      html += `<label style="font-size:13px;color:var(--muted)">Player ${i}</label>
        <div style="display:flex;gap:8px;margin-top:6px;">
          <input id="pA_${i}" type="text" placeholder="Player name" style="flex:1;">
          ${dupr ? `<input id="dA_${i}" type="text" placeholder="DUPR" style="width:120px;">` : ''}
        </div>`;
      if(clubRR) html += `<div style="margin-top:8px;"><select id="club_${i}"><option value="">--</option>${clubs.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>`;
    } else {
      html += `<label style="font-size:13px;color:var(--muted)">Team ${i}</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px;">
          <div>
            <input id="pA_${i}" type="text" placeholder="Player A">
            ${dupr ? `<input id="dA_${i}" type="text" placeholder="DUPR A" style="margin-top:4px;">` : ''}
          </div>
          <div>
            <input id="pB_${i}" type="text" placeholder="Player B">
            ${dupr ? `<input id="dB_${i}" type="text" placeholder="DUPR B" style="margin-top:4px;">` : ''}
          </div>
        </div>`;
      if(clubRR) html += `<div style="margin-top:8px;"><select id="club_${i}"><option value="">--</option>${clubs.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>`;
    }
    html += `</div>`;
  }
  html += `<div class="action-row">
    <button class="btn" onclick="saveTeams();showToast('Teams saved','success');">Save Teams</button>
    <button class="btn ghost" onclick="$('entryCard').style.display='none';updateBanner('Round Robin')">Cancel</button>
  </div>`;
  $('entryInner').innerHTML = html;
  // Transform any select elements we just injected (club_x)
  document.querySelectorAll('#entryInner select').forEach(s => transformSelect(s));
  $('entryCard').style.display = 'block';
  updateBanner('Entry');
}

/* updateClubDropdowns: repopulate select elements for clubs and transform them after updating */
function updateClubDropdowns(){
  // update native selects (they may be hidden inside wrappers if already transformed)
  // find selects by id or those inside wrappers; replace options, then ensure transformSelect called
  document.querySelectorAll('select[id^="club_"]').forEach(sel => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">--</option>' + clubs.map(c=>`<option value="${c}">${c}</option>`).join('');
    if (clubs.includes(cur)) sel.value = cur;
    // If select has already been transformed, we also need to rebuild its custom options:
    if (sel.dataset.customized === '1' && sel._custom && sel._custom.optionsBox) {
      // rebuild options by using the transformSelect's internal build (we reconstruct)
      // simple approach: remove existing option elements and rebuild by re-calling transformSelect (after unwrapping)
      // but to avoid destructive operations, trigger a change event and let MutationObserver pick up changes.
      sel.dispatchEvent(new Event('change', { bubbles:true }));
    } else {
      transformSelect(sel);
    }
  });
}

/* ---------- Entry save and remaining app logic unchanged (preserve original functions) ---------- */

/* Snapshot & restore */
function snapshotCurrentState(){
  const settings = {
    gameType: $('gameType').value,
    numTeams: Number($('numTeams').value) || 0,
    numCourts: Number($('numCourts').value) || 1,
    numGroups: Number($('numGroups').value) || 1,
    qualPerGroup: Number($('qualPerGroup').value) || 1,
    enableQF: !!$('enableQF')?.checked,
    rrType: $('rrType').value,
    courtAlloc: $('courtAlloc').value,
    clubs: clubs.slice(),
    duprEnabled: !!$('enableDUPR')?.checked
  };
  const teamsCopy = teams.map(t => ({ ...t, players: (t.players||[]).map(p => ({...p})) }));
  const fixturesCopy = fixtures.map(f => ({ id:f.id, matchNum:f.matchNum, court:f.court, group:f.group, t1Id: f.t1.id, t2Id: f.t2.id, round: f.round || null }));
  const fixtureScores = {};
  fixtures.forEach(f => {
    const s1 = $(`s1-${f.id}`) ? $(`s1-${f.id}`).value : '';
    const s2 = $(`s2-${f.id}`) ? $(`s2-${f.id}`).value : '';
    fixtureScores[f.id] = { s1, s2 };
  });
  const ko = { knockout: null, scores: {} };
  if (knockout && (knockout.qf || knockout.sf1 || knockout.final || knockout.third)){
    ko.knockout = knockout;
    document.querySelectorAll('input.score-input').forEach(inp => { if (inp.id) ko.scores[inp.id] = inp.value || ''; });
  }
  return { settings, teams: teamsCopy, fixtures: fixturesCopy, fixtureScores, ko, timestamp: Date.now() };
}

function restoreSnapshot(data){
  if (!data) return;
  const s = data.settings || {};
  $('gameType').value = s.gameType || 'doubles';
  $('numTeams').value = s.numTeams || 8;
  $('numCourts').value = s.numCourts || 2;
  $('numGroups').value = s.numGroups || 2;
  $('qualPerGroup').value = s.qualPerGroup || 2;
  if ($('enableQF')) $('enableQF').checked = !!s.enableQF;
  $('rrType').value = s.rrType || 'within';
  $('courtAlloc').value = s.courtAlloc || 'roundwise';
  clubs = (s.clubs && Array.isArray(s.clubs)) ? s.clubs.slice() : [];
  if ($('enableDUPR')) $('enableDUPR').checked = !!s.duprEnabled;

  onGameTypeChange();
  onRRTypeChange();

  teams = (data.teams || []).map(t => ({
    id: t.id, name: t.name, players: t.players || [], group: t.group || null, club: t.club || '', isBye: !!t.isBye
  }));

  const idToTeam = {}; teams.forEach(tt => idToTeam[tt.id] = tt);
  fixtures = (data.fixtures || []).map(f => ({
    id: f.id, matchNum: f.matchNum, court: f.court, group: f.group, round: f.round || null,
    t1: idToTeam[f.t1Id] || {id:f.t1Id,name:'??',players:[],club:'',isBye:false},
    t2: idToTeam[f.t2Id] || {id:f.t2Id,name:'??',players:[],club:'',isBye:false}
  }));

  showGroupSummary();
  renderFixtures();

  const scores = data.fixtureScores || {};
  Object.keys(scores).forEach(k => {
    if ($(`s1-${k}`)) $(`s1-${k}`).value = scores[k].s1 || '';
    if ($(`s2-${k}`)) $(`s2-${k}`).value = scores[k].s2 || '';
  });

  if (data.ko && data.ko.knockout){
    knockout = data.ko.knockout;
    renderAppropriateKnockoutView();
    const koScores = data.ko.scores || {};
    Object.keys(koScores).forEach(id => { if ($(id)) $(id).value = koScores[id] || ''; });
  } else knockout = {};
}

/* Tournament Save/Load */
function makeTimestampName(){
  const d = new Date();
  const p = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}h${p(d.getMinutes())}`;
}

function createTournament(name){
  const id = 't_' + Math.random().toString(36).slice(2,10);
  const tournament = { id, name: name || makeTimestampName(), createdAt: new Date().toISOString(), lastSaved: Date.now(), snapshot: snapshotCurrentState() };
  const arr = readTournamentStore();
  arr.unshift(tournament);
  writeTournamentStore(arr);
  setActiveTournamentId(id);
  renderLoadControl();
  renderTournamentInfo();
  showToast(`Tournament created: ${tournament.name}`, 'success');
  return tournament;
}

function saveActiveTournament(manual){
  const id = getActiveTournamentId();
  if (!id) { if (manual) showToast('No active tournament. Save teams first.','warn'); return false; }
  const arr = readTournamentStore();
  const idx = arr.findIndex(t => t.id === id);
  const snap = snapshotCurrentState();
  const now = Date.now();
  if (idx >= 0){
    arr[idx].snapshot = snap;
    arr[idx].lastSaved = now;
  } else {
    arr.unshift({ id, name: makeTimestampName(), createdAt: new Date().toISOString(), lastSaved: now, snapshot: snap });
  }
  writeTournamentStore(arr);
  renderLoadControl();
  renderTournamentInfo();
  if (manual) showToast('Tournament saved','success');
  return true;
}

function scheduleAutoSave(){
  ensureTournamentExistsOnFirstSave();
  if (!getActiveTournamentId()) return;
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=>{ saveActiveTournament(false); autosaveTimer = null; showToast('Auto-saved','success'); }, AUTOSAVE_DELAY);
}

function ensureTournamentExistsOnFirstSave(){
  if (getActiveTournamentId()) return;
  createTournament(makeTimestampName());
}

/* Load Dialog */
function renderLoadControl(){
  const arr = readTournamentStore();
  const btn = $('loadBtn');
  if (btn) btn.style.display = arr.length ? 'inline-block' : 'none';
}

function openLoadDialog(){
  const arr = readTournamentStore();
  if (!arr.length) return showToast('No saved tournaments.','warn');
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(2,6,15,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;';
  const box = document.createElement('div');
  box.style.cssText = 'width:min(680px,95%);max-height:80%;overflow:auto;background:var(--card-bg);border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,0.6);';
  box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="font-weight:800;color:#eaf4ff">Load Tournament</div>
      <button class="btn ghost small" onclick="this.closest('.overlay').remove()">Close</button>
    </div>
    <div id="loadList" style="display:flex;flex-direction:column;gap:8px;"></div>`;
  overlay.className = 'overlay';
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  const list = box.querySelector('#loadList');
  arr.forEach(t => {
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;';
    div.innerHTML = `<div>
        <div style="font-weight:700;max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.name}</div>
        <div style="font-size:12px;color:var(--muted)">${new Date(t.lastSaved||t.createdAt).toLocaleString()}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn small" data-id="${t.id}">Load</button>
        <button class="btn ghost small" data-del="${t.id}">Delete</button>
      </div>`;
    list.appendChild(div);
  });

  box.addEventListener('click', e => {
    const loadBtn = e.target.closest('button[data-id]');
    const delBtn = e.target.closest('button[data-del]');
    if (loadBtn){
      const id = loadBtn.dataset.id;
      const tourney = readTournamentStore().find(x=>x.id===id);
      if (!tourney) return showToast('Not found','error');
      if (!confirm(`Load "${tourney.name}"? Current data will be replaced.`)) return;
      setActiveTournamentId(id);
      restoreSnapshot(tourney.snapshot);
      renderTournamentInfo();
      overlay.remove();
      showToast(`Loaded: ${tourney.name}`,'success');
    }
    if (delBtn){
      if (!confirm('Delete permanently?')) return;
      let store = readTournamentStore();
      store = store.filter(x=>x.id !== delBtn.dataset.del);
      writeTournamentStore(store);
      overlay.remove();
      renderLoadControl();
      showToast('Deleted','success');
    }
  });
}

/* Tournament Info */
function renderTournamentInfo(){
  const info = $('tournamentInfo');
  const active = getActiveTournament();
  if (!info) return;
  if (!active) { info.style.display='none'; return; }
  info.style.display='flex';
  $('tourneyName').value = active.name || '';
  $('tourneyMeta').textContent = `Saved: ${new Date(active.lastSaved||active.createdAt).toLocaleString()}`;
}

function renameActiveTournament(){
  const id = getActiveTournamentId();
  if (!id) return showToast('No active tournament','warn');
  const newName = $('tourneyName').value.trim();
  if (!newName) return showToast('Enter a name','warn');
  const arr = readTournamentStore();
  const idx = arr.findIndex(x=>x.id===id);
  if (idx<0) return;
  arr[idx].name = newName;
  arr[idx].lastSaved = Date.now();
  writeTournamentStore(arr);
  renderTournamentInfo();
  showToast('Renamed','success');
}

/* Club Management */
function openClubDialog(){
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';
  const box = document.createElement('div');
  box.style.cssText = 'width:min(600px,95%);background:var(--card-bg);border-radius:10px;padding:20px;max-height:90%;overflow:auto;';
  box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="margin:0;color:#eaf4ff;">Manage Clubs</h3>
      <button class="btn ghost small" onclick="this.closest('.overlay').remove()">Close</button>
    </div>
    <div id="clubList" style="display:flex;flex-direction:column;gap:8px;"></div>
    <div style="margin-top:16px;display:flex;gap:8px;">
      <button id="addClubBtn" class="btn small ghost">+ Add Club</button>
    </div>
    <div style="margin-top:12px;text-align:right;">
      <button class="btn small" onclick="saveActiveTournament(true);this.closest('.overlay').remove();showToast('Clubs saved','success')">Save & Close</button>
    </div>`;
  overlay.className='overlay';
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  function renderClubs(){
    const list = box.querySelector('#clubList');
    list.innerHTML = '';
    clubs.forEach((c,i) => {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;';
      row.innerHTML = `<span style="font-weight:600;">${c}</span>
        <div>
          <button class="btn ghost small" ${i===0?'disabled':''} data-dir="up" data-i="${i}">↑</button>
          <button class="btn ghost small" ${i===clubs.length-1?'disabled':''} data-dir="down" data-i="${i}">↓</button>
          <button class="btn ghost small" data-del="${i}">Delete</button>
        </div>`;
      list.appendChild(row);
    });
  }
  renderClubs();

  box.querySelector('#addClubBtn').onclick = () => {
    const name = prompt('Club name:')?.trim();
    if (!name) return;
    if (clubs.includes(name)) return showToast('Already exists','warn');
    clubs.push(name);
    renderClubs();
    updateClubDropdowns();
  };

  box.addEventListener('click', e => {
    const btn = e.target;
    if (btn.dataset.dir){
      const i = Number(btn.dataset.i);
      if (btn.dataset.dir==='up' && i>0){ [clubs[i-1],clubs[i]]=[clubs[i],clubs[i-1]]; renderClubs(); }
      if (btn.dataset.dir==='down' && i<clubs.length-1){ [clubs[i],clubs[i+1]]=[clubs[i+1],clubs[i]]; renderClubs(); }
      updateClubDropdowns();
    }
    if (btn.dataset.del!==undefined){
      clubs.splice(Number(btn.dataset.del),1);
      renderClubs();
      updateClubDropdowns();
    }
  });
}

/* Update club selects (calls transformSelect or relies on MutationObserver to update custom options) */
function updateClubDropdowns(){
  document.querySelectorAll('select[id^="club_"]').forEach(sel => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">--</option>' + clubs.map(c=>`<option value="${c}">${c}</option>`).join('');
    if (clubs.includes(cur)) sel.value = cur;
    if (sel.dataset.customized === '1') {
      // trigger change event to sync custom UI (MutationObserver picks up child list changes)
      sel.dispatchEvent(new Event('change', { bubbles:true }));
    } else {
      transformSelect(sel);
    }
  });
}

/* Entry & teams */
function saveTeams(){
  const n = clampInt($('numTeams').value);
  const type = $('gameType').value;
  const dupr = $('enableDUPR').checked;
  const clubRR = $('rrType').value === 'club';
  teams = [];
  for(let i=1;i<=n;i++){
    const nameA = $(`pA_${i}`)?.value.trim() || (type==='singles'?`Player ${i}`:`P${i}A`);
    const nameB = type==='doubles' ? $(`pB_${i}`)?.value.trim() || `P${i}B` : '';
    const duprA = dupr ? $(`dA_${i}`)?.value.trim() : '';
    const duprB = dupr && type==='doubles' ? $(`dB_${i}`)?.value.trim() : '';
    const club = clubRR ? $(`club_${i}`)?.value : '';
    const players = type==='singles' ? [{name:nameA,dupr:duprA}] : [{name:nameA,dupr:duprA},{name:nameB,dupr:duprB}];
    teams.push({id:generateId('t'), name: type==='singles'?nameA:`Team ${i}`, players, group:null, club, isBye:false});
  }
  assignGroups();
  $('entryCard').style.display='none';
  updateBanner('Round Robin');
  ensureTournamentExistsOnFirstSave();
  saveActiveTournament(true);
}

/* Groups, fixtures, rankings, knockouts (unchanged) */
function assignGroups(){
  const numGroups = clampInt($('numGroups').value,1);
  teams.forEach((t,i)=> t.group = (i % numGroups) + 1);
  showGroupSummary();
}
function showGroupSummary(){
  let html = '';
  const groups = {};
  teams.forEach(t=>{ if(!groups[t.group]) groups[t.group]=[]; groups[t.group].push(t); });
  Object.keys(groups).sort().forEach(g=>{
    html += `<div class="card" style="margin-top:12px;"><div class="title">Group ${g} (${groups[g].length} teams)</div><div style="display:grid;gap:8px;">`;
    groups[g].forEach(t=>{
      const players = t.players.map(p=>p.name + (p.dupr?` (${p.dupr})`:``)).join(' / ');
      html += `<div style="background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;">
        <div style="font-weight:600;">${t.name}${t.club?` — ${t.club}`:''}</div>
        <div style="font-size:12.5px;color:var(--muted);margin-top:4px;">${players}</div>
      </div>`;
    });
    html += `</div></div>`;
  });
  $('summaryInner').innerHTML = html;
  $('summaryCard').style.display = 'block';
  $('fixturesCard').style.display = 'none';
  $('rankingsCard').style.display = 'none';
  $('knockoutsCard').style.display = 'none';
  updateBanner('Summary');
}
function generateFixtures(){
  if (teams.length===0) return showToast('Enter teams first','warn');
  fixtures = [];
  const rrType = $('rrType').value;
  const courtAlloc = $('courtAlloc').value;
  const courts = clampInt($('numCourts').value,1);
  if (rrType==='within'){
    const groups = {};
    teams.forEach(t=> { if(!groups[t.group]) groups[t.group]=[]; groups[t.group].push(t); });
    let matchNum = 1;
    Object.keys(groups).forEach(g=>{
      const groupTeams = groups[g];
      for(let i=0;i<groupTeams.length;i++){
        for(let j=i+1;j<groupTeams.length;j++){
          const t1 = groupTeams[i], t2 = groupTeams[j];
          fixtures.push({id:generateId('m'), matchNum:matchNum++, group:Number(g), t1, t2, court:null, round:null});
        }
      }
    });
  } else if (rrType==='across'){
    for(let i=0;i<teams.length;i++){
      for(let j=i+1;j<teams.length;j++){
        fixtures.push({id:generateId('m'), matchNum:fixtures.length+1, group:null, t1:teams[i], t2:teams[j], court:null, round:null});
      }
    }
  } else if (rrType==='club'){
    const clubMap = {};
    teams.forEach(t=>{ if(!clubMap[t.club]) clubMap[t.club]=[]; clubMap[t.club].push(t); });
    let matchNum = 1;
    Object.keys(clubMap).forEach(c=>{
      const clubTeams = clubMap[c];
      for(let i=0;i<clubTeams.length;i++){
        for(let j=i+1;j<clubTeams.length;j++){
          fixtures.push({id:generateId('m'), matchNum:matchNum++, group:null, t1:clubTeams[i], t2:clubTeams[j], court:null, round:null});
        }
      }
    });
  }
  if (courtAlloc==='roundwise'){
    let round = 1;
    fixtures.forEach((f,i)=>{
      f.round = round;
      f.court = (i % courts) + 1;
      if ((i+1) % courts === 0) round++;
    });
  } else {
    fixtures.forEach((f,i)=> f.court = (i % courts) + 1);
  }
  renderFixtures();
  $('fixturesCard').style.display = 'block';
  $('summaryCard').style.display = 'none';
  updateBanner('Fixtures');
  scheduleAutoSave();
}
function renderFixtures(){
  const grid = $('fixturesGrid');
  grid.innerHTML = '';
  const rounds = {};
  fixtures.forEach(f=>{ if(!rounds[f.round||'all']) rounds[f.round||'all']=[]; rounds[f.round||'all'].push(f); });
  Object.keys(rounds).sort((a,b)=>a===b?0:(a==='all'?1:b==='all'?-1:Number(a)-Number(b))).forEach(r=>{
    const roundDiv = document.createElement('div');
    roundDiv.innerHTML = `<div class="match-title">${r==='all'?'All Matches':`Round ${r}`}</div>`;
    const inner = document.createElement('div');
    inner.style.display='grid';
    inner.style.gridTemplateColumns='repeat(auto-fill,minmax(300px,1fr))';
    inner.style.gap='12px';
    rounds[r].forEach(f=>{
      const card = document.createElement('div');
      card.className='match-card';
      const players1 = f.t1.players.map(p=>p.name+(p.dupr?` (${p.dupr})`:``)).join(' / ');
      const players2 = f.t2.players.map(p=>p.name+(p.dupr?` (${p.dupr})`:``)).join(' / ');
      card.innerHTML = `
        <div style="font-size:13px;color:var(--muted);margin-bottom:8px;">Match ${f.matchNum}${f.court?` • Court ${f.court}`:''}</div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div style="flex:1;">
            <div class="team-label">${f.t1.name}</div>
            <div class="team-players">${players1}</div>
          </div>
          <input id="s1-${f.id}" class="score-input" type="number" min="0" placeholder="0" oninput="scheduleAutoSave()">
        </div>
        <div style="margin:8px 0;text-align:center;font-weight:800;font-size:18px;">vs</div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div style="flex:1;">
            <div class="team-label">${f.t2.name}</div>
            <div class="team-players">${players2}</div>
          </div>
          <input id="s2-${f.id}" class="score-input" type="number" min="0" placeholder="0" oninput="scheduleAutoSave()">
        </div>`;
      inner.appendChild(card);
    });
    roundDiv.appendChild(inner);
    grid.appendChild(roundDiv);
  });
}
function generateRankings(){
  rankings = {};
  const teamStats = {};
  teams.forEach(t=> teamStats[t.id]={t, played:0, won:0, lost:0, pf:0, pa:0, pd:0, pts:0});
  fixtures.forEach(f=>{
    const s1 = Number($(`s1-${f.id}`)?.value||0);
    const s2 = Number($(`s2-${f.id}`)?.value||0);
    if (s1===0 && s2===0) return;
    if (s1===s2) { showToast('No ties allowed!','warn'); return; }
    teamStats[f.t1.id].played++;
    teamStats[f.t2.id].played++;
    teamStats[f.t1.id].pf += s1; teamStats[f.t1.id].pa += s2;
    teamStats[f.t2.id].pf += s2; teamStats[f.t2.id].pa += s1;
    if (s1>s2){
      teamStats[f.t1.id].won++; teamStats[f.t1.id].pts += 3;
      teamStats[f.t2.id].lost++;
    } else {
      teamStats[f.t2.id].won++; teamStats[f.t2.id].pts += 3;
      teamStats[f.t1.id].lost++;
    }
  });
  Object.values(teamStats).forEach(s=>{ s.pd = s.pf - s.pa; });
  const sorted = Object.values(teamStats).sort((a,b)=>{
    if (b.pts !== a.pts) return b.pts - a.pts;
    if (b.pd !== a.pd) return b.pd - a.pd;
    if (b.pf !== a.pf) return b.pf - a.pf;
    return 0;
  });
  let html = '<table class="white-table"><thead><tr><th>Pos</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>PF</th><th>PA</th><th>PD</th><th>Pts</th></tr></thead><tbody>';
  sorted.forEach((s,i)=>{
    const players = s.t.players.map(p=>p.name+(p.dupr?` (${p.dupr})`:``)).join(' / ');
    html += `<tr><td>${i+1}</td><td><strong>${s.t.name}</strong><br><small style="color:#666">${players}</small></td>
      <td>${s.played}</td><td>${s.won}</td><td>${s.lost}</td><td>${s.pf}</td><td>${s.pa}</td><td>${s.pd}</td><td><strong>${s.pts}</strong></td></tr>`;
  });
  html += '</tbody></table>';
  $('rankingsInner').innerHTML = html;
  $('rankingsCard').style.display='block';
  $('fixturesCard').style.display='none';
  updateBanner('Rankings');
}
function proceedToKnockouts(){
  const qualPer = Number($('qualPerGroup').value);
  const groups = {};
  teams.forEach(t=> { if(!groups[t.group]) groups[t.group]=[]; groups[t.group].push(t); });
  const qualifiers = [];
  Object.keys(groups).forEach(g=>{
    const ranked = teams.filter(t=>t.group===Number(g)).sort((a,b)=>{
      const sa = rankings[a.id] || {}, sb = rankings[b.id] || {};
      if ((sb.pts||0) !== (sa.pts||0)) return (sb.pts||0)-(sa.pts||0);
      return 0;
    });
    qualifiers.push(...ranked.slice(0,qualPer));
  });
  const totalQual = qualifiers.length;
  const enableQF = $('enableQF').checked && totalQual >= 8;
  const stages = enableQF ? 8 : (totalQual >= 4 ? 4 : 2);
  knockout = { qualifiers, stages, qf:null, sf1:null, sf2:null, final:null, third:null };
  renderAppropriateKnockoutView();
  $('knockoutsCard').style.display='block';
  $('rankingsCard').style.display='none';
  updateBanner('Knockouts');
}
function renderAppropriateKnockoutView(){
  const inner = $('knockoutsInner');
  inner.innerHTML = '';
  const q = knockout.qualifiers;
  if (knockout.stages===8){
    const matches = [
      {t1:q[0],t2:q[7]}, {t1:q[3],t2:q[4]},
      {t1:q[1],t2:q[6]}, {t1:q[2],t2:q[5]}
    ];
    inner.innerHTML += '<div class="title" style="text-align:center;margin-bottom:16px;">Quarterfinals</div>';
    inner.innerHTML += renderKOBracket(matches,'qf');
    knockout.qf = matches;
  }
  if (knockout.stages>=4){
    inner.innerHTML += '<div class="title" style="text-align:center;margin:24px 0 16px;">Semifinals</div>';
    const sf1 = knockout.qf ? [knockout.qf[0],knockout.qf[1]] : [q[0],q[3]];
    const sf2 = knockout.qf ? [knockout.qf[2],knockout.qf[3]] : [q[1],q[2]];
    inner.innerHTML += renderKOBracket([sf1,sf2],'sf');
  }
  inner.innerHTML += '<div class="title" style="text-align:center;margin:24px 0 16px;">Final</div>';
  inner.innerHTML += renderKOBracket([null],'final');
  if (knockout.stages>=4) inner.innerHTML += '<div class="title" style="text-align:center;margin:24px 0 16px;">3rd Place (optional)</div>' + renderKOBracket([null],'third');
}
function renderKOBracket(matches, stage){
  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">';
  matches.forEach((m,i)=>{
    const t1 = m ? (m.t1 || m[0]) : null;
    const t2 = m ? (m.t2 || m[1]) : null;
    const id1 = stage + (i+1) + '_1';
    const id2 = stage + (i+1) + '_2';
    html += `<div class="match-card">
      <div style="font-weight:700;margin-bottom:8px;">${stage.toUpperCase()} ${i+1}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div style="flex:1;"><div class="team-label">${t1?t1.name:'Winner QF '+(i*2+1)}</div></div>
        <input id="${id1}" class="score-input" type="number" min="0" placeholder="0" oninput="scheduleAutoSave()">
      </div>
      <div style="text-align:center;margin:8px 0;font-size:20px;font-weight:800;">vs</div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div style="flex:1;"><div class="team-label">${t2?t2.name:'Winner QF '+(i*2+2)}</div></div>
        <input id="${id2}" class="score-input" type="number" min="0" placeholder="0" oninput="scheduleAutoSave()">
      </div>
    </div>`;
  });
  html += '</div>';
  return html;
}

/* Export functions */
function exportCSV(){
  let csv = 'Team,Played,Won,Lost,PF,PA,PD,Points\n';
  const stats = {};
  teams.forEach(t=> stats[t.id]={played:0,won:0,lost:0,pf:0,pa:0});
  fixtures.forEach(f=>{
    const s1 = Number($(`s1-${f.id}`)?.value||0);
    const s2 = Number($(`s2-${f.id}`)?.value||0);
    if(!s1&&!s2) return;
    stats[f.t1.id].played++; stats[f.t2.id].played++;
    stats[f.t1.id].pf+=s1; stats[f.t1.id].pa+=s2;
    stats[f.t2.id].pf+=s2; stats[f.t2.id].pa+=s1;
    if(s1>s2){ stats[f.t1.id].won++; } else { stats[f.t2.id].won++; }
    stats[f.t1.id].lost = stats[f.t1.id].played - stats[f.t1.id].won;
    stats[f.t2.id].lost = stats[f.t2.id].played - stats[f.t2.id].won;
  });
  teams.forEach(t=>{
    const s = stats[t.id];
    const pd = s.pf - s.pa;
    const pts = s.won*3;
    csv += `${t.name},${s.played},${s.won},${s.lost},${s.pf},${s.pa},${pd},${pts}\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='pickleball_rankings.csv'; a.click();
}
function exportSummaryPDF(){
  showToast('PDF export requires jsPDF (not included in this version)','warn');
}
function exportSchedulePDF(){
  showToast('Schedule PDF export ready in full version','success');
}
function printSchedule(){
  window.print();
}

/* ---------- Init: transform selects present on load, render controls ---------- */
document.addEventListener('DOMContentLoaded', () => {
  transformAllSelects();
  renderLoadControl();
  renderTournamentInfo();
});

</script>
</body>
</html>
