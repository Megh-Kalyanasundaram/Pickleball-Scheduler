<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pickleball Tournament Scheduler</title>
<meta name="description" content="Pickleball Tournament Scheduler — fixtures, scores, rankings, knockouts.">
<style>
  :root{
    --page-bg:#f5f6f7;
    --card-bg:#0f2435;
    --gold:#d4af37;
    --gold-hover:#e5c157;
    --muted:#9aa6b4;
    --card-text:#e7f3ff;
    --white:#ffffff;
    --radius:10px;
    --maxwidth:1240px;
    --shadow:0 8px 24px rgba(2,8,25,0.15);
    --input-height:42px;
    --toast-bg:#102238ee;
    --toast-text:#eaf4ff;
    --gap:12px;
  }
  *, *::before, *::after { box-sizing:border-box; }
  html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Arial,sans-serif;background:var(--page-bg);color:#102238;-webkit-font-smoothing:antialiased;}
  body { padding-top: 46px; padding-bottom:18px; }

  .banner{
    position:fixed;top:0;left:0;right:0;height:46px;display:flex;align-items:center;justify-content:center;
    padding:0 16px;background:var(--card-bg);color:var(--card-text);box-shadow:0 4px 16px rgba(0,0,0,0.2);
    z-index:999;font-weight:700;font-size:13px;letter-spacing:0.3px;
  }
  .banner .meta{ font-weight:600; font-size:12px; color:var(--muted); margin-left:8px; }
  .banner .autosave{ margin-left:12px; font-weight:700; color:var(--gold); display:flex; align-items:center; gap:8px; font-size:12px; }
  .autosave .dot{ width:8px;height:8px;border-radius:50%;background:transparent;border:2px solid rgba(212,175,55,0.85); display:inline-block; }
  .autosave.active .dot{ background:var(--gold); }
  /* hide autosave text by default since user did not ask for it */
  #autosaveText{ display:none; }

  .wrap{max-width:var(--maxwidth);margin:0 auto;padding:12px 16px;}
  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:var(--gap);
  }
  @media (min-width:900px){
    .grid{grid-template-columns:1fr 360px;}
  }

  .card{
    background:var(--card-bg);
    color:var(--card-text);
    border-radius:var(--radius);
    padding:16px;
    box-shadow:var(--shadow);
  }
  .title{
    font-weight:700;
    color:#eaf4ff;
    margin:0 0 12px;
    font-size:15px;
  }

  /* Unified form controls */
  input[type="text"], input[type="number"], select, .score-input {
    width:100%;
    height:var(--input-height);
    padding:0 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.08);
    background:rgba(255,255,255,0.04);
    color:var(--card-text);
    font-size:14px;
    transition:all 0.2s ease;
  }
  input::placeholder, .score-input::placeholder { color:rgba(231,243,255,0.5); }
  input:focus, select:focus, .score-input:focus {
    outline:none;
    border-color:var(--gold);
    background:rgba(255,255,255,0.08);
    box-shadow:0 0 0 3px rgba(212,175,55,0.11);
  }
  select {
    appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23e7f3ff' viewBox='0 0 16 16'%3E%3Cpath d='M8 11l-5-5h10l-5 5z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 12px center;
    color:var(--card-text);
  }
  select option{ color:#0f2435; background:#ffffff; }
  select:focus option:checked, select option:hover{ background:var(--gold-hover); color:#102238; }

  .score-input { width:76px; text-align:center; font-weight:600; }

  label{
    display:block;
    font-size:12.5px;
    color:var(--muted);
    margin-bottom:6px;
    font-weight:500;
  }
  .form-row{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
    gap:var(--gap);
    align-items:end;
  }
  .form-item{
    display:flex;
    flex-direction:column;
  }
  .checkbox-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-top:8px;
  }
  .checkbox-row input[type="checkbox"]{
    width:18px;height:18px;cursor:pointer;
  }

  .btn{
    height:var(--input-height);
    padding:0 16px;
    background:var(--gold);
    color:#102238;
    border:none;
    border-radius:8px;
    font-weight:700;
    font-size:13.5px;
    cursor:pointer;
    transition:all 0.2s;
    white-space:nowrap;
  }
  .btn:hover{ background:var(--gold-hover); transform:translateY(-1px); }
  .btn.ghost{
    background:transparent;
    color:var(--card-text);
    border:1px solid rgba(255,255,255,0.12);
  }
  .btn.small{ height:36px; font-size:12.5px; padding:0 12px; }
  .btn.block{ width:100%; }

  .action-row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:16px;
    justify-content:flex-end;
  }
  .action-row .btn{ flex:1; max-width:180px; }
  @media (min-width:480px){
    .action-row .btn{ flex:none; }
  }

  .match-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
    gap:var(--gap);
    margin-top:12px;
  }
  .match-card{
    background:rgba(255,255,255,0.025);
    border:1px solid rgba(255,255,255,0.06);
    border-radius:10px;
    padding:14px;
  }
  .match-title{
    font-size:13px;
    font-weight:700;
    color:#eaf4ff;
    margin-bottom:10px;
  }
  .team-label{
    font-weight:700;
    font-size:14px;
    color:#eaf4ff;
  }
  .team-players{
    font-size:12px;
    color:var(--muted);
    margin-top:4px;
    line-height:1.3;
  }

  .white-table{
    width:100%;
    border-collapse:collapse;
    background:var(--white);
    color:#102238;
    border-radius:8px;
    overflow:hidden;
    margin-top:12px;
    font-size:13px;
  }
  .white-table th{
    background:#f1f5f8;
    color:#667085;
    font-weight:700;
    text-align:left;
    padding:10px 8px;
  }
  .white-table td{
    padding:8px;
    border-bottom:1px solid #e6eaee;
  }

  .toast-container{
    position:fixed;
    z-index:12000;
    right:16px;
    bottom:16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:flex-end;
  }
  @media (max-width:600px){
    .toast-container{ left:50%; right:auto; transform:translateX(-50%); align-items:center; }
  }
  .toast{
    min-width:260px;
    max-width:420px;
    background:var(--toast-bg);
    color:var(--toast-text);
    border-radius:10px;
    padding:12px 16px;
    box-shadow:0 12px 32px rgba(0,0,0,0.3);
    display:flex;
    gap:12px;
    align-items:center;
    animation:toastIn 300ms ease forwards;
    position:relative;
    overflow:hidden;
  }
  .toast .accent{
    width:6px; height:100%; background:var(--gold); border-radius:4px; position:absolute; left:0; top:0;
  }
  @keyframes toastIn{ from{opacity:0;transform:translateY(10px) scale(0.98);} to{opacity:1;transform:none;} }
  @keyframes toastOut{ to{opacity:0;transform:translateY(-10px);} }
  .toast.fadeOut{ animation:toastOut 240ms ease forwards; }

  footer{
    margin-top:24px;
    text-align:center;
    font-size:12px;
    color:var(--muted);
  }
  @media (max-width:480px){
    .form-row{ grid-template-columns:1fr; }
    .match-grid{ grid-template-columns:1fr; }
    .score-input{ width:64px; }
  }

  /* overlay box helper */
  .overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:9999; background:rgba(2,6,15,0.45); }

  /* ---------- Mobile-specific: ensure Setup card fits on common phones ---------- */
  @media (max-width:600px) {
    .setup-card{
      padding:10px;
      margin-bottom:8px;
    }
    .setup-card .title{ font-size:14px; margin-bottom:8px; }
    .setup-card label{ font-size:12px; margin-bottom:4px; }
    .setup-card input[type="text"],
    .setup-card input[type="number"],
    .setup-card select,
    .setup-card .score-input { height:36px; padding:6px 10px; font-size:13px; }

    .setup-card .form-row{ gap:8px; }
    .setup-card .checkbox-row{ gap:8px; }

    .setup-card .action-row{ margin-top:10px; gap:8px; justify-content:flex-end; }
    .setup-card .action-row .btn{ max-width:48%; height:40px; font-size:13px; }
    .setup-card .action-row .btn.small{ height:36px; }

    .grid{ gap:10px; }

    .banner{ height:44px; }
    body { padding-top: 44px; }
  }

  /* NEW: override for narrow phones to keep checkboxes on a single line */
  @media (max-width:480px) {
    /* Make setup card grid two columns so two checkbox form-items sit side-by-side */
    .setup-card .form-row {
      grid-template-columns: repeat(2, 1fr);
    }
    /* Reduce vertical spacing inside setup card */
    .setup-card .form-item { margin-bottom:6px; }
    /* Ensure checkbox form-items align nicely */
    .setup-card .form-item.checkbox-row {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:10px;
      padding-top:4px;
      padding-bottom:4px;
    }
    /* Keep checkboxes and labels compact */
    .setup-card .form-item.checkbox-row label { margin:0; font-size:13px; }
    .setup-card .form-item.checkbox-row input[type="checkbox"] { margin-right:6px; }
    /* Remove the autosave text entirely as requested */
    #autosaveText { display:none !important; }
  }
</style>
<!-- jsPDF CDN (for PDF export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="banner" id="stageBanner">
    <div id="stageText">Current Stage: Round Robin</div>
    <div class="autosave" id="autosaveIndicator" title="Auto-save status" style="display:inline-flex;">
      <span class="dot" id="autosaveDot"></span>
      <span id="autosaveText" style="font-weight:700;color:var(--gold);display:inline-block">Idle</span>
    </div>
  </div>
  <div class="wrap">
    <div class="grid">
      <div>
        <!-- Setup -->
        <div class="card setup-card">
          <div class="title">Setup</div>
          <div class="form-row">
            <div class="form-item">
              <label>Game Type</label>
              <select id="gameType" onchange="onGameTypeChange()">
                <option value="doubles" selected>Doubles</option>
                <option value="singles">Singles</option>
              </select>
            </div>
            <div class="form-item">
              <label id="numLabel">No. of Teams</label>
              <input id="numTeams" type="number" min="2" value="8" oninput="updateQualifierDefaults()">
            </div>
            <div class="form-item">
              <label>No. of Courts</label>
              <input id="numCourts" type="number" min="1" value="2">
            </div>
            <div class="form-item">
              <label>Court Allocation</label>
              <select id="courtAlloc">
                <option value="roundwise" selected>Round-wise</option>
                <option value="sequential">Sequential (Simple)</option>
                <option value="balanced">Sequential (Balanced)</option>
              </select>
            </div>
            <div class="form-item">
              <label>No. of Groups</label>
              <input id="numGroups" type="number" min="1" value="2" oninput="updateQualifierDefaults()">
            </div>
            <div class="form-item">
              <label>Round-Robin Type</label>
              <select id="rrType" onchange="onRRTypeChange()">
                <option value="within" selected>Within Groups</option>
                <option value="across">Across All</option>
                <option value="club">Across Clubs</option>
              </select>
            </div>
            <div class="form-item">
              <label>Qualifiers/group</label>
              <select id="qualPerGroup" onchange="onQualPerGroupManual()">
                <option value="1">1</option>
                <option value="2" selected>2</option>
                <option value="4">4</option>
                <option value="8">8</option>
              </select>
            </div>

            <!-- checkboxes (each is a form-item) — mobile CSS makes them sit side-by-side -->
            <div class="form-item checkbox-row">
              <input id="enableQF" type="checkbox">
              <label for="enableQF" style="margin:0;cursor:pointer;">Enable Quarterfinals</label>
            </div>
            <div class="form-item checkbox-row">
              <input id="enableDUPR" type="checkbox">
              <label for="enableDUPR" style="margin:0;cursor:pointer;">Enable DUPR IDs</label>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;justify-content:flex-end;gap:8px;">
            <button id="manageClubsBtn" class="btn small ghost" style="display:none;" onclick="openClubDialog()">Manage Clubs</button>
          </div>

          <div class="action-row" style="margin-top:12px;">
            <button class="btn" id="startEntryBtn" onclick="startEntry()">Next: Enter Details</button>
            <button class="btn ghost" id="resetBtn" onclick="if(confirm('Reset everything?'))location.reload()">Reset All</button>
            <button class="btn ghost small" id="loadBtn" onclick="openLoadDialog()">Load</button>
          </div>
        </div>

        <!-- Entry -->
        <div id="entryCard" class="card" style="margin-top:12px;display:none;">
          <div class="title" id="entryTitle">Enter Teams & Players</div>
          <div id="entryInner"></div>
        </div>

        <!-- Tournament Info -->
        <div id="tournamentInfo" class="card" style="margin-top:12px;display:none;align-items:center;justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:12px;flex:1;">
            <input id="tourneyName" type="text" style="background:transparent;border:0;color:var(--card-text);font-weight:700;font-size:15px;flex:1;" placeholder="Tournament Name">
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="muted" id="tourneyMeta" style="font-size:12px;"></div>
            <button class="btn small ghost" onclick="renameActiveTournament()">Rename</button>
          </div>
        </div>

        <!-- Summary -->
        <div id="summaryCard" class="card" style="margin-top:12px;display:none;">
          <div class="title">Group Summary</div>
          <div id="summaryInner"></div>
        </div>

        <!-- Fixtures -->
        <div id="fixturesCard" class="card" style="margin-top:12px;display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div class="title">Fixtures — Enter Scores</div>
            <button class="btn small" onclick="saveActiveTournament(true)">Save</button>
          </div>
          <div id="fixturesGrid" class="match-grid"></div>
          <div style="margin-top:12px;color:var(--muted);font-size:12.5px;">Enter both scores to count a match • No ties</div>
          <div class="action-row">
            <button class="btn" onclick="generateRankings()">Generate Rankings</button>
            <button class="btn ghost" onclick="showGroupSummary()">Back</button>
          </div>
        </div>

        <!-- Rankings -->
        <div id="rankingsCard" class="card" style="margin-top:12px;display:none;">
          <div class="title">Round-Robin Rankings</div>
          <div id="rankingsInner"></div>
          <div class="action-row">
            <button class="btn" onclick="proceedToKnockouts()">Proceed to Knockouts</button>
            <button class="btn ghost" onclick="exportCSV()">Export CSV</button>
            <button class="btn ghost" onclick="exportSummaryPDF()">Export Summary (PDF)</button>
            <button class="btn ghost" onclick="exportSchedulePDF()">Export Schedule (PDF)</button>
            <button class="btn ghost" onclick="window.print()">Print</button>
            <button class="btn ghost" onclick="printSchedule()">Print Schedule</button>
          </div>
        </div>

        <!-- Knockouts -->
        <div id="knockoutsCard" class="card" style="margin-top:12px;display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div class="title">Knockout Stage</div>
            <button class="btn small" onclick="saveActiveTournament(true)">Save</button>
          </div>
          <div id="knockoutsInner"></div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div>
        <div class="card">
          <div class="title">Quick Actions</div>
          <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
            <button class="btn small" onclick="generateFixtures()">Generate Fixtures</button>
            <button class="btn small" onclick="generateRankings()">Generate Rankings</button>
            <button class="btn small ghost" onclick="exportSchedulePDF()">Export Schedule (PDF)</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="title">Notes</div>
          <div style="margin-top:8px;font-size:12.5px;color:var(--muted);line-height:1.5;">
            • Round-robin excludes knockouts<br>
            • 4 qualifiers → Semifinals<br>
            • ≥8 qualifiers + QF enabled → Quarterfinals<br>
            • Both scores required • No ties allowed
          </div>
        </div>
      </div>
    </div>

    <footer>Prompt-designed by Megh Kalyanasundaram</footer>
  </div>

  <div class="toast-container" id="toastContainer" aria-live="polite"></div>

<script>
/* ==================== FULL JAVASCRIPT (patched mobile checkboxes + hidden Idle text) ==================== */

/* ---------- App State ---------- */
let teams = [];
let fixtures = [];
let rankings = {};
let knockout = {};
let clubs = [];
let autosaveTimer = null;
const AUTOSAVE_DELAY = 800;
const TOAST_DURATION = 3500;

/* Autosave comparators */
let lastSavedSnapshotJSON = null;

/* ---------- Storage keys ---------- */
const TOURNAMENT_STORE_KEY = 'pickle_tournaments_v1';
const ACTIVE_TOURNAMENT_KEY = 'pickle_active_tournament_id';

/* ---------- DOM helper ---------- */
const $ = id => document.getElementById(id);
function updateBanner(stage){ $('stageText').textContent = `Current Stage: ${stage}`; }

/* ---------- Autosave indicator ---------- */
function setAutosaveIndicator(state, text){
  const el = $('autosaveIndicator');
  const dot = $('autosaveDot');
  const t = $('autosaveText');
  if(!el || !dot || !t) return;
  if(state === 'active'){ el.classList.add('active'); if(t) t.textContent = text || 'Saving...'; }
  else { el.classList.remove('active'); if(t) t.textContent = text || ''; }
}

/* ---------- Toast ---------- */
function showToast(message, type = 'success') {
  const container = $('toastContainer');
  if (!container) return console.log('Toast:', message);
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<div class="accent"></div><div style="flex:1;white-space:pre-wrap">${message}</div>`;
  container.appendChild(t);
  const timeout = setTimeout(() => {
    t.classList.add('fadeOut');
    setTimeout(() => t.remove(), 260);
  }, TOAST_DURATION);
  t.addEventListener('click', () => { clearTimeout(timeout); t.classList.add('fadeOut'); setTimeout(()=>t.remove(),220); });
}

/* ---------- Helpers ---------- */
function clampInt(v, min=0) { const n=Number(v); return Number.isNaN(n) ? min : Math.max(min, Math.floor(n)); }
function generateId(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6); }

/* ---------- Storage ---------- */
function readTournamentStore(){ try { const raw = localStorage.getItem(TOURNAMENT_STORE_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ console.error(e); return []; } }
function writeTournamentStore(arr){ try { localStorage.setItem(TOURNAMENT_STORE_KEY, JSON.stringify(arr)); } catch(e){ console.error(e); showToast('Unable to write to local storage.','error'); } }
function getActiveTournamentId(){ return localStorage.getItem(ACTIVE_TOURNAMENT_KEY) || null; }
function setActiveTournamentId(id){ if (id) localStorage.setItem(ACTIVE_TOURNAMENT_KEY, id); else localStorage.removeItem(ACTIVE_TOURNAMENT_KEY); renderLoadControl(); renderTournamentInfo(); }
function getActiveTournament(){ const id = getActiveTournamentId(); if (!id) return null; return readTournamentStore().find(t => t.id === id) || null; }

/* ---------- Snapshot & Restore ---------- */
function snapshotCurrentState(){
  const settings = {
    gameType: $('gameType').value,
    numTeams: Number($('numTeams').value) || 0,
    numCourts: Number($('numCourts').value) || 1,
    numGroups: Number($('numGroups').value) || 1,
    qualPerGroup: Number($('qualPerGroup').value) || 1,
    enableQF: !!$('enableQF')?.checked,
    rrType: $('rrType').value,
    courtAlloc: $('courtAlloc').value,
    clubs: clubs.slice(),
    duprEnabled: !!$('enableDUPR')?.checked
  };
  const teamsCopy = teams.map(t => ({ ...t, players: (t.players||[]).map(p => ({...p})) }));
  const fixturesCopy = fixtures.map(f => ({ id:f.id, matchNum:f.matchNum, court:f.court, group:f.group, t1Id: f.t1.id, t2Id: f.t2.id, round: f.round || null }));
  const fixtureScores = {};
  fixtures.forEach(f => {
    const s1 = $(`s1-${f.id}`) ? $(`s1-${f.id}`).value : '';
    const s2 = $(`s2-${f.id}`) ? $(`s2-${f.id}`).value : '';
    fixtureScores[f.id] = { s1, s2 };
  });
  const ko = { knockout: null, scores: {} };
  if (knockout && (knockout.qf || knockout.sf1 || knockout.final || knockout.third)){
    ko.knockout = knockout;
    document.querySelectorAll('input.score-input').forEach(inp => { if (inp.id) ko.scores[inp.id] = inp.value || ''; });
  }
  return { settings, teams: teamsCopy, fixtures: fixturesCopy, fixtureScores, ko, timestamp: Date.now() };
}

function restoreSnapshot(data){
  if (!data) return;
  const s = data.settings || {};
  $('gameType').value = s.gameType || 'doubles';
  $('numTeams').value = s.numTeams || 8;
  $('numCourts').value = s.numCourts || 2;
  $('numGroups').value = s.numGroups || 2;
  $('qualPerGroup').value = s.qualPerGroup || 2;
  if ($('enableQF')) $('enableQF').checked = !!s.enableQF;
  $('rrType').value = s.rrType || 'within';
  $('courtAlloc').value = s.courtAlloc || 'roundwise';
  clubs = (s.clubs && Array.isArray(s.clubs)) ? s.clubs.slice() : [];
  if ($('enableDUPR')) $('enableDUPR').checked = !!s.duprEnabled;

  onGameTypeChange();
  onRRTypeChange();

  teams = (data.teams || []).map(t => ({
    id: t.id, name: t.name, players: t.players || [], group: t.group || null, club: t.club || '', isBye: !!t.isBye
  }));

  const idToTeam = {}; teams.forEach(tt => idToTeam[tt.id] = tt);
  fixtures = (data.fixtures || []).map(f => ({
    id: f.id, matchNum: f.matchNum, court: f.court, group: f.group, round: f.round || null,
    t1: idToTeam[f.t1Id] || {id:f.t1Id,name:'??',players:[],club:'',isBye:false},
    t2: idToTeam[f.t2Id] || {id:f.t2Id,name:'??',players:[],club:'',isBye:false}
  }));

  showGroupSummary();
  renderFixtures();

  const scores = data.fixtureScores || {};
  Object.keys(scores).forEach(k => {
    if ($(`s1-${k}`)) $(`s1-${k}`).value = scores[k].s1 || '';
    if ($(`s2-${k}`)) $(`s2-${k}`).value = scores[k].s2 || '';
  });

  if (data.ko && data.ko.knockout){
    knockout = data.ko.knockout;
    renderAppropriateKnockoutView();
    const koScores = data.ko.scores || {};
    Object.keys(koScores).forEach(id => { if ($(id)) $(id).value = koScores[id] || ''; });
  } else knockout = {};
}

/* ---------- Tournament Save/Load ---------- */
function makeTimestampName(){
  const d = new Date();
  const p = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}h${p(d.getMinutes())}`;
}

function createTournament(name){
  const id = 't_' + Math.random().toString(36).slice(2,10);
  const tournament = { id, name: name || makeTimestampName(), createdAt: new Date().toISOString(), lastSaved: Date.now(), snapshot: snapshotCurrentState() };
  const arr = readTournamentStore();
  arr.unshift(tournament);
  writeTournamentStore(arr);
  setActiveTournamentId(id);
  renderLoadControl();
  renderTournamentInfo();
  showToast(`Tournament created: ${tournament.name}`, 'success');
  lastSavedSnapshotJSON = JSON.stringify(tournament.snapshot);
  return tournament;
}

function saveActiveTournament(manual){
  const id = getActiveTournamentId();
  if (!id) { if (manual) showToast('No active tournament. Save teams first.','warn'); return false; }
  const arr = readTournamentStore();
  const idx = arr.findIndex(t => t.id === id);
  const snap = snapshotCurrentState();
  const now = Date.now();
  try {
    if (idx >= 0){
      arr[idx].snapshot = snap;
      arr[idx].lastSaved = now;
    } else {
      arr.unshift({ id, name: makeTimestampName(), createdAt: new Date().toISOString(), lastSaved: now, snapshot: snap });
    }
    writeTournamentStore(arr);
    renderLoadControl();
    renderTournamentInfo();
    if (manual) showToast('Tournament saved','success');
    lastSavedSnapshotJSON = JSON.stringify(snap);
    setAutosaveIndicator('idle','Saved');
    return true;
  } catch(e){
    console.error(e);
    showToast('Save failed','error');
    return false;
  }
}

function scheduleAutoSave(){
  ensureTournamentExistsOnFirstSave();
  if (!getActiveTournamentId()) return;
  const snap = snapshotCurrentState();
  const json = JSON.stringify(snap);
  if (json === lastSavedSnapshotJSON) {
    setAutosaveIndicator('idle','');
    return;
  }
  if (autosaveTimer) clearTimeout(autosaveTimer);
  setAutosaveIndicator('active','Saving...');
  autosaveTimer = setTimeout(()=>{ 
    const ok = saveActiveTournament(false); 
    if (ok) { showToast('Auto-saved','success'); setAutosaveIndicator('idle',''); }
    autosaveTimer = null; 
  }, AUTOSAVE_DELAY);
}

function ensureTournamentExistsOnFirstSave(){
  if (getActiveTournamentId()) return;
  createTournament(makeTimestampName());
}

/* ---------- Load Dialog ---------- */
function renderLoadControl(){
  const arr = readTournamentStore();
  const btn = $('loadBtn');
  if (btn) btn.style.display = arr.length ? 'inline-block' : 'none';
}

function openLoadDialog(){
  const arr = readTournamentStore();
  if (!arr.length) return showToast('No saved tournaments.','warn');
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  const box = document.createElement('div');
  box.style.cssText = 'width:min(680px,95%);max-height:80%;overflow:auto;background:var(--card-bg);border-radius:10px;padding:16px;box-shadow:0 10px 40px rgba(2,6,23,0.6);';
  box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="font-weight:800;color:#eaf4ff">Load Tournament</div>
      <button id="closeLoad" class="btn ghost small">Close</button>
    </div>
    <div id="loadList" style="display:flex;flex-direction:column;gap:8px;"></div>`;
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  const list = box.querySelector('#loadList');
  arr.forEach(t => {
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;';
    div.innerHTML = `<div>
        <div style="font-weight:700;max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.name}</div>
        <div style="font-size:12px;color:var(--muted)">${new Date(t.lastSaved||t.createdAt).toLocaleString()}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn small" data-id="${t.id}">Load</button>
        <button class="btn ghost small" data-del="${t.id}">Delete</button>
      </div>`;
    list.appendChild(div);
  });

  box.addEventListener('click', e => {
    const loadBtn = e.target.closest('button[data-id]');
    const delBtn = e.target.closest('button[data-del]');
    const closeBtn = e.target.closest('#closeLoad');
    if (loadBtn){
      const id = loadBtn.dataset.id;
      const tourney = readTournamentStore().find(x=>x.id===id);
      if (!tourney) return showToast('Not found','error');
      if (!confirm(`Load "${tourney.name}"? Current data will be replaced.`)) return;
      setActiveTournamentId(id);
      restoreSnapshot(tourney.snapshot);
      renderTournamentInfo();
      overlay.remove();
      showToast(`Loaded: ${tourney.name}`,'success');
    }
    if (delBtn){
      if (!confirm('Delete permanently?')) return;
      let store = readTournamentStore();
      store = store.filter(x=>x.id !== delBtn.dataset.del);
      writeTournamentStore(store);
      overlay.remove();
      renderLoadControl();
      showToast('Deleted','success');
    }
    if (closeBtn){
      overlay.remove();
    }
  });

  overlay.addEventListener('click', (ev) => { if (ev.target === overlay) overlay.remove(); });
}

/* ---------- Tournament Info ---------- */
function renderTournamentInfo(){
  const info = $('tournamentInfo');
  const active = getActiveTournament();
  if (!info) return;
  if (!active) { info.style.display='none'; return; }
  info.style.display='flex';
  $('tourneyName').value = active.name || '';
  $('tourneyMeta').textContent = `Saved: ${new Date(active.lastSaved||active.createdAt).toLocaleString()}`;
}

function renameActiveTournament(){
  const id = getActiveTournamentId();
  if (!id) return showToast('No active tournament','warn');
  const newName = $('tourneyName').value.trim();
  if (!newName) return showToast('Enter a name','warn');
  const arr = readTournamentStore();
  const idx = arr.findIndex(x=>x.id===id);
  if (idx<0) return;
  arr[idx].name = newName;
  arr[idx].lastSaved = Date.now();
  writeTournamentStore(arr);
  renderTournamentInfo();
  showToast('Renamed','success');
}

/* ---------- UI Helpers ---------- */
function onGameTypeChange(){
  const type = $('gameType').value;
  $('numLabel').textContent = (type === 'singles') ? 'No. of Players' : 'No. of Teams';
  $('entryTitle').textContent = (type === 'singles') ? 'Enter Players' : 'Enter Teams & Players';
}

function onRRTypeChange(){
  const rr = $('rrType').value;
  $('manageClubsBtn').style.display = (rr==='club') ? 'inline-block' : 'none';
}

/* ---------- Club Management ---------- */
function openClubDialog(){
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  const box = document.createElement('div');
  box.style.cssText = 'width:min(600px,95%);background:var(--card-bg);border-radius:10px;padding:20px;max-height:90%;overflow:auto;';
  box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="margin:0;color:#eaf4ff;">Manage Clubs</h3>
      <div>
        <button id="closeClubs" class="btn ghost small">Close</button>
      </div>
    </div>
    <div style="margin-bottom:10px;">
      <div style="display:flex;gap:8px;">
        <input id="newClubInput" type="text" placeholder="New club name" style="flex:1;height:38px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--card-text);">
        <button id="addClubBtn" class="btn small">Add</button>
      </div>
    </div>
    <div id="clubList" style="display:flex;flex-direction:column;gap:8px;"></div>
    <div style="margin-top:12px;text-align:right;">
      <button id="saveCloseClubs" class="btn small">Save & Close</button>
    </div>`;
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  function renderClubs(){
    const list = box.querySelector('#clubList');
    list.innerHTML = '';
    if (!clubs.length) {
      list.innerHTML = `<div style="color:var(--muted)">No clubs yet — add one above.</div>`;
      return;
    }
    clubs.forEach((c,i) => {
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;';
      row.innerHTML = `<span style="font-weight:600;color:var(--card-text)">${c}</span>
        <div>
          <button class="btn ghost small" ${i===0?'disabled':''} data-dir="up" data-i="${i}">↑</button>
          <button class="btn ghost small" ${i===clubs.length-1?'disabled':''} data-dir="down" data-i="${i}">↓</button>
          <button class="btn ghost small" data-del="${i}">Delete</button>
        </div>`;
      list.appendChild(row);
    });
  }
  renderClubs();

  setTimeout(()=> {
    const ni = box.querySelector('#newClubInput');
    if (ni) ni.focus();
  }, 80);

  box.querySelector('#addClubBtn').onclick = () => {
    const ni = box.querySelector('#newClubInput');
    const name = ni ? ni.value.trim() : '';
    if (!name) return showToast('Enter club name','warn');
    if (clubs.includes(name)) { ni.value=''; return showToast('Already exists','warn'); }
    clubs.push(name);
    ni.value='';
    renderClubs();
    updateClubDropdowns();
    scheduleAutoSave();
    ni.focus();
  };

  box.querySelector('#saveCloseClubs').onclick = () => {
    saveActiveTournament(true);
    overlay.remove();
    showToast('Clubs saved','success');
  };

  box.querySelector('#closeClubs').onclick = () => overlay.remove();

  box.querySelector('#clubList').addEventListener('click', e => {
    const btn = e.target;
    if (!btn) return;
    if (btn.dataset.dir){
      const i = Number(btn.dataset.i);
      if (btn.dataset.dir==='up' && i>0){ [clubs[i-1],clubs[i]]=[clubs[i],clubs[i-1]]; renderClubs(); updateClubDropdowns(); }
      if (btn.dataset.dir==='down' && i<clubs.length-1){ [clubs[i],clubs[i+1]]=[clubs[i+1],clubs[i]]; renderClubs(); updateClubDropdowns(); }
    }
    if (btn.dataset.del!==undefined){
      clubs.splice(Number(btn.dataset.del),1);
      renderClubs();
      updateClubDropdowns();
    }
  });

  overlay.addEventListener('click', (ev) => { if (ev.target === overlay) overlay.remove(); });
}

function updateClubDropdowns(){
  document.querySelectorAll('select[id^="club_"]').forEach(sel => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">--</option>' + clubs.map(c=>`<option value="${c}">${c}</option>`).join('');
    if (clubs.includes(cur)) sel.value = cur;
  });
}

/* ---------- Entry ---------- */
function startEntry(){
  const n = clampInt($('numTeams').value, 2);
  if (n < 2) return showToast('Minimum 2 participants','warn');
  const type = $('gameType').value;
  const dupr = $('enableDUPR').checked;
  const clubRR = $('rrType').value === 'club';
  
  if (clubRR && clubs.length===0) { 
    openClubDialog(); 
    showToast('No clubs found — please add clubs before entering teams.', 'warn');
    return; 
  }

  let html = '';
  for(let i=1;i<=n;i++){
    const idx = i;
    html += `<div style="background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;margin-bottom:12px;">`;
    if(type==='singles'){
      html += `<label style="font-size:13px;color:var(--muted)">Player ${i}</label>
        <div style="display:flex;gap:8px;margin-top:6px;">
          <input id="pA_${i}" type="text" placeholder="Player name" style="flex:1;">
          ${dupr ? `<input id="dA_${i}" type="text" placeholder="DUPR" style="width:120px;">` : ''}
        </div>`;
      if(clubRR) html += `<div style="margin-top:8px;"><select id="club_${i}"><option value="">--</option>${clubs.map(c=>`<option>${c}</option>`).join('')}</select></div>`;
    } else {
      html += `<label style="font-size:13px;color:var(--muted)">Team ${i}</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px;">
          <div>
            <input id="pA_${i}" type="text" placeholder="Player A">
            ${dupr ? `<input id="dA_${i}" type="text" placeholder="DUPR A" style="margin-top:4px;">` : ''}
          </div>
          <div>
            <input id="pB_${i}" type="text" placeholder="Player B">
            ${dupr ? `<input id="dB_${i}" type="text" placeholder="DUPR B" style="margin-top:4px;">` : ''}
          </div>
        </div>`;
      if(clubRR) html += `<div style="margin-top:8px;"><select id="club_${i}"><option value="">--</option>${clubs.map(c=>`<option>${c}</option>`).join('')}</select></div>`;
    }
    html += `</div>`;
  }
  html += `<div class="action-row">
    <button class="btn" onclick="saveTeams();showToast('Teams saved','success');">Save Teams</button>
    <button class="btn ghost" onclick="$('entryCard').style.display='none';updateBanner('Round Robin')">Cancel</button>
  </div>`;
  $('entryInner').innerHTML = html;
  $('entryCard').style.display = 'block';
  updateBanner('Entry');

  setTimeout(()=> {
    const entry = $('entryCard');
    if (entry) entry.scrollIntoView({behavior:'smooth', block:'start'});
  }, 100);
}

function saveTeams(){
  const n = clampInt($('numTeams').value);
  const type = $('gameType').value;
  const dupr = $('enableDUPR').checked;
  const clubRR = $('rrType').value === 'club';
  teams = [];
  for(let i=1;i<=n;i++){
    const nameA = $(`pA_${i}`)?.value.trim() || (type==='singles'?`Player ${i}`:`P${i}A`);
    const nameB = type==='doubles' ? $(`pB_${i}`)?.value.trim() || `P${i}B` : '';
    const duprA = dupr ? $(`dA_${i}`)?.value.trim() : '';
    const duprB = dupr && type==='doubles' ? $(`dB_${i}`)?.value.trim() : '';
    const club = clubRR ? $(`club_${i}`)?.value : '';
    const players = type==='singles' ? [{name:nameA,dupr:duprA}] : [{name:nameA,dupr:duprA},{name:nameB,dupr:duprB}];
    teams.push({id:generateId('t'), name: type==='singles'?nameA:`Team ${i}`, players, group:null, club, isBye:false});
  }
  assignGroups();
  $('entryCard').style.display='none';
  updateBanner('Round Robin');
  ensureTournamentExistsOnFirstSave();
  saveActiveTournament(true);
}

/* ---------- Group Assignment ---------- */
function assignGroups(){
  const numGroups = clampInt($('numGroups').value,1);
  teams.forEach((t,i)=> t.group = (i % numGroups) + 1);
  showGroupSummary();
}

function showGroupSummary(){
  let html = '';
  const groups = {};
  teams.forEach(t=>{ if(!groups[t.group]) groups[t.group]=[]; groups[t.group].push(t); });
  Object.keys(groups).sort().forEach(g=>{
    html += `<div class="card" style="margin-top:12px;"><div class="title">Group ${g} (${groups[g].length} teams)</div><div style="display:grid;gap:8px;">`;
    groups[g].forEach(t=>{
      const players = t.players.map(p=>p.name + (p.dupr?` (${p.dupr})`:``)).join(' / ');
      html += `<div style="background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;">
        <div style="font-weight:600;">${t.name}${t.club?` — ${t.club}`:''}</div>
        <div style="font-size:12.5px;color:var(--muted);margin-top:4px;">${players}</div>
      </div>`;
    });
    html += `</div></div>`;
  });
  $('summaryInner').innerHTML = html || '<div style="color:var(--muted)">No teams yet.</div>';
  $('summaryCard').style.display = 'block';
  $('fixturesCard').style.display = 'none';
  $('rankingsCard').style.display = 'none';
  $('knockoutsCard').style.display = 'none';
  updateBanner('Summary');
}

/* ---------- Fixture Generation ---------- */
function generateFixtures(){
  if (teams.length===0) return showToast('Enter teams first','warn');
  fixtures = [];
  const rrType = $('rrType').value;
  const courtAlloc = $('courtAlloc').value;
  const courts = clampInt($('numCourts').value,1);

  if (rrType==='within'){
    const groups = {};
    teams.forEach(t=> { if(!groups[t.group]) groups[t.group]=[]; groups[t.group].push(t); });
    let matchNum = 1;
    Object.keys(groups).forEach(g=>{
      const groupTeams = groups[g];
      for(let i=0;i<groupTeams.length;i++){
        for(let j=i+1;j<groupTeams.length;j++){
          const t1 = groupTeams[i], t2 = groupTeams[j];
          fixtures.push({id:generateId('m'), matchNum:matchNum++, group:Number(g), t1, t2, court:null, round:null});
        }
      }
    });
  } else if (rrType==='across'){
    for(let i=0;i<teams.length;i++){
      for(let j=i+1;j<teams.length;j++){
        fixtures.push({id:generateId('m'), matchNum:fixtures.length+1, group:null, t1:teams[i], t2:teams[j], court:null, round:null});
      }
    }
  } else if (rrType==='club'){
    const clubMap = {};
    teams.forEach(t=>{ if(!clubMap[t.club]) clubMap[t.club]=[]; clubMap[t.club].push(t); });
    let matchNum = 1;
    Object.keys(clubMap).forEach(c=>{
      const clubTeams = clubMap[c];
      for(let i=0;i<clubTeams.length;i++){
        for(let j=i+1;j<clubTeams.length;j++){
          fixtures.push({id:generateId('m'), matchNum:matchNum++, group:null, t1:clubTeams[i], t2:clubTeams[j], court:null, round:null});
        }
      }
    });
  }

  if (courtAlloc==='roundwise'){
    let round = 1;
    fixtures.forEach((f,i)=>{
      f.round = round;
      f.court = (i % courts) + 1;
      if ((i+1) % courts === 0) round++;
    });
  } else {
    fixtures.forEach((f,i)=> f.court = (i % courts) + 1);
  }

  renderFixtures();
  $('fixturesCard').style.display = 'block';
  $('summaryCard').style.display = 'none';
  updateBanner('Fixtures');
  scheduleAutoSave();
}

function renderFixtures(){
  const grid = $('fixturesGrid');
  grid.innerHTML = '';
  const rounds = {};
  fixtures.forEach(f=>{ if(!rounds[f.round||'all']) rounds[f.round||'all']=[]; rounds[f.round||'all'].push(f); });
  Object.keys(rounds).sort((a,b)=>a===b?0:(a==='all'?1:b==='all'?-1:Number(a)-Number(b))).forEach(r=>{
    const roundDiv = document.createElement('div');
    roundDiv.innerHTML = `<div class="match-title">${r==='all'?'All Matches':`Round ${r}`}</div>`;
    const inner = document.createElement('div');
    inner.style.display='grid';
    inner.style.gridTemplateColumns='repeat(auto-fill,minmax(300px,1fr))';
    inner.style.gap='12px';
    rounds[r].forEach(f=>{
      const card = document.createElement('div');
      card.className='match-card';
      const players1 = f.t1.players.map(p=>p.name+(p.dupr?` (${p.dupr})`:``)).join(' / ');
      const players2 = f.t2.players.map(p=>p.name+(p.dupr?` (${p.dupr})`:``)).join(' / ');
      card.innerHTML = `
        <div style="font-size:13px;color:var(--muted);margin-bottom:8px;">Match ${f.matchNum}${f.court?` • Court ${f.court}`:''}</div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div style="flex:1;">
            <div class="team-label">${f.t1.name}</div>
            <div class="team-players">${players1}</div>
          </div>
          <input id="s1-${f.id}" class="score-input" type="number" min="0" placeholder="0" oninput="scheduleAutoSave()">
        </div>
        <div style="margin:8px 0;text-align:center;font-weight:800;font-size:18px;">vs</div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div style="flex:1;">
            <div class="team-label">${f.t2.name}</div>
            <div class="team-players">${players2}</div>
          </div>
          <input id="s2-${f.id}" class="score-input" type="number" min="0" placeholder="0" oninput="scheduleAutoSave()">
        </div>`;
      inner.appendChild(card);
    });
    roundDiv.appendChild(inner);
    grid.appendChild(roundDiv);
  });
}

/* ---------- Rankings ---------- */
function generateRankings(){
  rankings = {};
  const teamStats = {};
  teams.forEach(t=> teamStats[t.id]={t, played:0, won:0, lost:0, pf:0, pa:0, pd:0, pts:0});

  fixtures.forEach(f=>{
    const s1raw = $(`s1-${f.id}`)?.value;
    const s2raw = $(`s2-${f.id}`)?.value;
    if ((s1raw === '' || s2raw === '') || (s1raw === null && s2raw === null)) return;
    const s1 = Number(s1raw||0);
    const s2 = Number(s2raw||0);
    if (s1===0 && s2===0) return;
    if (s1===s2) { showToast('No ties allowed!','warn'); return; }
    teamStats[f.t1.id].played++;
    teamStats[f.t2.id].played++;
    teamStats[f.t1.id].pf += s1; teamStats[f.t1.id].pa += s2;
    teamStats[f.t2.id].pf += s2; teamStats[f.t2.id].pa += s1;
    if (s1>s2){
      teamStats[f.t1.id].won++; teamStats[f.t1.id].pts += 3;
      teamStats[f.t2.id].lost++;
    } else {
      teamStats[f.t2.id].won++; teamStats[f.t2.id].pts += 3;
      teamStats[f.t1.id].lost++;
    }
  });

  Object.values(teamStats).forEach(s=>{ s.pd = s.pf - s.pa; });

  const sorted = Object.values(teamStats).sort((a,b)=>{
    if (b.pts !== a.pts) return b.pts - a.pts;
    if (b.pd !== a.pd) return b.pd - a.pd;
    if (b.pf !== a.pf) return b.pf - a.pf;
    return 0;
  });

  rankings = {};
  sorted.forEach((s,i)=> rankings[s.t.id] = { pos: i+1, ...s });

  let html = '<table class="white-table"><thead><tr><th>Pos</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>PF</th><th>PA</th><th>PD</th><th>Pts</th></tr></thead><tbody>';
  sorted.forEach((s,i)=>{
    const players = s.t.players.map(p=>p.name+(p.dupr?` (${p.dupr})`:``)).join(' / ');
    html += `<tr><td>${i+1}</td><td><strong>${s.t.name}</strong><br><small style="color:#666">${players}</small></td>
      <td>${s.played}</td><td>${s.won}</td><td>${s.lost}</td><td>${s.pf}</td><td>${s.pa}</td><td>${s.pd}</td><td><strong>${s.pts}</strong></td></tr>`;
  });
  html += '</tbody></table>';
  $('rankingsInner').innerHTML = html;
  $('rankingsCard').style.display='block';
  $('fixturesCard').style.display='none';
  updateBanner('Rankings');
}

/* ---------- Knockouts ---------- */
function proceedToKnockouts(){
  const qualPer = Number($('qualPerGroup').value);
  const groups = {};
  teams.forEach(t=> { if(!groups[t.group]) groups[t.group]=[]; groups[t.group].push(t); });
  const qualifiers = [];
  Object.keys(groups).forEach(g=>{
    const ranked = teams.filter(t=>t.group===Number(g)).sort((a,b)=>{
      const sa = rankings[a.id] || {}, sb = rankings[b.id] || {};
      if ((sb.pts||0) !== (sa.pts||0)) return (sb.pts||0)-(sa.pts||0);
      if ((sb.pd||0) !== (sa.pd||0)) return (sb.pd||0)-(sa.pd||0);
      return 0;
    });
    qualifiers.push(...ranked.slice(0,qualPer));
  });

  const totalQual = qualifiers.length;
  const enableQF = $('enableQF').checked && totalQual >= 8;
  const stages = enableQF ? 8 : (totalQual >= 4 ? 4 : 2);

  knockout = { qualifiers, stages, qf:null, sf1:null, sf2:null, final:null, third:null };
  renderAppropriateKnockoutView();
  $('knockoutsCard').style.display='block';
  $('rankingsCard').style.display='none';
  updateBanner('Knockouts');
}

function renderAppropriateKnockoutView(){
  const inner = $('knockoutsInner');
  inner.innerHTML = '';
  const q = knockout.qualifiers || [];
  if (knockout.stages===8){
    const matches = [
      {t1:q[0],t2:q[7]}, {t1:q[3],t2:q[4]},
      {t1:q[1],t2:q[6]}, {t1:q[2],t2:q[5]}
    ];
    inner.innerHTML += '<div class="title" style="text-align:center;margin-bottom:16px;">Quarterfinals</div>';
    inner.innerHTML += renderKOBracket(matches,'qf');
    knockout.qf = matches;
  }
  if (knockout.stages>=4){
    inner.innerHTML += '<div class="title" style="text-align:center;margin:24px 0 16px;">Semifinals</div>';
    const sf1 = knockout.qf ? [knockout.qf[0],knockout.qf[1]] : [q[0],q[3]];
    const sf2 = knockout.qf ? [knockout.qf[2],knockout.qf[3]] : [q[1],q[2]];
    inner.innerHTML += renderKOBracket([sf1,sf2],'sf');
  }
  inner.innerHTML += '<div class="title" style="text-align:center;margin:24px 0 16px;">Final</div>';
  inner.innerHTML += renderKOBracket([null],'final');
  if (knockout.stages>=4) inner.innerHTML += '<div class="title" style="text-align:center;margin:24px 0 16px;">3rd Place (optional)</div>' + renderKOBracket([null],'third');
}

function renderKOBracket(matches, stage){
  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">';
  matches.forEach((m,i)=>{
    const t1 = m ? (m.t1 || m[0]) : null;
    const t2 = m ? (m.t2 || m[1]) : null;
    const id1 = stage + (i+1) + '_1';
    const id2 = stage + (i+1) + '_2';
    html += `<div class="match-card">
      <div style="font-weight:700;margin-bottom:8px;">${stage.toUpperCase()} ${i+1}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div style="flex:1;"><div class="team-label">${t1?t1.name:'Winner QF '+(i*2+1)}</div></div>
        <input id="${id1}" class="score-input" type="number" min="0" placeholder="0" oninput="scheduleAutoSave()">
      </div>
      <div style="text-align:center;margin:8px 0;font-size:20px;font-weight:800;">vs</div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div style="flex:1;"><div class="team-label">${t2?t2.name:'Winner QF '+(i*2+2)}</div></div>
        <input id="${id2}" class="score-input" type="number" min="0" placeholder="0" oninput="scheduleAutoSave()">
      </div>
    </div>`;
  });
  html += '</div>';
  return html;
}

/* ---------- Export Functions (CSV & PDF) ---------- */
function exportCSV(){
  let csv = 'Team,Played,Won,Lost,PF,PA,PD,Points\n';
  const stats = {};
  teams.forEach(t=> stats[t.id]={played:0,won:0,lost:0,pf:0,pa:0});
  fixtures.forEach(f=>{
    const s1 = Number($(`s1-${f.id}`)?.value||0);
    const s2 = Number($(`s2-${f.id}`)?.value||0);
    if((s1===0 && s2===0) || (s1==='' && s2==='')) return;
    stats[f.t1.id].played++; stats[f.t2.id].played++;
    stats[f.t1.id].pf+=s1; stats[f.t1.id].pa+=s2;
    stats[f.t2.id].pf+=s2; stats[f.t2.id].pa+=s1;
    if(s1>s2){ stats[f.t1.id].won++; } else { stats[f.t2.id].won++; }
    stats[f.t1.id].lost = stats[f.t1.id].played - (stats[f.t1.id].won||0);
    stats[f.t2.id].lost = stats[f.t2.id].played - (stats[f.t2.id].won||0);
  });
  teams.forEach(t=>{
    const s = stats[t.id] || {played:0,won:0,lost:0,pf:0,pa:0};
    const pd = s.pf - s.pa;
    const pts = (s.won||0)*3;
    csv += `${t.name},${s.played},${s.won||0},${s.lost||0},${s.pf||0},${s.pa||0},${pd},${pts}\n`;
  });
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='pickleball_rankings.csv'; a.click();
}

/* PDF exports using jsPDF (simple, clean summary) */
async function exportSummaryPDF(){
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
    const margin = 40;
    let y = margin;
    const lineHeight = 16;
    const title = $('tourneyName')?.value || makeTimestampName();
    doc.setFontSize(16);
    doc.text(title, margin, y);
    y += 24;
    doc.setFontSize(11);
    doc.text(`Exported: ${new Date().toLocaleString()}`, margin, y);
    y += 18;

    // Groups summary
    doc.setFontSize(13);
    doc.text('Groups', margin, y);
    y += 16;
    const groups = {};
    teams.forEach(t=>{ if(!groups[t.group]) groups[t.group]=[]; groups[t.group].push(t); });
    Object.keys(groups).sort().forEach(g=>{
      doc.setFontSize(11);
      doc.text(`Group ${g} (${groups[g].length})`, margin, y);
      y += lineHeight;
      groups[g].forEach(t=>{
        const players = t.players.map(p=>p.name + (p.dupr?` (${p.dupr})`:``)).join(' / ');
        const line = `${t.name}${t.club?` — ${t.club}`:''} : ${players}`;
        const splitted = doc.splitTextToSize(line, 520);
        doc.text(splitted, margin+10, y);
        y += (splitted.length * lineHeight);
        if (y > 740) { doc.addPage(); y = margin; }
      });
      y += 8;
      if (y > 740) { doc.addPage(); y = margin; }
    });

    if (Object.keys(rankings||{}).length>0){
      doc.addPage();
      y = margin;
      doc.setFontSize(13);
      doc.text('Rankings', margin, y);
      y += 18;
      doc.setFontSize(10);
      const header = ['Pos','Team','P','W','L','PF','PA','PD','Pts'];
      let x = margin;
      header.forEach((h, i) => { doc.text(h, x, y); x += i===1 ? 220 : 40; });
      y += lineHeight;
      const sorted = Object.values(rankings).sort((a,b)=>a.pos - b.pos);
      sorted.forEach(s=>{
        x = margin;
        doc.text(String(s.pos), x, y); x+=40;
        doc.text(s.t.name, x, y); x += 220;
        doc.text(String(s.played||0), x, y); x+=40;
        doc.text(String(s.won||0), x, y); x+=40;
        doc.text(String(s.lost||0), x, y); x+=40;
        doc.text(String(s.pf||0), x, y); x+=40;
        doc.text(String(s.pa||0), x, y); x+=40;
        doc.text(String(s.pd||0), x, y); x+=40;
        doc.text(String(s.pts||0), x, y);
        y += lineHeight;
        if (y > 740) { doc.addPage(); y = margin; }
      });
    }

    doc.save(`${title.replace(/\s+/g,'_')}_summary.pdf`);
    showToast('Summary PDF generated','success');
  } catch (e){
    console.error(e);
    showToast('PDF generation failed','error');
  }
}

function exportSchedulePDF(){
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
    const margin = 40;
    let y = margin;
    doc.setFontSize(16);
    const title = $('tourneyName')?.value || makeTimestampName();
    doc.text(`${title} — Schedule`, margin, y);
    y += 24;
    doc.setFontSize(11);
    fixtures.forEach(f=>{
      const line = `Match ${f.matchNum}${f.court?` • Court ${f.court}`:''} — ${f.t1.name} vs ${f.t2.name}`;
      const split = doc.splitTextToSize(line, 520);
      doc.text(split, margin, y);
      y += (split.length * 14);
      if (y > 740) { doc.addPage(); y = margin; }
    });
    doc.save(`${title.replace(/\s+/g,'_')}_schedule.pdf`);
    showToast('Schedule PDF generated','success');
  } catch(e){
    console.error(e);
    showToast('Schedule PDF failed','error');
  }
}

function printSchedule(){
  window.print();
}

/* ---------- Init ---------- */
renderLoadControl();
renderTournamentInfo();
setAutosaveIndicator('idle','');

function onQualPerGroupManual(){ /* placeholder */ }
function updateQualifierDefaults(){}
</script>
</body>
</html>
