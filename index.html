<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pickleball Scheduler ‚Äî Final</title>
<style>
  :root{
    --page-bg:#f5f6f7;
    --card-bg:#102238;
    --gold:#d4af37;
    --gold-hover:#e5c157;
    --muted:#8b95a3;
    --card-text:#e7f3ff;
    --white:#ffffff;
    --radius:10px;
    --maxwidth:1200px;
    --shadow:0 6px 18px rgba(15,23,42,0.12);
  }

  html,body{
    margin:0;
    height:100%;
    background:var(--page-bg);
    color:#102238;
    font-family:Inter,Segoe UI,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
  }

  /* Banner ‚Äî compact */
  .banner{
    position:fixed; top:0; left:0; right:0; height:36px;
    display:flex; align-items:center; justify-content:space-between;
    padding:0 12px; background:var(--card-bg); color:var(--card-text);
    font-size:13px; font-weight:600; z-index:999;
    box-shadow:0 3px 10px rgba(0,0,0,0.18);
  }

  .wrap{ max-width:var(--maxwidth); margin:46px auto 20px; padding:8px; }

  .grid{ display:grid; grid-template-columns:1fr 320px; gap:10px; }
  @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

  .card{
    background:var(--card-bg);
    color:var(--card-text);
    border-radius:var(--radius);
    padding:10px 12px;
    box-shadow:var(--shadow);
  }
  .title{ font-weight:700; font-size:15px; margin-bottom:6px; }
  label{ display:block; font-size:12px; color:var(--muted); margin-bottom:4px; }

  input[type="text"], input[type="number"], select {
    width:100%; box-sizing:border-box; padding:6px 8px; border-radius:6px;
    border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.04);
    color:var(--card-text); font-size:13px;
  }

  .btn{
    background:var(--gold); color:#102238; border:none;
    padding:7px 10px; font-weight:700; border-radius:6px; cursor:pointer;
    box-shadow:0 4px 10px rgba(20,18,16,0.08); font-size:13px;
  }
  .btn:hover{ background:var(--gold-hover); }
  .btn.ghost{ background:transparent; color:var(--card-text); border:1px solid rgba(255,255,255,0.08); }

  .setup-row{
    display:grid; grid-template-columns:repeat(6,minmax(90px,1fr)); gap:6px; align-items:end;
  }
  @media(max-width:900px){ .setup-row{ grid-template-columns:repeat(3,1fr); } }
  @media(max-width:600px){ .setup-row{ grid-template-columns:1fr; } }

  .muted{ color:var(--muted); font-size:12px; }
  .section-buttons{ display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end; margin-top:8px; }

  .match-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:10px; margin-top:10px; }
  .match-card{ background:rgba(255,255,255,0.03); border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.05); }
  .team-row{ display:flex; justify-content:space-between; align-items:center; margin:6px 0; }
  .team-label{ font-size:13px; font-weight:600; color:#eaf4ff; }
  .score-input{ width:72px; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.03); color:var(--card-text); text-align:center; font-size:13px; }

  .white-table{ width:100%; border-collapse:collapse; background:var(--white); color:#102238; border-radius:8px; overflow:hidden; margin-top:8px; }
  .white-table th, .white-table td{ padding:7px 8px; border-bottom:1px solid #e6eaee; font-size:12px; text-align:left; }
  .white-table thead th{ background:#f1f5f8; color:#667085; font-weight:700; }
</style>
</head>
<body>
  <div class="banner"><div id="stageBanner">Current Stage: Round Robin</div></div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: main -->
      <div>
        <!-- Setup -->
        <div class="card">
          <div class="title">Prompt-designed by Megh Kalyanasundaram</div>
          <div class="setup-row">
            <div>
              <label>Game Type</label>
              <select id="gameType" onchange="onGameTypeChange()">
                <option value="doubles" selected>Doubles</option>
                <option value="singles">Singles</option>
              </select>
            </div>

            <div>
              <label id="numLabel">No. of Teams</label>
              <input id="numTeams" type="number" min="2" value="8">
            </div>

            <div>
              <label>No. of Courts</label>
              <input id="numCourts" type="number" min="1" value="1">
            </div>

            <div>
              <label>No. of Groups</label>
              <input id="numGroups" type="number" min="1" value="1">
            </div>

            <div>
              <label>Round Robin Type</label>
              <select id="rrType">
                <option value="within" selected>Within Groups</option>
                <option value="across">Across All</option>
              </select>
            </div>

            <div>
              <label>Enable Quarterfinals</label>
              <input id="enableQF" type="checkbox">
            </div>
          </div>

          <div class="section-buttons">
            <button class="btn" onclick="startEntry()">Next: Enter Details</button>
          </div>
        </div>

        <!-- Entry card -->
        <div id="entryCard" class="card" style="margin-top:12px; display:none;">
          <div class="title" id="entryTitle">Enter Teams & Players</div>
          <div id="entryInner"></div>
        </div>

        <!-- Group summary -->
        <div id="summaryCard" class="card" style="margin-top:12px; display:none;">
          <div class="title">Group Summary</div>
          <div id="summaryInner"></div>
        </div>

        <!-- Fixtures -->
        <div id="fixturesCard" class="card" style="margin-top:12px; display:none;">
          <div class="title">Fixtures ‚Äî Enter Scores</div>
          <div id="fixturesGrid" class="match-grid"></div>
          <div class="section-buttons">
            <button class="btn" onclick="generateFinalRanking()">Generate Round-Robin Rankings</button>
            <button class="btn ghost" onclick="showSummary()">Back to Summary</button>
          </div>
          <div class="muted" style="margin-top:8px;">Enter both teams' scores for a match to be counted. Ties are not allowed.</div>
        </div>

        <!-- Rankings -->
        <div id="rankingsCard" class="card" style="margin-top:12px; display:none;">
          <div class="title">üèÜ Rankings</div>
          <div id="rankingsInner"></div>

          <div class="section-buttons" style="margin-top:10px;">
            <button id="exportCSV" class="btn ghost" onclick="exportCSV()">Export CSV</button>
            <button id="printBtn" class="btn ghost" onclick="window.print()">Print / Save as PDF</button>
            <button id="toQFBtn" class="btn" style="display:none;" onclick="prepareQuarterfinals()">Generate Quarterfinals</button>
            <button id="toSemisBtn" class="btn" style="display:none;" onclick="prepareSemifinals()">Generate Semifinals</button>
          </div>
        </div>

        <!-- Knockouts -->
        <div id="knockoutsCard" class="card" style="margin-top:12px; display:none;">
          <div class="title">Knockout Stage</div>
          <div id="knockoutsInner"></div>
        </div>
      </div>

      <!-- RIGHT: quick actions -->
      <div>
        <div class="card">
          <div class="title">Quick Actions</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
            <button class="btn" onclick="generateFixtures()">Generate Fixtures</button>
            <button class="btn" onclick="generateFinalRanking()">Generate Round-Robin Rankings</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------- State ---------- */
let teams = [];       // {id, name, players[], group}
let fixtures = [];    // {id, matchNum, court, group, t1, t2}
let rankings = {};    // groupKey -> array
let knockout = {};    // { qfs:[], sf1, sf2, final, third }
const $ = id => document.getElementById(id);

/* ---------- UI helpers ---------- */
function updateBanner(stageText){
  $('stageBanner').textContent = `Current Stage: ${stageText}`;
}
updateBanner('Round Robin');

function onGameTypeChange(){
  const type = $('gameType').value;
  $('numLabel').textContent = (type === 'singles') ? 'No. of Players' : 'No. of Teams';
  $('entryTitle').textContent = (type === 'singles') ? 'Enter Players' : 'Enter Teams & Players';
}

/* ---------- Entry flow ---------- */
function startEntry(){
  const n = Number($('numTeams').value);
  if (!n || n < 2) { alert('Please enter at least 2 participants.'); return; }
  const gameType = $('gameType').value;

  let html = '';
  for (let i=1;i<=n;i++){
    html += `<div style="margin-bottom:8px; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px;">`;
    if (gameType === 'singles'){
      html += `<label>Player ${i}</label><input id="pA_${i}" type="text" placeholder="Name (optional)">`;
    } else {
      html += `<label>Team ${i} ‚Äî Players</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">
          <input id="pA_${i}" type="text" placeholder="Player A (optional)">
          <input id="pB_${i}" type="text" placeholder="Player B (optional)">
        </div>`;
    }
    html += `</div>`;
  }
  html += `<div style="display:flex;justify-content:flex-end;gap:8px;"><button class="btn" onclick="saveTeams()">Save</button><button class="btn ghost" onclick="cancelEntry()">Cancel</button></div>`;
  $('entryInner').innerHTML = html;
  $('entryCard').style.display = 'block';
  $('fixturesCard').style.display = 'none';
  $('rankingsCard').style.display = 'none';
  $('knockoutsCard').style.display = 'none';
  updateBanner('Enter Participants');
}

function cancelEntry(){
  $('entryInner').innerHTML = '';
  $('entryCard').style.display = 'none';
  updateBanner('Round Robin');
}

function saveTeams(){
  const n = Math.max(0, Number($('numTeams').value) || 0);
  const gameType = $('gameType').value;
  teams = [];
  for (let i=1;i<=n;i++){
    const p1 = ($(`pA_${i}`)?.value || '').trim();
    const p2 = ($(`pB_${i}`)?.value || '').trim();
    const players = (gameType === 'singles') ? (p1 ? [p1] : []) : [p1, p2].filter(Boolean);
    const name = (gameType === 'singles') ? (p1 || `Player ${i}`) : (`Team ${i}`);
    teams.push({ id:i, name, players, group:null });
  }
  assignGroups();
}

/* ---------- Groups & summary ---------- */
function assignGroups(){
  const numGroups = Math.max(1, Number($('numGroups').value) || 1);
  teams.forEach((t, idx) => t.group = (idx % numGroups) + 1);
  showGroupSummary();
}

function showGroupSummary(){
  if (!teams || teams.length === 0) return alert('No participants defined.');
  const gameType = $('gameType').value;
  const numGroups = Math.max(1, Number($('numGroups').value) || 1);
  const groups = Array.from({length:numGroups}, ()=>[]);
  teams.forEach(t=> groups[t.group-1].push(t));
  let html = '<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:8px;">';
  groups.forEach((g,i)=>{
    html += `<div style="background:var(--white);color:#102238;padding:8px;border-radius:6px;"><div style="font-weight:700;margin-bottom:6px;">Group ${i+1} ‚Äî ${g.length} ${gameType==='singles'?'players':'teams'}</div><table class="white-table"><thead><tr><th>${gameType==='singles'?'Player':'Team'}</th><th>Players</th></tr></thead><tbody>`;
    if (g.length===0) html += `<tr><td colspan="2" class="muted">No entries</td></tr>`;
    else g.forEach(t=> html += `<tr><td>${t.name}</td><td>${(t.players||[]).join(' & ')}</td></tr>`);
    html += '</tbody></table></div>';
  });
  html += `</div><div style="display:flex;justify-content:flex-end;margin-top:8px;"><button class="btn" onclick="generateFixtures()">Generate Fixtures</button></div>`;
  $('summaryInner').innerHTML = html;
  $('summaryCard').style.display = 'block';
  $('entryCard').style.display = 'none';
  updateBanner('Group Summary');
}

/* ---------- Fixtures generation ---------- */
function roundRobin(list, groupKey){
  const arr = [...list];
  if (arr.length % 2 !== 0) arr.push({ id:null, name:'BYE', players:[] });
  const n = arr.length;
  const rounds = n - 1;
  let order = arr.slice();
  const out = [];
  for (let r=0;r<rounds;r++){
    for (let i=0;i<n/2;i++){
      const a = order[i], b = order[n-1-i];
      if (a.name !== 'BYE' && b.name !== 'BYE') out.push({ group: groupKey, t1: a, t2: b });
    }
    order.splice(1,0,order.pop());
  }
  return out;
}

function generateFixtures(){
  if (!teams || teams.length < 2) return alert('Please add participants first.');
  const numCourts = Math.max(1, Number($('numCourts').value) || 1);
  const rrType = $('rrType').value;

  const numGroups = Math.max(1, Number($('numGroups').value) || 1);
  teams.forEach((t, idx) => { if (!t.group) t.group = (idx % numGroups) + 1; });

  let rawFixtures = [];
  if (rrType === 'across'){
    rawFixtures = roundRobin(teams, 'all');
  } else {
    const groups = {};
    teams.forEach(t => { if (!groups[t.group]) groups[t.group] = []; groups[t.group].push(t); });
    Object.keys(groups).sort((a,b)=>a-b).forEach(gk => rawFixtures = rawFixtures.concat(roundRobin(groups[gk], Number(gk))));
  }

  fixtures = rawFixtures.map((f, idx) => ({ id: idx, matchNum: idx+1, court: (idx % numCourts) + 1, group: f.group, t1: f.t1, t2: f.t2 }));
  renderFixtures();
  updateBanner('Enter Scores');
}

function renderFixtures(){
  const grid = $('fixturesGrid'); grid.innerHTML = '';
  fixtures.forEach(m=>{
    const card = document.createElement('div'); card.className = 'match-card';
    const groupLabel = (m.group === 'all') ? 'All' : m.group;
    card.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px;color:#eaf4ff;">Match ${m.matchNum} ‚Ä¢ Court ${m.court} ‚Ä¢ Group ${groupLabel}</div>
      <div class="team-row"><div class="team-label">T${m.t1.id} ‚Äî ${m.t1.name}</div><input id="s1-${m.id}" class="score-input" type="number" min="0" placeholder="Score"></div>
      <div class="team-row"><div class="team-label">T${m.t2.id} ‚Äî ${m.t2.name}</div><input id="s2-${m.id}" class="score-input" type="number" min="0" placeholder="Score"></div>
    `;
    grid.appendChild(card);
  });
  $('fixturesCard').style.display = 'block';
  $('rankingsCard').style.display = 'none';
  $('knockoutsCard').style.display = 'none';
}

/* ---------- Ranking calculation ---------- */
function generateFinalRanking(){
  if (!fixtures || fixtures.length===0) return alert('No fixtures. Generate fixtures first.');

  // initialize stats
  const stats = {};
  teams.forEach(t => stats[t.id] = { id:t.id, name:t.name, players:t.players, group:t.group, matchesWon:0, ptsWon:0, ptsLost:0, diff:0 });

  // accumulate from fixtures ‚Äî only count matches where both scores are entered, no ties
  for (const m of fixtures){
    const s1El = $(`s1-${m.id}`), s2El = $(`s2-${m.id}`);
    if (!s1El || !s2El) continue;
    const s1Raw = s1El.value.trim(), s2Raw = s2El.value.trim();
    if (s1Raw === '' && s2Raw === '') continue; // not played
    if (s1Raw === '' || s2Raw === '') { alert(`Please enter both scores for Match ${m.matchNum}.`); return; }
    const s1 = Number(s1Raw), s2 = Number(s2Raw);
    if (Number.isNaN(s1) || Number.isNaN(s2)) { alert(`Invalid score in Match ${m.matchNum}.`); return; }
    if (s1 === s2) { alert(`Match ${m.matchNum} has a tie (${s1}). Ties are not allowed.`); return; }

    // allocate
    const winnerId = s1 > s2 ? m.t1.id : m.t2.id;
    const loserId = s1 > s2 ? m.t2.id : m.t1.id;
    const winnerScore = Math.max(s1,s2), loserScore = Math.min(s1,s2);

    if (stats[winnerId]) { stats[winnerId].matchesWon += 1; stats[winnerId].ptsWon += winnerScore; stats[winnerId].ptsLost += loserScore; }
    if (stats[loserId])  { stats[loserId].ptsWon += loserScore; stats[loserId].ptsLost += winnerScore; }
  }

  // group the stats according to rrType
  const rrType = $('rrType').value;
  const groupsMap = {};
  if (rrType === 'across') groupsMap['all'] = Object.values(stats);
  else Object.values(stats).forEach(s => { const g = s.group || 1; if (!groupsMap[g]) groupsMap[g] = []; groupsMap[g].push(s); });

  // compute diff and ranking within groups
  rankings = {};
  Object.keys(groupsMap).sort((a,b)=>{ if (a==='all') return -1; return Number(a)-Number(b); }).forEach(k=>{
    const arr = groupsMap[k];
    arr.forEach(x => x.diff = (x.ptsWon||0) - (x.ptsLost||0));
    arr.sort((a,b) => {
      if ((b.matchesWon||0) !== (a.matchesWon||0)) return (b.matchesWon||0) - (a.matchesWon||0);
      return (b.diff||0) - (a.diff||0);
    });
    arr.forEach((s,i) => s.rank = i+1);
    rankings[k] = arr;
  });

  renderRankings();
  updateBanner('Rankings');
}

function renderRankings(){
  const wrap = $('rankingsInner'); let html = '<div style="display:grid;gap:8px;">';
  Object.keys(rankings).forEach(key=>{
    const arr = rankings[key];
    const title = (key === 'all') ? 'Overall Ranking (Across All)' : `Group ${key} Ranking`;
    html += `<div style="background:var(--white);color:#102238;padding:8px;border-radius:6px;">
      <div style="font-weight:700;margin-bottom:6px;">${title}</div>
      <table class="white-table"><thead><tr><th>Rank</th><th>Team</th><th>Players</th><th>Won</th><th>Pts Won</th><th>Pts Lost</th><th>Diff</th></tr></thead><tbody>`;
    arr.forEach(r=> html += `<tr><td>${r.rank}</td><td>T${r.id} (${r.name})</td><td>${(r.players||[]).join(' & ')}</td><td>${r.matchesWon||0}</td><td>${r.ptsWon||0}</td><td>${r.ptsLost||0}</td><td>${r.diff||0}</td></tr>`);
    html += '</tbody></table></div>';
  });
  html += '</div>';
  wrap.innerHTML = html;
  $('rankingsCard').style.display = 'block';

  // enable QF/SF buttons depending on settings
  const enableQF = !!$('enableQF').checked;
  // derive 'all list' for seeding: prefer rankings['all'] else flatten groups in numeric order
  let allList = rankings['all'] || [];
  if (!allList.length) {
    // flatten groups in ascending group order, preserving ranks
    const groupKeys = Object.keys(rankings).filter(k=>k!=='all').sort((a,b)=>Number(a)-Number(b));
    groupKeys.forEach(k => allList = allList.concat(rankings[k]));
  }
  $('toQFBtn').style.display = (enableQF && allList.length >= 8) ? 'inline-block' : 'none';
  $('toSemisBtn').style.display = (!enableQF && allList.length >= 4) ? 'inline-block' : 'none';
}

/* ---------- CSV Export ---------- */
function exportCSV(){
  if (!rankings || Object.keys(rankings).length === 0) return alert('No rankings to export. Generate rankings first.');
  const rows = [['Group','Rank','ID','Name','Players','MatchesWon','PtsWon','PtsLost','Diff']];
  Object.keys(rankings).forEach(gk => {
    (rankings[gk]||[]).forEach(r => {
      rows.push([gk, r.rank, r.id, r.name, (r.players||[]).join(' & '), r.matchesWon || 0, r.ptsWon || 0, r.ptsLost || 0, r.diff || 0]);
    });
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'Rankings.csv'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
}

/* ---------- Quarterfinals / Knockout flows ---------- */

/* Helper: seize seed list (top qualifiers).
   For simplicity we take the 'flattened' top list:
   - If rankings['all'] exists, use it.
   - Else flatten groups in numeric order picking top teams overall (as they appear).
*/
function getSeedList(){
  let list = rankings['all'] || [];
  if (!list.length){
    const keys = Object.keys(rankings).filter(k=>k!=='all').sort((a,b)=>Number(a)-Number(b));
    keys.forEach(k => list = list.concat(rankings[k] || []));
  }
  return list;
}

/* Prepare Quarterfinals: top 8 seeded in common pattern */
function prepareQuarterfinals(){
  const seeds = getSeedList();
  if (seeds.length < 8) return alert('Need at least 8 qualifiers for Quarterfinals.');
  // seeding: 1v8,4v5,2v7,3v6 (commonly used)
  const top8 = seeds.slice(0,8);
  knockout.qfs = [
    { id:'QF1', a: top8[0], b: top8[7] },
    { id:'QF2', a: top8[3], b: top8[4] },
    { id:'QF3', a: top8[1], b: top8[6] },
    { id:'QF4', a: top8[2], b: top8[5] }
  ];
  renderKnockoutStage('Quarterfinals', knockout.qfs, 'proceedFromQuarterfinals()');
}

/* Called by QF proceed button ‚Äî validates scores and builds SFs */
function proceedFromQuarterfinals(){
  if (!knockout.qfs || knockout.qfs.length !== 4) return alert('Quarterfinals not configured.');
  const winners = [];
  for (let i=0;i<4;i++){
    const m = knockout.qfs[i];
    const s1 = $(`${m.id}-s1`), s2 = $(`${m.id}-s2`);
    if (!s1 || !s2) return alert(`Scores missing for ${m.id}.`);
    const v1 = Number(s1.value), v2 = Number(s2.value);
    if (isNaN(v1) || isNaN(v2)) return alert(`Enter both scores for ${m.id}.`);
    if (v1 === v2) return alert(`${m.id}: tie detected; ties not allowed.`);
    winners.push(v1 > v2 ? m.a : m.b);
  }
  // SF1: winner(QF1) vs winner(QF4); SF2: winner(QF2) vs winner(QF3)
  knockout.sf1 = { id:'SF1', a: winners[0], b: winners[3] };
  knockout.sf2 = { id:'SF2', a: winners[1], b: winners[2] };
  knockout.qfs = null; // clear qfs
  renderKnockoutStage('Semifinals', [knockout.sf1, knockout.sf2], 'proceedFromSemifinals()');
}

/* Prepare Semifinals directly from RR (no QF) */
function prepareSemifinals(){
  const seeds = getSeedList();
  if (seeds.length < 4) return alert('Need at least 4 qualifiers for Semifinals.');
  knockout.sf1 = { id:'SF1', a: seeds[0], b: seeds[3] };
  knockout.sf2 = { id:'SF2', a: seeds[1], b: seeds[2] };
  renderKnockoutStage('Semifinals', [knockout.sf1, knockout.sf2], 'proceedFromSemifinals()');
}

/* Validate SF scores and prepare Finals + 3rd place */
function proceedFromSemifinals(){
  if (!knockout.sf1 || !knockout.sf2) return alert('Semifinals not configured.');
  const winners = [], losers = [];
  for (let i=1;i<=2;i++){
    const id = `SF${i}`;
    const s1 = $(`${id}-s1`), s2 = $(`${id}-s2`);
    if (!s1 || !s2) return alert(`Scores missing for ${id}.`);
    const v1 = Number(s1.value), v2 = Number(s2.value);
    if (isNaN(v1) || isNaN(v2)) return alert(`Enter both scores for ${id}.`);
    if (v1 === v2) return alert(`${id}: tie detected; ties not allowed.`);
    if (v1 > v2){ winners.push(knockout[id.toLowerCase()].a); losers.push(knockout[id.toLowerCase()].b); }
    else { winners.push(knockout[id.toLowerCase()].b); losers.push(knockout[id.toLowerCase()].a); }
  }
  knockout.final = { id:'FINAL', a: winners[0], b: winners[1] };
  knockout.third  = { id:'THIRD', a: losers[0],  b: losers[1] };
  renderKnockoutStage('Final & 3rd Place', [knockout.final, knockout.third], null);
}

/* Finalization: validate final/third scores and show results ‚Äî called via UI button we render */
function finalizeKnockouts(){
  // final
  const f1 = $('FINAL-s1'), f2 = $('FINAL-s2');
  const t1 = $('THIRD-s1'), t2 = $('THIRD-s2');
  if (!f1 || !f2 || !t1 || !t2) return alert('Final/3rd place score fields missing.');
  const vF1 = Number(f1.value), vF2 = Number(f2.value), vT1 = Number(t1.value), vT2 = Number(t2.value);
  if ([vF1,vF2,vT1,vT2].some(v => isNaN(v))) return alert('Enter all knockout match scores.');
  if (vF1 === vF2 || vT1 === vT2) return alert('Ties are not allowed in knockouts.');

  const finalWinner = vF1 > vF2 ? knockout.final.a : knockout.final.b;
  const finalRunner  = vF1 > vF2 ? knockout.final.b : knockout.final.a;
  const thirdWinner  = vT1 > vT2 ? knockout.third.a : knockout.third.b;
  const thirdRunner  = vT1 > vT2 ? knockout.third.b : knockout.third.a;

  alert(`Knockouts complete\n\nWinner: ${finalWinner.name}\nRunner-up: ${finalRunner.name}\n3rd Place: ${thirdWinner.name}\n4th Place: ${thirdRunner.name}`);
  updateBanner('Tournament Complete');
}

/* ---------- Render Knockout Stage helper ---------- */
function renderKnockoutStage(stageName, matches, nextAction){
  const inner = $('knockoutsInner'); inner.innerHTML = '';
  matches.forEach((m, idx) => {
    const id = m.id || `${stageName.substring(0,3).toUpperCase()}${idx+1}`;
    const div = document.createElement('div'); div.className = 'match-card';
    div.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px;color:#eaf4ff;">${(stageName.includes('Quarter')? 'Quarterfinal': (stageName.includes('Semi')? 'Semifinal' : (stageName.includes('Final')? (idx===0?'Final':'3rd Place') : stageName)) )}</div>
      <div class="team-row"><div class="team-label">${m.a.name}</div><input id="${id}-s1" class="score-input" type="number" min="0" placeholder="Score"></div>
      <div class="team-row"><div class="team-label">${m.b.name}</div><input id="${id}-s2" class="score-input" type="number" min="0" placeholder="Score"></div>
    `;
    inner.appendChild(div);
  });

  // action button: either nextAction (string to evaluate) or finalize
  if (nextAction){
    const row = document.createElement('div'); row.style.marginTop='8px'; row.style.display='flex'; row.style.justifyContent='flex-end';
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Proceed';
    btn.onclick = function(){
      try {
        // evaluate the nextAction function name string safely by mapping known names
        if (nextAction === 'proceedFromQuarterfinals()') proceedFromQuarterfinals();
        else if (nextAction === 'proceedFromSemifinals()') proceedFromSemifinals();
        else if (nextAction === 'prepareFinalsFromSF()') proceedFromSemifinals();
        else if (nextAction === 'prepareSemifinalsFromQF()') proceedFromQuarterfinals();
        else { /* fallback eval (not generally recommended) */ eval(nextAction); }
      } catch (e){ console.error(e); alert('Error while proceeding.'); }
    };
    row.appendChild(btn);
    inner.appendChild(row);
  } else {
    // render finalize button for final/3rd place
    const row = document.createElement('div'); row.style.marginTop='8px'; row.style.display='flex'; row.style.justifyContent='flex-end';
    const finalizeBtn = document.createElement('button'); finalizeBtn.className='btn'; finalizeBtn.textContent='Finalize Knockouts';
    finalizeBtn.onclick = finalizeKnockouts;
    row.appendChild(finalizeBtn);
    inner.appendChild(row);
  }

  $('knockoutsCard').style.display = 'block';
  updateBanner(stageName);
}

/* ---------- Utility exposures for console debugging (if needed) ---------- */
window.startEntry = startEntry;
window.saveTeams = saveTeams;
window.generateFixtures = generateFixtures;
window.generateFinalRanking = generateFinalRanking;
window.prepareQuarterfinals = prepareQuarterfinals;
window.prepareSemifinals = prepareSemifinals;
window.proceedFromQuarterfinals = proceedFromQuarterfinals;
window.proceedFromSemifinals = proceedFromSemifinals;
window.finalizeKnockouts = finalizeKnockouts;
</script>
</body>
</html>
