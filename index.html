<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pickleball Tournament Scheduler</title>
<meta name="description" content="A compact, mobile-friendly web app to create fixtures, record scores, and generate live rankings and knockouts for pickleball tournaments ‚Äî no spreadsheets needed."/>
<style>
  :root{
    --page-bg:#f5f6f7;
    --card-bg:#0f2435;
    --gold:#d4af37;
    --gold-hover:#e5c157;
    --muted:#9aa6b4;
    --card-text:#e7f3ff;
    --white:#ffffff;
    --radius:8px;
    --maxwidth:1200px;
    --shadow:0 6px 18px rgba(2,8,25,0.12);
    --toast-bg: #102238cc;
    --toast-text: #eaf4ff;
  }

  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--page-bg);color:#102238;-webkit-font-smoothing:antialiased;}
  .banner{position:fixed;top:0;left:0;right:0;height:30px;display:flex;align-items:center;padding:0 12px;background:var(--card-bg);color:var(--card-text);box-shadow:0 4px 14px rgba(2,6,23,0.2);z-index:999;font-weight:700;font-size:13px;}
  .wrap{max-width:var(--maxwidth);margin:40px auto 18px;padding:8px;}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
  .subtitle{color:var(--muted);font-size:12px;margin-top:2px;}

  /* Grid */
  .grid{display:grid;grid-template-columns:1fr 340px;gap:12px;}
  @media (max-width:980px){ .grid{grid-template-columns:1fr;} }

  .card{background:var(--card-bg);color:var(--card-text);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow);}
  .title{font-weight:700;color:#eaf4ff;margin:0 0 6px;font-size:14px;}
  .muted{color:var(--muted);font-size:12px;}

  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px;}
  input[type="text"], input[type="number"], select {
    width:100%; box-sizing:border-box; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04);
    background: rgba(255,255,255,0.02); color:var(--card-text); font-size:13px; min-height:40px;
  }

  #rrType { font-size:12px; }
  select { background-color: rgba(255,255,255,0.1); color: var(--card-text); }
  select option { background-color: #102238; color: #e7f4ff; }
  select option:hover, select option:focus { background-color: var(--gold); color:#102238; }

  .btn { background:var(--gold); color:#102238; border:none; padding:8px 10px; font-weight:700; border-radius:8px; cursor:pointer; box-shadow:0 6px 12px rgba(20,18,16,0.06); font-size:13px; }
  .btn:hover{ background:var(--gold-hover); }
  .btn.ghost { background:transparent; color:var(--card-text); border:1px solid rgba(255,255,255,0.04); padding:7px 9px; }
  .btn.small { padding:6px 8px; font-size:12px; }
  .btn.block { display:block; width:100%; }

  /* Setup row: ensure consistent vertical alignment and symmetry */
  .setup-row{ display:grid; grid-template-columns: repeat(8, minmax(90px, 1fr)); gap:10px; align-items:start; }
  .setup-row > div { display:flex; flex-direction:column; justify-content:flex-start; }
  @media (max-width:1200px){ .setup-row{ grid-template-columns: repeat(6, minmax(90px, 1fr)); } }
  @media (max-width:1024px){ .setup-row{ grid-template-columns: repeat(4, minmax(90px, 1fr)); } }
  @media (max-width:720px){ .setup-row{ grid-template-columns: repeat(2, 1fr); gap:8px; } }
  @media (max-width:420px){ .setup-row{ grid-template-columns: 1fr; } }

  .manage-clubs-row { display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
  @media (max-width:600px) {
    .manage-clubs-row { justify-content:flex-start; }
    .manage-clubs-row .btn { display:block; width:100%; max-width:100%; text-align:left; }
  }

  .action-row { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:8px; }
  @media (max-width:420px){ .action-row{ flex-direction:column; } .action-row .btn{ width:100%; } }

  .match-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap:10px; margin-top:10px; }
  @media (max-width:600px){ .match-grid{ grid-template-columns:1fr; } }

  .match-card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:8px; padding:10px; border:1px solid rgba(255,255,255,0.04); color:var(--card-text); }
  .match-title{ font-weight:700; color:#eaf4ff; margin-bottom:6px; font-size:13px; }
  .team-label { font-size:13px; color:#eaf4ff; font-weight:700; display:flex; flex-direction:column; }
  .team-players { font-size:12px; color:var(--muted); margin-top:4px; line-height:1.1; max-width:320px; word-break:break-word; }

  .score-input{ width:72px; padding:7px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); color:var(--card-text); text-align:center; font-size:13px; min-width:60px; }

  .white-table { width:100%; border-collapse:collapse; background:var(--white); color:#102238; border-radius:8px; overflow:hidden; margin-top:10px; }
  .white-table th, .white-table td { padding:8px; border-bottom:1px solid #e6eaee; text-align:left; font-size:12px; }
  .white-table thead th { background:#f1f5f8; color:#667085; font-weight:700; }

  @media (max-width:420px){
    .wrap{ margin-top:36px; padding:8px; }
    .card{ padding:8px; border-radius:6px; }
    label{font-size:11px;}
    .banner{height:28px;font-size:12px;}
    .team-label { font-size:12px; }
    .team-players { font-size:11px; }
    .match-title { font-size:12px; }
    .score-input { width:60px; }
    input[type="text"], input[type="number"], select { padding:6px; font-size:13px; }
  }

  .toast-container {
    position: fixed;
    z-index: 12000;
    right: 18px;
    bottom: 18px;
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:flex-end;
    pointer-events: none;
    max-width: calc(100% - 36px);
  }
  @media (max-width:600px){
    .toast-container { left:50%; right:auto; transform:translateX(-50%); align-items:center; }
  }
  .toast {
    pointer-events: auto;
    min-width:220px;
    max-width:480px;
    background: var(--toast-bg);
    color: var(--toast-text);
    border-radius:8px;
    padding:10px 12px;
    box-shadow:0 10px 30px rgba(2,8,25,0.25);
    display:flex; gap:10px; align-items:center;
    opacity:0; transform: translateY(8px) scale(0.995);
    animation: toastIn 260ms ease forwards;
    position:relative;
    overflow:hidden;
  }
  .toast .accent {
    width:6px; height:100%; background:var(--gold); border-radius:4px; margin-left:-6px; margin-right:8px;
  }
  .toast.success { border-left:4px solid var(--gold); }
  .toast.warn { border-left:4px solid #f39c12; }
  .toast.error { border-left:4px solid #e04b4b; }

  @keyframes toastIn { to { opacity:1; transform: translateY(0) scale(1); } }
  @keyframes toastOut { to { opacity:0; transform: translateY(-6px) scale(0.995); } }

  .toast.fadeOut { animation: toastOut 220ms ease forwards; }

  .helper-small { font-size:11px;color:var(--muted); margin-top:4px; }
  .inline-add { margin-left:8px; padding:6px 8px; border-radius:8px; background:transparent; color:var(--card-text); border:1px solid rgba(255,255,255,0.04); cursor:pointer; font-weight:700; }
  .badge-unassigned { color:#b00020; font-weight:700; }

  /* Club dialog responsive tweaks */
  .club-box { max-width:640px; width:95%; box-sizing:border-box; display:flex; flex-direction:column; gap:8px; }
  .club-list-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
  .club-list-row .label { font-weight:700; color:#eaf4ff; flex:1; word-break:break-word; }
  .club-action-buttons { display:flex; gap:6px; }

  @media print{ .banner{display:none;} .toast-container{display:none;} }
</style>
</head>
<body>
  <div class="banner" id="stageBanner">Current Stage: Round Robin</div>

  <div class="wrap">
    <header><div></div></header>

    <div class="grid">
      <div>
        <!-- Setup -->
        <div class="card">
          <div class="title">Setup</div>

          <div class="setup-row" id="setupRow">
            <div>
              <label>Game Type</label>
              <select id="gameType" onchange="onGameTypeChange()">
                <option value="doubles" selected>Doubles</option>
                <option value="singles">Singles</option>
              </select>
            </div>

            <div>
              <label id="numLabel">No. of Teams</label>
              <input id="numTeams" type="number" min="2" value="8" oninput="updateQualifierDefaults()">
            </div>

            <div>
              <label>No. of Courts</label>
              <input id="numCourts" type="number" min="1" value="2">
            </div>

            <div>
              <label>Court allocation</label>
              <select id="courtAlloc" title="Court allocation">
                <option value="roundwise" selected>Round-wise</option>
                <option value="sequential">Sequential (Simple)</option>
                <option value="balanced">Sequential (Balanced)</option>
              </select>
              <div class="helper-small">Round-wise groups matches by round across courts. Sequential cycles matches across courts. Balanced minimizes repeated court use per team.</div>
            </div>

            <div>
              <label>No. of Groups</label>
              <input id="numGroups" type="number" min="1" value="2" oninput="updateQualifierDefaults()">
            </div>

            <div>
              <label>Round-Robin</label>
              <select id="rrType" onchange="onRRTypeChange()">
                <option value="within" selected>Within Groups</option>
                <option value="across">Across All</option>
                <option value="club">Across Clubs</option>
              </select>
              <div id="rrHelper" class="helper-small" style="display:none;">Across Clubs ‚Üí add clubs in Setup; teams select club during Entry (or use + to add inline).</div>
            </div>

            <div>
              <label>Qualifiers/group</label>
              <select id="qualPerGroup" onchange="onQualPerGroupManual()">
                <option value="1">1</option>
                <option value="2" selected>2</option>
                <option value="4">4</option>
                <option value="8">8</option>
              </select>
            </div>

            <div>
              <label>DUPR</label>
              <div style="display:flex;align-items:center;gap:8px;">
                <input id="enableDUPR" type="checkbox" /> <div class="helper-small">When checked, entry will ask for DUPR id(s) and they‚Äôll show in brackets next to player names everywhere.</div>
              </div>
            </div>
          </div>

          <!-- Manage clubs control -->
          <div class="manage-clubs-row">
            <button id="manageClubsBtn" class="btn small ghost" style="display:none;">Manage Clubs</button>
          </div>

          <div class="action-row" style="margin-top:8px;align-items:center;">
            <div style="flex:1;display:flex;gap:8px;justify-content:flex-end;">
              <button class="btn" id="startEntryBtn">Next: Enter Details</button>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn ghost" id="resetBtn">Reset</button>
              <button class="btn ghost small" id="loadBtn" style="display:none;">Load</button>
            </div>
          </div>
        </div>

        <!-- Entry -->
        <div id="entryCard" class="card" style="margin-top:12px; display:none;">
          <div class="title" id="entryTitle">Enter Teams & Players</div>
          <div id="entryInner"></div>
        </div>

        <!-- Tournament info -->
        <div id="tournamentInfo" class="card" style="margin-top:12px; display:none; align-items:center; justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="font-weight:700;color:#eaf4ff;">Tournament:</div>
            <input id="tourneyName" type="text" style="background:transparent;border:0;color:var(--card-text);font-weight:700;font-size:14px;" />
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <div class="muted" id="tourneyMeta" style="font-size:12px;"></div>
            <button class="btn small ghost" id="renameTourneyBtn" style="padding:6px 8px;">Rename</button>
          </div>
        </div>

        <!-- Summary -->
        <div id="summaryCard" class="card" style="margin-top:12px; display:none;">
          <div class="title">Group Summary</div>
          <div id="summaryInner"></div>
        </div>

        <!-- Fixtures -->
        <div id="fixturesCard" class="card" style="margin-top:12px; display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="title">Fixtures ‚Äî Enter Scores</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <button class="btn small" id="manualSaveBtn" title="Save tournament">üíæ Save</button>
            </div>
          </div>

          <div id="fixturesGrid" class="match-grid"></div>

          <div class="action-row" style="margin-top:10px;">
            <button class="btn" id="genRRBtn">Generate Round-Robin Rankings</button>
            <button class="btn ghost" id="backToSummaryBtn">Back</button>
          </div>
          <div class="muted" style="margin-top:8px;">Enter both team scores for a match to count. No ties allowed.</div>
        </div>

        <!-- Rankings -->
        <div id="rankingsCard" class="card" style="margin-top:12px; display:none;">
          <div class="title">üèÜ Round-Robin Rankings</div>
          <div id="rankingsInner"></div>

          <div class="action-row" style="margin-top:10px;">
            <button class="btn" id="proceedKO">Proceed to Knockouts</button>
            <button class="btn ghost" id="exportCSVBtn">Export Rankings (CSV)</button>
            <button class="btn ghost" id="exportPDFBtn">üìÑ Export Summary (PDF)</button>
            <button class="btn ghost" id="exportSchedulePdfBtn">üìÑ Export Schedule (PDF)</button>
            <button class="btn ghost" id="printBtn">Print / Save as PDF</button>
            <button class="btn ghost" id="printScheduleBtn">Print Schedule</button>
          </div>
        </div>

        <!-- Knockouts -->
        <div id="knockoutsCard" class="card" style="margin-top:12px; display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="title">Knockout Stage</div>
            <div><button class="btn small" id="manualSaveBtnKO">üíæ Save</button></div>
          </div>
          <div id="knockoutsInner"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <div class="title">Quick Actions</div>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
            <button class="btn small" id="quickGenFixtures">Generate Fixtures</button>
            <button class="btn small" id="quickGenRanks">Generate Round-Robin Rankings</button>
            <button class="btn small ghost" id="quickExportSchedule">Export Schedule (PDF)</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="title">Notes</div>
          <div class="muted" style="margin-top:6px;">
            ‚Ä¢ Round-robin totals exclude knockout matches.<br>
            ‚Ä¢ If total qualifiers = 4 ‚Üí Semifinals (1v4,2v3).<br>
            ‚Ä¢ If total qualifiers ‚â• 8 and QF enabled ‚Üí Quarterfinals (top 8 seeded).<br>
            ‚Ä¢ Enter both scores for a match to count; ties are not allowed.
          </div>
        </div>
      </div>
    </div>

    <footer style="margin-top:12px;font-size:12px;color:var(--muted);">Prompt-designed by Megh Kalyanasundaram</footer>
  </div>

  <div class="toast-container" id="toastContainer" aria-live="polite"></div>

<script>
/* ---------- App State ---------- */
let teams = [];
let fixtures = [];
let rankings = {};
let knockout = {};
let clubs = []; // Setup-level clubs
let autosaveTimer = null;
const AUTOSAVE_DELAY = 800; // ms
const TOAST_DURATION = 3500; // ms

/* ---------- Storage keys ---------- */
const TOURNAMENT_STORE_KEY = 'pickle_tournaments_v1';
const ACTIVE_TOURNAMENT_KEY = 'pickle_active_tournament_id';

/* ---------- DOM helper ---------- */
const $ = id => document.getElementById(id);
function updateBanner(stage){ $('stageBanner').textContent = `Current Stage: ${stage}`; }

/* ---------- Toast ---------- */
function showToast(message, type = 'success') {
  try {
    const container = $('toastContainer');
    if (!container) return console.log('Toast:', message);
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<div class="accent"></div><div style="flex:1;white-space:pre-wrap">${message}</div>`;
    container.appendChild(t);
    const timeout = setTimeout(() => {
      t.classList.add('fadeOut');
      setTimeout(() => t.remove(), 260);
    }, TOAST_DURATION);
    t.addEventListener('click', () => { clearTimeout(timeout); t.classList.add('fadeOut'); setTimeout(()=>t.remove(),220); });
  } catch (e) {
    console.warn('Toast error', e);
  }
}

/* ---------- Helpers ---------- */
function clampInt(v, min) { const n=Number(v); return Number.isNaN(n) ? min : Math.max(min, Math.floor(n)); }
function generateId(prefix='id'){ return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6); }

/* ---------- Storage ---------- */
function readTournamentStore(){ try { const raw = localStorage.getItem(TOURNAMENT_STORE_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ console.error(e); return []; } }
function writeTournamentStore(arr){ try { localStorage.setItem(TOURNAMENT_STORE_KEY, JSON.stringify(arr)); } catch(e){ console.error(e); showToast('Unable to write to local storage.','error'); } }
function getActiveTournamentId(){ return localStorage.getItem(ACTIVE_TOURNAMENT_KEY) || null; }
function setActiveTournamentId(id){ if (id) localStorage.setItem(ACTIVE_TOURNAMENT_KEY, id); else localStorage.removeItem(ACTIVE_TOURNAMENT_KEY); renderLoadControl(); renderTournamentInfo(); }
function getActiveTournament(){ const id = getActiveTournamentId(); if (!id) return null; return readTournamentStore().find(t => t.id === id) || null; }

/* ---------- Snapshot ---------- */
function snapshotCurrentState(){
  const settings = {
    gameType: $('gameType').value,
    numTeams: Number($('numTeams').value) || 0,
    numCourts: Number($('numCourts').value) || 1,
    numGroups: Number($('numGroups').value) || 1,
    qualPerGroup: Number($('qualPerGroup').value) || 1,
    enableQF: !!$('enableQF')?.checked,
    rrType: $('rrType').value,
    courtAlloc: $('courtAlloc').value,
    clubs: clubs.slice(),
    duprEnabled: !!$('enableDUPR')?.checked
  };
  // teams players store structured objects always
  const teamsCopy = teams.map(t => ({ ...t, players: (t.players||[]).map(p => (typeof p === 'string') ? {name:p, dupr:''} : {...p}) }));
  const fixturesCopy = fixtures.map(f => ({ id:f.id, matchNum:f.matchNum, court:f.court, group:f.group, t1Id: f.t1.id, t2Id: f.t2.id, round: f.round || null }));
  const fixtureScores = {};
  fixtures.forEach(f => {
    const s1 = $(`s1-${f.id}`) ? $(`s1-${f.id}`).value : '';
    const s2 = $(`s2-${f.id}`) ? $(`s2-${f.id}`).value : '';
    fixtureScores[f.id] = { s1, s2 };
  });
  const ko = { knockout: null, scores: {} };
  if (knockout && (knockout.qf || knockout.sf1 || knockout.final || knockout.third)){
    ko.knockout = knockout;
    document.querySelectorAll('input.score-input').forEach(inp => { if (inp.id) ko.scores[inp.id] = inp.value || ''; });
  }
  return { settings, teams: teamsCopy, fixtures: fixturesCopy, fixtureScores, ko, timestamp: Date.now() };
}

/* ---------- Restore ---------- */
function restoreSnapshot(data){
  if (!data) return;
  const s = data.settings || {};
  if (s.gameType) $('gameType').value = s.gameType;
  if (s.numTeams) $('numTeams').value = s.numTeams;
  if (s.numCourts) $('numCourts').value = s.numCourts;
  if (s.numGroups) $('numGroups').value = s.numGroups;
  if (s.qualPerGroup) $('qualPerGroup').value = s.qualPerGroup;
  if (typeof s.enableQF !== 'undefined' && $('enableQF')) $('enableQF').checked = !!s.enableQF;
  if (s.rrType) $('rrType').value = s.rrType;
  if (s.courtAlloc) $('courtAlloc').value = s.courtAlloc;
  clubs = (s.clubs && Array.isArray(s.clubs)) ? s.clubs.slice() : [];
  if (typeof s.duprEnabled !== 'undefined') $('enableDUPR').checked = !!s.duprEnabled;

  onGameTypeChange();
  onRRTypeChange();

  // Teams: support either legacy string arrays or structured objects
  teams = (data.teams || []).map(t => {
    const playersRaw = t.players || [];
    const players = playersRaw.map(p => {
      if (!p) return { name: '', dupr: '' };
      if (typeof p === 'string') return { name: p, dupr: '' };
      return { name: p.name || '', dupr: p.dupr || '' };
    });
    return { id: t.id, name: t.name, players, group: t.group || null, club: t.club || '', isBye: !!t.isBye };
  });
  const idToTeam = {}; teams.forEach(tt => idToTeam[tt.id] = tt);

  fixtures = (data.fixtures || []).map((f, idx) => ({
    id: f.id, matchNum: f.matchNum, court: f.court, group: f.group, round: f.round || null,
    t1: idToTeam[f.t1Id] || { id: f.t1Id, name: 'Unknown', players:[], club:'', isBye: false },
    t2: idToTeam[f.t2Id] || { id: f.t2Id, name: 'Unknown', players:[], club:'', isBye: false }
  }));

  showGroupSummary();
  renderFixtures();

  const scores = data.fixtureScores || {};
  Object.keys(scores).forEach(k => {
    if ($(`s1-${k}`)) $(`s1-${k}`).value = scores[k].s1 || '';
    if ($(`s2-${k}`)) $(`s2-${k}`).value = scores[k].s2 || '';
  });

  if (data.ko && data.ko.knockout){
    knockout = data.ko.knockout;
    renderAppropriateKnockoutView();
    const koScores = data.ko.scores || {};
    Object.keys(koScores).forEach(id => { if ($(id)) $(id).value = koScores[id] || ''; });
  } else {
    knockout = {};
  }
}

/* ---------- Create / Save ---------- */
function makeTimestampName(){
  const d = new Date();
  const p = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}:${p(d.getMinutes())}`;
}
function createTournament(name){
  const id = 't_' + Math.random().toString(36).slice(2,10);
  const createdAt = new Date().toISOString();
  const tournament = { id, name: name || makeTimestampName(), createdAt, lastSaved: Date.now(), snapshot: snapshotCurrentState() };
  const arr = readTournamentStore();
  arr.unshift(tournament);
  writeTournamentStore(arr);
  setActiveTournamentId(id);
  renderLoadControl();
  renderTournamentInfo();
  showToast(`Tournament created: ${tournament.name}`, 'success');
  return tournament;
}
function saveActiveTournament(manual){
  const id = getActiveTournamentId();
  if (!id) { if (manual) showToast('No active tournament. Save teams first to create one.','warn'); return false; }
  const arr = readTournamentStore();
  const idx = arr.findIndex(t => t.id === id);
  const snap = snapshotCurrentState();
  const now = Date.now();
  if (idx >= 0){
    arr[idx].snapshot = snap;
    arr[idx].lastSaved = now;
  } else {
    arr.unshift({ id, name: makeTimestampName(), createdAt: new Date().toISOString(), lastSaved: now, snapshot: snap });
  }
  writeTournamentStore(arr);
  renderLoadControl();
  renderTournamentInfo();
  if (manual) showToast('Tournament saved ‚úì','success');
  return true;
}

/* ---------- Autosave scheduling ---------- */
function scheduleAutoSave(){
  ensureTournamentExistsOnFirstSave();
  if (!getActiveTournamentId()) return;
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=>{ saveActiveTournament(false); autosaveTimer = null; showToast('Auto-saved','success'); }, AUTOSAVE_DELAY);
}

/* ---------- Load control ---------- */
function renderLoadControl(){
  const arr = readTournamentStore();
  const loadBtn = $('loadBtn');
  if (!loadBtn) return;
  loadBtn.style.display = arr.length ? 'inline-block' : 'none';
}
function openLoadDialog(){
  const arr = readTournamentStore();
  if (!arr.length) return showToast('No saved tournaments.','warn');
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.left = 0; overlay.style.top = 0; overlay.style.right = 0; overlay.style.bottom = 0;
  overlay.style.background = 'rgba(2,6,15,0.45)';
  overlay.style.display = 'flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex=9999;

  const box = document.createElement('div');
  box.style.width='min(680px,95%)';
  box.style.maxHeight='80%';
  box.style.overflow='auto';
  box.style.background='var(--card-bg)';
  box.style.borderRadius='10px';
  box.style.padding='12px';
  box.style.boxShadow='0 10px 40px rgba(2,6,23,0.6)';
  box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div style="font-weight:800;color:#eaf4ff">Load Tournament</div>
      <button id="closeLoadDialog" class="btn ghost small">Close</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;" id="loadList"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px;"><button id="loadCancel" class="btn ghost small">Cancel</button></div>`;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  const loadList = box.querySelector('#loadList');
  arr.forEach(t=>{
    const div = document.createElement('div');
    div.style.display='flex';
    div.style.justifyContent='space-between';
    div.style.alignItems='center';
    div.style.padding='8px';
    div.style.borderRadius='8px';
    div.style.background='rgba(255,255,255,0.02)';
    div.innerHTML = `<div style="display:flex;flex-direction:column;">
        <div style="font-weight:700;max-width:460px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.name}</div>
        <div class="muted" style="font-size:12px;">Saved: ${new Date(t.lastSaved||t.createdAt).toLocaleString()}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn small" data-id="${t.id}">Load</button>
        <button class="btn ghost small" data-del="${t.id}">Delete</button>
      </div>`;
    loadList.appendChild(div);
  });

  box.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.onclick = () => {
      const id = btn.getAttribute('data-id');
      const t = readTournamentStore().find(x => x.id === id);
      if (!t) { showToast('Tournament not found.','error'); return; }
      if (!confirm(`Load tournament "${t.name}"? This will replace current unsaved data.`)) return;
      setActiveTournamentId(id);
      restoreSnapshot(t.snapshot);
      renderTournamentInfo();
      document.body.removeChild(overlay);
      showToast(`Loaded tournament "${t.name}"`,'success');
    };
  });

  box.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = () => {
      const id = btn.getAttribute('data-del');
      if (!confirm('Delete this saved tournament? This cannot be undone.')) return;
      let store = readTournamentStore();
      store = store.filter(x => x.id !== id);
      writeTournamentStore(store);
      document.body.removeChild(overlay);
      renderLoadControl();
      showToast('Deleted saved tournament.','success');
    };
  });

  box.querySelector('#closeLoadDialog').onclick = () => document.body.removeChild(overlay);
  box.querySelector('#loadCancel').onclick = () => document.body.removeChild(overlay);
}

/* ---------- Tournament info ---------- */
function renderTournamentInfo(){
  const tinfo = $('tournamentInfo');
  const active = getActiveTournament();
  if (!tinfo) return;
  if (!active) { tinfo.style.display = 'none'; return; }
  tinfo.style.display = 'flex';
  $('tourneyName').value = active.name || active.id;
  $('tourneyMeta').textContent = `Created: ${new Date(active.createdAt).toLocaleString()} ‚Ä¢ Saved: ${new Date(active.lastSaved||active.createdAt).toLocaleString()}`;
}
function renameActiveTournament(){
  const id = getActiveTournamentId();
  if (!id) return showToast('No active tournament.','warn');
  const arr = readTournamentStore();
  const idx = arr.findIndex(x => x.id === id);
  if (idx < 0) return showToast('Active tournament not found.','error');
  const newName = $('tourneyName').value.trim();
  if (!newName) return showToast('Name cannot be empty.','warn');
  arr[idx].name = newName;
  arr[idx].lastSaved = Date.now();
  writeTournamentStore(arr);
  renderLoadControl();
  renderTournamentInfo();
  showToast('Tournament renamed.','success');
}

/* ---------- Ensure tournament exists on first save ---------- */
function ensureTournamentExistsOnFirstSave(){
  if (getActiveTournamentId()) return;
  const created = createTournament(makeTimestampName());
  saveActiveTournament(true);
}

/* ---------- Entry & Teams ---------- */
function onGameTypeChange(){
  const type = $('gameType').value;
  $('numLabel').textContent = (type === 'singles') ? 'No. of Players' : 'No. of Teams';
  $('entryTitle').textContent = (type === 'singles') ? 'Enter Players' : 'Enter Teams & Players';
}

/* ---------- Robust RR-type UI toggling ---------- */
function onRRTypeChange(){
  const rr = $('rrType').value;
  const manageBtn = $('manageClubsBtn');
  const helper = $('rrHelper');
  if (rr === 'club'){
    if (manageBtn) manageBtn.style.display = 'inline-block';
    if (helper) helper.style.display = 'block';
  } else {
    if (manageBtn) manageBtn.style.display = 'none';
    if (helper) helper.style.display = 'none';
  }
}

/* ---------- Club dialog ---------- */
function openClubDialog(){
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.left = 0; overlay.style.top = 0; overlay.style.right = 0; overlay.style.bottom = 0;
  overlay.style.background = 'rgba(2,6,15,0.45)';
  overlay.style.display = 'flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center'; overlay.style.zIndex=9999;

  const box = document.createElement('div');
  box.className = 'club-box';
  box.style.background='var(--card-bg)';
  box.style.borderRadius='10px';
  box.style.padding='12px';
  box.style.boxShadow='0 10px 40px rgba(2,6,23,0.6)';

  box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:800;color:#eaf4ff">Manage Clubs</div>
      <div style="display:flex;gap:8px;">
        <button id="closeClubDialog" class="btn ghost small">Close</button>
        <button id="saveClubsBtn" class="btn small">Save</button>
      </div>
    </div>
    <div class="muted">Add club names once here. During Entry you'll select a club from a dropdown for each team. On mobile, use the Add button to open the input.</div>
    <div id="clubList" style="display:flex;flex-direction:column;gap:8px;"></div>
    <div style="display:flex;gap:8px;margin-top:6px;">
      <button id="addClubTrigger" class="btn small ghost">+ Add</button>
      <div id="addClubArea" style="flex:1;display:none;gap:6px;align-items:center;"></div>
    </div>`;

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  const clubList = box.querySelector('#clubList');
  const addTrigger = box.querySelector('#addClubTrigger');
  const addArea = box.querySelector('#addClubArea');

  function renderClubList(){
    clubList.innerHTML = '';
    (clubs || []).forEach((c, idx) => {
      const row = document.createElement('div');
      row.className = 'club-list-row';
      const left = document.createElement('div');
      left.className = 'label';
      left.textContent = c;
      const right = document.createElement('div');
      right.className = 'club-action-buttons';
      right.innerHTML = `<button class="btn ghost small" data-del="${idx}">Delete</button><button class="btn small" data-up="${idx}">‚Üë</button><button class="btn small" data-down="${idx}">‚Üì</button>`;
      row.appendChild(left);
      row.appendChild(right);
      clubList.appendChild(row);
    });
  }
  renderClubList();

  addTrigger.onclick = () => {
    addTrigger.style.display = 'none';
    addArea.style.display = 'flex';
    addArea.innerHTML = `<input id="tempNewClub" type="text" placeholder="New club name" style="flex:1;min-width:120px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--card-text)"/>
                         <button id="confirmAddClub" class="btn small">Add</button>
                         <button id="cancelAddClub" class="btn ghost small">Cancel</button>`;
    const temp = addArea.querySelector('#tempNewClub');
    setTimeout(()=> temp.focus(),120);

    addArea.querySelector('#confirmAddClub').onclick = () => {
      const v = (temp.value||'').trim();
      if (!v) return showToast('Enter club name to add.','warn');
      if (clubs.includes(v)) return showToast('Club already exists.','warn');
      clubs.push(v);
      renderClubList();
      updateClubDropdowns();
      ensureTournamentExistsOnFirstSave();
      saveActiveTournament(false);
      showToast(`Added club: ${v}`,'success');
      addArea.innerHTML = '';
      addArea.style.display = 'none';
      addTrigger.style.display = 'inline-block';
    };
    addArea.querySelector('#cancelAddClub').onclick = () => {
      addArea.innerHTML = '';
      addArea.style.display = 'none';
      addTrigger.style.display = 'inline-block';
    };
    temp.addEventListener('keyup',(ev)=>{ if (ev.key === 'Enter') addArea.querySelector('#confirmAddClub').click(); });
  };

  box.addEventListener('click', (ev) => {
    const del = ev.target.closest('button[data-del]');
    const up = ev.target.closest('button[data-up]');
    const down = ev.target.closest('button[data-down]');
    if (del){
      const i = Number(del.getAttribute('data-del'));
      clubs.splice(i,1);
      renderClubList();
      updateClubDropdowns();
    } else if (up){
      const i = Number(up.getAttribute('data-up'));
      if (i<=0) return;
      const tmp = clubs[i-1]; clubs[i-1]=clubs[i]; clubs[i]=tmp;
      renderClubList();
      updateClubDropdowns();
    } else if (down){
      const i = Number(down.getAttribute('data-down'));
      if (i>=clubs.length-1) return;
      const tmp = clubs[i+1]; clubs[i+1]=clubs[i]; clubs[i]=tmp;
      renderClubList();
      updateClubDropdowns();
    }
  });

  box.querySelector('#saveClubsBtn').onclick = () => {
    ensureTournamentExistsOnFirstSave();
    saveActiveTournament(true);
    showToast('Clubs saved.','success');
    document.body.removeChild(overlay);
  };
  box.querySelector('#closeClubDialog').onclick = () => document.body.removeChild(overlay);
}

/* ---------- update club selects present in entry form ---------- */
function updateClubDropdowns(){
  const selects = document.querySelectorAll('#entryInner select[id^="club_"]');
  selects.forEach(sel => {
    const current = sel.value;
    while (sel.firstChild) sel.removeChild(sel.firstChild);
    const blank = document.createElement('option');
    blank.value = '';
    blank.innerText = '--';
    sel.appendChild(blank);
    (clubs || []).forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.innerText = c;
      sel.appendChild(opt);
    });
    if (current && Array.from(sel.options).find(o => o.value === current)) sel.value = current;
  });
}

/* ---------- Entry UI ---------- */
When checked, entry will ask for DUPR id(s) and they‚Äôll show in brackets next to player names everywhere.
function cancelEntry(){ $('entryInner').innerHTML=''; $('entryCard').style.display='none'; updateBanner('Round Robin'); }

function addClubInline(index){
  const name = (prompt('Enter new club name:') || '').trim();
  if (!name) return showToast('No name entered.','warn');
  if (clubs.includes(name)) {
    showToast('Club already exists.','warn');
    const sel = $(`club_${index}`); if (sel) sel.value = name;
    return;
  }
  clubs.push(name);
  updateClubDropdowns();
  const sel = $(`club_${index}`); if (sel) sel.value = name;
  ensureTournamentExistsOnFirstSave();
  saveActiveTournament(true);
  showToast(`Added club: ${name}`,'success');
}

/* ---------- Save Teams (store players as objects) ---------- */
function saveTeams(){
  const n = clampInt($('numTeams').value, 0);
  const type = $('gameType').value;
  const rrType = $('rrType').value;
  const isClubRR = rrType === 'club';
  const duprEnabled = !!$('enableDUPR').checked;

  teams = [];
  for (let i=1;i<=n;i++){
    const v1 = ($(`pA_${i}`)?.value || '').trim();
    const v2 = ($(`pB_${i}`)?.value || '').trim();
    const d1 = duprEnabled ? (($(`dA_${i}`)?.value || '').trim()) : '';
    const d2 = duprEnabled ? (($(`dB_${i}`)?.value || '').trim()) : '';
    const clubVal = isClubRR ? (($(`club_${i}`)?.value || '').trim()) : '';
    const defaultName = (type === 'singles') ? `Player ${i}` : `Team ${i}`;

    if (type === 'singles'){
      const playerName = v1 || defaultName;
      const players = [{ name: playerName, dupr: d1 || '' }];
      const teamId = generateId('team');
      teams.push({ id: teamId, name: playerName, players, group:null, club: clubVal || '', isBye: false });
    } else {
      const players = [];
      if (v1) players.push({ name: v1, dupr: d1 || '' }); else players.push({ name: `P${i}A`, dupr: d1 || ''});
      if (v2) players.push({ name: v2, dupr: d2 || '' }); else players.push({ name: `P${i}B`, dupr: d2 || ''});
      const teamName = (players[0].name && players[1].name) ? `Team ${i}` : `Team ${i}`;
      const teamId = generateId('team');
      teams.push({ id: teamId, name: teamName, players, group:null, club: clubVal || '', isBye: false });
    }
  }
  assignGroups();
}

/* ---------- Groups & summary ---------- */
function updateQualifierDefaults(){
  const numTeams = clampInt($('numTeams').value, 0);
  const numGroups = clampInt($('numGroups').value, 1);
  const qualSelect = $('qualPerGroup');
  if (numGroups === 1) {
    if (numTeams >= 8) qualSelect.value = '8';
    else if (numTeams >= 4) qualSelect.value = '4';
    else if (numTeams >= 2) qualSelect.value = '2';
    else qualSelect.value = '1';
  } else {
    qualSelect.value = '2';
  }
  const totalQuals = Number(qualSelect.value) * numGroups;
  if (totalQuals >= 8) $('enableQF') && ($('enableQF').disabled = false);
  else { $('enableQF') && ($('enableQF').disabled = true); if ($('enableQF')) $('enableQF').checked = false; }
}
function onQualPerGroupManual(){
  const numGroups = clampInt($('numGroups').value, 1);
  const totalQuals = Number($('qualPerGroup').value) * numGroups;
  $('enableQF') && ($('enableQF').disabled = !(totalQuals >= 8));
  if ($('enableQF') && $('enableQF').disabled) $('enableQF').checked = false;
}
function assignGroups(){
  const numGroups = Math.max(1, Number($('numGroups').value) || 1);
  teams.forEach((t, idx) => t.group = (idx % numGroups) + 1);
  showGroupSummary();
}

/* ---------- Helper to display player with DUPR ---------- */
function playerDisplay(p){
  if (!p) return '';
  if (typeof p === 'string') return p; // legacy
  const name = (p.name || '').trim();
  const dupr = (p.dupr || '').trim();
  return dupr ? `${escapeHtml(name)} [${escapeHtml(dupr)}]` : escapeHtml(name);
}

/* ---------- Show Group Summary ---------- */
function showGroupSummary(){
  if (!teams || teams.length === 0) return showToast('No participants defined.','warn');
  const rrType = $('rrType').value;
  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;">';

  if (rrType === 'club'){
    const clubsOrder = (clubs && clubs.length) ? clubs.slice() : Array.from(new Set(teams.map(t=> t.club || 'Unassigned')));
    const byClub = {};
    teams.forEach(t => { const c = (t.club || 'Unassigned') || 'Unassigned'; if (!byClub[c]) byClub[c]=[]; byClub[c].push(t); });

    clubsOrder.forEach((clubName) => {
      const g = byClub[clubName] || [];
      html += `<div style="background:var(--white);color:#102238;padding:8px;border-radius:8px;"><div style="font-weight:700;margin-bottom:6px;">${escapeHtml(clubName)} ‚Äî ${g.length} entries</div><table class="white-table"><thead><tr><th>Name</th><th>Players</th></tr></thead><tbody>`;
      if (g.length===0) html += `<tr><td colspan="2" class="muted">No entries</td></tr>`;
      else g.forEach(t => {
        const players = (t.players||[]).map(playerDisplay).join(' & ');
        html += `<tr><td>${escapeHtml(t.name)}</td><td>${players}</td></tr>`;
      });
      html += '</tbody></table></div>';
    });
  } else {
    const numGroups = Math.max(1, Number($('numGroups').value) || 1);
    const groups = Array.from({length:numGroups}, ()=>[]);
    teams.forEach(t=> groups[t.group-1].push(t));
    groups.forEach((g,i)=>{
      html += `<div style="background:var(--white);color:#102238;padding:8px;border-radius:8px;"><div style="font-weight:700;margin-bottom:6px;">Group ${i+1} ‚Äî ${g.length} entries</div><table class="white-table"><thead><tr><th>Name</th><th>Players</th><th>Club</th></tr></thead><tbody>`;
      if (g.length===0) html += `<tr><td colspan="3" class="muted">No entries</td></tr>`;
      else g.forEach(t => {
        const players = (t.players||[]).map(playerDisplay).join(' & ');
        const clubCell = t.club ? escapeHtml(t.club) : `<span class="badge-unassigned">Unassigned</span>`;
        html += `<tr><td>${escapeHtml(t.name)}</td><td>${players}</td><td>${clubCell}</td></tr>`;
      });
      html += '</tbody></table></div>';
    });
  }

  html += '</div>';
  html += `<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;"><button class="btn" id="genFixturesBtn">Generate Fixtures</button><button class="btn ghost" id="editEntryBtn">Edit</button></div>`;
  $('summaryInner').innerHTML = html;
  $('summaryCard').style.display = 'block';
  $('entryCard').style.display = 'none';
  updateBanner('Group Summary');

  $('genFixturesBtn').onclick = generateFixtures;
  $('editEntryBtn').onclick = startEntry;
}

/* ---------- Fixtures ---------- */
function generateFixtures(){
  if (!teams || teams.length < 2) return showToast('Please add participants first.','warn');
  const numCourts = Math.max(1, Number($('numCourts').value) || 1);
  const rrType = $('rrType').value;
  const courtAlloc = $('courtAlloc').value;
  const numGroups = Math.max(1, Number($('numGroups').value) || 1);
  teams.forEach((t,idx) => { if (!t.group) t.group = (idx % numGroups) + 1; });

  let rawFixtures = [];
  if (rrType === 'across'){
    rawFixtures = roundRobin(teams, 'all');
  } else if (rrType === 'club'){
    rawFixtures = crossClubRoundRobin(teams);
  } else {
    const groups = {};
    teams.forEach(t => { if (!groups[t.group]) groups[t.group] = []; groups[t.group].push(t); });
    Object.keys(groups).sort((a,b)=>a-b).forEach(gk => rawFixtures = rawFixtures.concat(roundRobin(groups[gk], Number(gk))));
  }

  fixtures = rawFixtures.map((f, idx) => ({
    id: idx,
    matchNum: idx+1,
    court: null,
    group: f.group,
    t1: f.t1,
    t2: f.t2,
    round: f.round || null
  }));

  if (courtAlloc === 'roundwise') {
    const byRound = {};
    fixtures.forEach(f => {
      const r = f.round || 1;
      if (!byRound[r]) byRound[r] = [];
      byRound[r].push(f);
    });
    Object.keys(byRound).forEach(rk => {
      const arr = byRound[rk];
      arr.forEach((m, idx) => {
        m.court = (idx % numCourts) + 1;
      });
    });
  } else if (courtAlloc === 'balanced') {
    fixtures = allocateCourtsBalanced(fixtures, numCourts);
  } else { // sequential simple
    fixtures.forEach((m, idx) => m.court = (idx % numCourts) + 1);
  }

  renderFixtures();
}

/* standard round-robin generator (within a list) */
function roundRobin(list, groupKey){
  const arr = [...list];
  if (arr.length % 2 !== 0) arr.push({ id: generateId('bye'), name:'BYE', players:[], isBye:true });
  const n = arr.length;
  const rounds = n-1;
  let order = arr.slice();
  const out = [];
  for (let r=0;r<rounds;r++){
    for (let i=0;i<n/2;i++){
      const a = order[i], b = order[n-1-i];
      if (a.name !== 'BYE' && b.name !== 'BYE') out.push({ group: groupKey, t1: a, t2: b, round: r+1 });
    }
    order.splice(1,0,order.pop());
  }
  return out;
}

/* Cross-club generator (minimizes overlaps) */
function crossClubRoundRobin(list){
  const byClub = {};
  list.forEach(t => {
    const c = (t.club || 'Unassigned').trim() || 'Unassigned';
    if (!byClub[c]) byClub[c] = [];
    byClub[c].push(t);
  });

  const clubNames = Object.keys(byClub);
  const matches = [];

  for (let i = 0; i < clubNames.length; i++){
    for (let j = i+1; j < clubNames.length; j++){
      const ca = clubNames[i], cb = clubNames[j];
      const aTeams = byClub[ca].slice();
      const bTeams = byClub[cb].slice();

      const m = Math.max(aTeams.length, bTeams.length);
      const makeBye = () => ({ id: generateId('bye'), name:'BYE', players:[], club:'', isBye:true });

      while (aTeams.length < m) aTeams.push(makeBye());
      while (bTeams.length < m) bTeams.push(makeBye());

      for (let aa = 0; aa < aTeams.length; aa++){
        for (let bb = 0; bb < bTeams.length; bb++){
          const a = aTeams[aa], b = bTeams[bb];
          if (!a || !b) continue;
          if ((a.isBye) && (b.isBye)) continue;
          matches.push({ group: 'club', t1: a, t2: b });
        }
      }
    }
  }

  if (matches.length === 0) return [];

  const deg = {};
  matches.forEach(m => {
    if (!m.t1 || !m.t2) return;
    deg[m.t1.id] = (deg[m.t1.id] || 0) + 1;
    deg[m.t2.id] = (deg[m.t2.id] || 0) + 1;
  });

  matches.sort((A,B) => {
    const aScore = (deg[A.t1.id]||0) + (deg[A.t2.id]||0);
    const bScore = (deg[B.t1.id]||0) + (deg[B.t2.id]||0);
    if (bScore !== aScore) return bScore - aScore;
    return String(A.t1.id).localeCompare(String(B.t1.id)) || String(A.t2.id).localeCompare(String(B.t2.id));
  });

  const rounds = [];
  for (const m of matches){
    const id1 = m.t1.id, id2 = m.t2.id;
    let placed = false;
    for (let r = 0; r < rounds.length; r++){
      const rs = rounds[r];
      if (!rs.teamSet.has(id1) && !rs.teamSet.has(id2)){
        rs.matches.push(m);
        rs.teamSet.add(id1);
        rs.teamSet.add(id2);
        placed = true;
        break;
      }
    }
    if (!placed){
      const rs = { teamSet: new Set([id1, id2]), matches: [m] };
      rounds.push(rs);
    }
  }

  const out = [];
  let matchNum = 1;
  for (let r = 0; r < rounds.length; r++){
    const roundMatches = rounds[r].matches;
    for (let k = 0; k < roundMatches.length; k++){
      const mm = roundMatches[k];
      out.push({ group: 'club', t1: mm.t1, t2: mm.t2, round: r+1, _allocOrder: matchNum++ });
    }
  }

  out.sort((a,b) => {
    if ((a.round||0) !== (b.round||0)) return (a.round||0) - (b.round||0);
    return (a._allocOrder||0) - (b._allocOrder||0);
  });

  out.forEach(o => { delete o._allocOrder; });

  return out;
}

/* Balanced court allocator (improved): minimize repeated-court advantage */
function allocateCourtsBalanced(fixtures, numCourts) {
  const out = fixtures.map(f => ({ ...f }));
  const teamCourtCounts = {};
  const lastCourtForTeam = {};
  const globalCourtCounts = new Array(numCourts).fill(0);

  function ensureTeam(t){
    if (!t || !t.id) return;
    if (!teamCourtCounts[t.id]) {
      teamCourtCounts[t.id] = new Array(numCourts).fill(0);
      lastCourtForTeam[t.id] = null;
    }
  }
  out.forEach(f => { ensureTeam(f.t1); ensureTeam(f.t2); });

  // sort by round then matchNum to keep round grouping
  out.sort((a,b) => {
    const ra = (typeof a.round === 'number') ? a.round : 9999;
    const rb = (typeof b.round === 'number') ? b.round : 9999;
    if (ra !== rb) return ra - rb;
    return (a.matchNum || 0) - (b.matchNum || 0);
  });

  // rotation base to avoid consistently favoring court 1
  let rotationIndex = 0;

  for (const f of out) {
    const tid1 = f.t1 && f.t1.id ? f.t1.id : null;
    const tid2 = f.t2 && f.t2.id ? f.t2.id : null;
    if (tid1) ensureTeam(f.t1);
    if (tid2) ensureTeam(f.t2);

    let bestCourt = 0;
    let bestScore = Infinity;

    for (let c = 0; c < numCourts; c++) {
      const c1 = tid1 ? teamCourtCounts[tid1][c] : 0;
      const c2 = tid2 ? teamCourtCounts[tid2][c] : 0;
      const lastPenalty = ((tid1 && lastCourtForTeam[tid1] === c) || (tid2 && lastCourtForTeam[tid2] === c)) ? 4 : 0;
      // combine local usage + small global usage factor to prefer spreading
      const score = (c1 + c2) + lastPenalty + (globalCourtCounts[c] * 0.12);
      // prefer courts rotated to avoid always picking lower index
      const rotatedScore = score + ((c + rotationIndex) % numCourts) * 0.001;
      if (rotatedScore < bestScore || (Math.abs(rotatedScore - bestScore) < 1e-6 && c < bestCourt)) {
        bestScore = rotatedScore;
        bestCourt = c;
      }
    }

    // assign
    f.court = bestCourt + 1;
    rotationIndex = (rotationIndex + 1) % numCourts;

    if (tid1) { teamCourtCounts[tid1][bestCourt] += 1; lastCourtForTeam[tid1] = bestCourt; }
    if (tid2) { teamCourtCounts[tid2][bestCourt] += 1; lastCourtForTeam[tid2] = bestCourt; }
    globalCourtCounts[bestCourt] += 1;
  }

  // restore original order by matchNum
  out.sort((a,b) => (a.matchNum||0) - (b.matchNum||0));
  return out;
}

/* ---------- Render Fixtures ---------- */
function renderFixtures(){
  const grid = $('fixturesGrid'); grid.innerHTML = '';
  fixtures.forEach(m=>{
    const card = document.createElement('div'); card.className='match-card';
    const groupLabel = (m.group === 'all' ? 'All' : (m.group === 'club' ? 'Across Clubs' : m.group));
    const roundLabel = m.round ? `Round ${m.round} ‚Ä¢ ` : '';
    const p1 = (m.t1 && m.t1.players && m.t1.players.length) ? (m.t1.players.map(playerDisplay).join(' & ')) : '';
    const p2 = (m.t2 && m.t2.players && m.t2.players.length) ? (m.t2.players.map(playerDisplay).join(' & ')) : '';
    card.innerHTML = `
      <div class="match-title">${roundLabel}Match ${m.matchNum} ‚Ä¢ Court ${m.court} ‚Ä¢ Group ${groupLabel}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(m.t1.name)}${m.t1.club ? ' ‚Ä¢ ' + escapeHtml(m.t1.club) : ''}<div class="team-players">${p1}</div></div>
        <div style="margin-left:12px"><input id="s1-${m.id}" class="score-input" type="number" min="0" placeholder="Score"></div>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(m.t2.name)}${m.t2.club ? ' ‚Ä¢ ' + escapeHtml(m.t2.club) : ''}<div class="team-players">${p2}</div></div>
        <div style="margin-left:12px"><input id="s2-${m.id}" class="score-input" type="number" min="0" placeholder="Score"></div>
      </div>
    `;
    grid.appendChild(card);
  });

  fixtures.forEach(m=>{
    const s1 = $(`s1-${m.id}`), s2 = $(`s2-${m.id}`);
    if (s1) s1.addEventListener('input', scheduleAutoSave);
    if (s2) s2.addEventListener('input', scheduleAutoSave);
  });

  const active = getActiveTournament();
  if (active && active.snapshot && active.snapshot.fixtureScores){
    const scores = active.snapshot.fixtureScores || {};
    Object.keys(scores).forEach(k=>{
      if ($(`s1-${k}`)) $(`s1-${k}`).value = scores[k].s1 || '';
      if ($(`s2-${k}`)) $(`s2-${k}`).value = scores[k].s2 || '';
    });
  }

  $('fixturesCard').style.display = 'block';
  $('rankingsCard').style.display = 'none';
  updateBanner('Round Robin ‚Äî Enter Scores');
}

/* manual save button */
function manualSaveFromUI(){ saveActiveTournament(true); }

/* ---------- Rankings ---------- */
function generateRoundRobinRankings(){
  if (!fixtures || fixtures.length === 0) return showToast('No fixtures. Generate fixtures first.','warn');

  const stats = {};
  teams.forEach(t => stats[t.id] = { id:t.id, name:t.name, players:t.players, group:t.group, club:t.club || '', matchesWon:0, ptsWon:0, ptsLost:0, diff:0, isBye: !!t.isBye });

  for (const m of fixtures){
    const s1El = $(`s1-${m.id}`), s2El = $(`s2-${m.id}`);
    if (!s1El || !s2El) continue;
    const s1 = s1El.value === '' ? NaN : Number(s1El.value);
    const s2 = s2El.value === '' ? NaN : Number(s2El.value);
    if (Number.isNaN(s1) && Number.isNaN(s2)) continue;
    if (Number.isNaN(s1) || Number.isNaN(s2)) { showToast(`Match ${m.matchNum}: both scores required.`,'warn'); return; }
    if (s1 === s2) { showToast(`Match ${m.matchNum}: tie detected (${s1}).`,'warn'); return; }

    const winnerId = s1 > s2 ? m.t1.id : m.t2.id;
    const loserId = s1 > s2 ? m.t2.id : m.t1.id;
    const winnerScore = Math.max(s1, s2), loserScore = Math.min(s1, s2);

    if (stats[winnerId]) { stats[winnerId].matchesWon += 1; stats[winnerId].ptsWon += winnerScore; stats[winnerId].ptsLost += loserScore; }
    if (stats[loserId])  { stats[loserId].ptsWon += loserScore; stats[loserId].ptsLost += winnerScore; }
  }

  const rrType = $('rrType').value;
  const groupsMap = {};
  if (rrType === 'across' || rrType === 'club') groupsMap['all'] = Object.values(stats);
  else Object.values(stats).forEach(s => { const g = s.group || 1; if (!groupsMap[g]) groupsMap[g]=[]; groupsMap[g].push(s); });

  rankings = {};
  Object.keys(groupsMap).sort((a,b)=> (a==='all'? -1 : Number(a)-Number(b)) ).forEach(k=>{
    const arr = groupsMap[k];
    arr.forEach(x=> x.diff = (x.ptsWon||0) - (x.ptsLost||0));
    arr.sort((a,b)=>{
      if ((b.matchesWon||0) !== (a.matchesWon||0)) return (b.matchesWon||0) - (a.matchesWon||0);
      return (b.diff||0) - (a.diff||0);
    });
    arr.forEach((s,i)=> s.rank = i+1);
    rankings[k] = arr;
  });

  saveActiveTournament(false);
  renderRankings();
  updateBanner('Round-Robin Rankings');
}
function renderRankings(){
  const wrap = $('rankingsInner'); let html = '<div style="display:grid;gap:10px;">';
  Object.keys(rankings).forEach(key=>{
    const arr = rankings[key];
    const title = (key === 'all') ? 'Overall Ranking (Across All)' : `Group ${key} Ranking`;
    html += `<div style="background:var(--white);color:#102238;padding:8px;border-radius:8px;"><div style="font-weight:700;margin-bottom:6px;">${title}</div>`;
    html += `<div class="table-wrap"><table class="white-table"><thead><tr><th>Rank</th><th>Name</th><th>Players</th><th>Club</th><th>Won</th><th>Pts Won</th><th>Pts Lost</th><th>Diff</th></tr></thead><tbody>`;
    arr.forEach(r => {
      const players = (r.players||[]).map(playerDisplay).join(' & ');
      html += `<tr><td>${r.rank}</td><td>${escapeHtml(r.name)}</td><td>${players}</td><td>${escapeHtml(r.club||'')}</td><td>${r.matchesWon||0}</td><td>${r.ptsWon||0}</td><td>${r.ptsLost||0}</td><td>${r.diff||0}</td></tr>`;
    });
    html += `</tbody></table></div></div>`;
  });
  html += '</div>';
  wrap.innerHTML = html;
  $('rankingsCard').style.display = 'block';
}

/* ---------- Qualifiers & Knockouts ---------- */
function getQualifiedList(){
  const per = Math.max(1, Number($('qualPerGroup').value) || 1);
  const rrType = $('rrType').value;
  const numGroups = Math.max(1, Number($('numGroups').value) || 1);
  const qualified = [];
  if (rrType === 'across' || rrType === 'club'){
    const all = rankings['all'] || [];
    const totalWanted = per * numGroups;
    for (let i=0;i<Math.min(all.length, totalWanted); i++) qualified.push(all[i]);
  } else {
    const groupKeys = Object.keys(rankings).filter(k=>k!=='all').sort((a,b)=>Number(a)-Number(b));
    groupKeys.forEach(k=>{
      const arr = rankings[k] || [];
      for (let i=0;i<Math.min(arr.length, per); i++) qualified.push(arr[i]);
    });
  }
  return qualified;
}

function proceedToKnockouts(){
  if (!rankings || Object.keys(rankings).length === 0) return showToast('Generate Round-Robin Rankings first.','warn');
  const qualified = getQualifiedList();
  if (qualified.length < 2) return showToast('Not enough qualifiers.','warn');
  const totalQuals = qualified.length;
  const qfEnabled = $('enableQF') && $('enableQF').checked;
  if (totalQuals >= 8 && qfEnabled) prepareQuarterfinals(qualified);
  else if (totalQuals >= 4) prepareSemifinalsDirect(qualified);
  else if (totalQuals === 2) prepareDirectFinal(qualified);
  else return showToast('Insufficient qualifiers for knockouts (need at least 4 for semis or 8 for quarters).','warn');
}

/* Quarterfinals & SF & Finals */
function prepareQuarterfinals(qualifiedList){
  const prepared = qualifiedList.slice(0,8);
  const top8 = prepared;
  const qfPairs = [
    { id:'QF1', a: top8[0], b: top8[7] },
    { id:'QF2', a: top8[3], b: top8[4] },
    { id:'QF3', a: top8[1], b: top8[6] },
    { id:'QF4', a: top8[2], b: top8[5] }
  ];
  knockout = { qf: qfPairs, sf1:null, sf2:null, final:null, third:null };
  renderQuarterfinals();
  updateBanner('Quarterfinals');
}
function renderQuarterfinals(){
  const inner = $('knockoutsInner'); inner.innerHTML = '';
  knockout.qf.forEach((m,idx)=>{
    const div = document.createElement('div'); div.style.marginBottom='8px';
    const matchCard = document.createElement('div'); matchCard.className = 'match-card'; matchCard.style.padding='10px';
    const aName = (m.a && m.a.name) || 'Unknown';
    const bName = (m.b && m.b.name) || 'Unknown';
    const aPlayers = (m.a && m.a.players && m.a.players.length) ? (m.a.players.map(playerDisplay).join(' & ')) : '';
    const bPlayers = (m.b && m.b.players && m.b.players.length) ? (m.b.players.map(playerDisplay).join(' & ')) : '';
    matchCard.innerHTML = `<div style="font-weight:700;color:#eaf4ff;margin-bottom:6px;">Quarterfinal ${idx+1}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(aName)}<div class="team-players">${aPlayers}</div></div>
        <input id="${m.id}-s1" class="score-input" type="number" min="0" placeholder="Score">
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(bName)}<div class="team-players">${bPlayers}</div></div>
        <input id="${m.id}-s2" class="score-input" type="number" min="0" placeholder="Score">
      </div>`;
    div.appendChild(matchCard);
    inner.appendChild(div);
  });

  const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='flex-end'; row.style.marginTop='8px';
  const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Proceed to Semifinals';
  btn.onclick = processQuarterfinals;
  row.appendChild(btn);
  inner.appendChild(row);

  document.querySelectorAll('#knockoutsInner input.score-input').forEach(inp => inp.addEventListener('input', scheduleAutoSave));
  $('knockoutsCard').style.display = 'block';
}
function processQuarterfinals(){
  if (!knockout || !knockout.qf) return showToast('Quarterfinals not configured.','warn');
  const winners = [];
  for (const m of knockout.qf){
    const s1El = $(`${m.id}-s1`), s2El = $(`${m.id}-s2`);
    if (!s1El || !s2El) return showToast(`${m.id}: score fields missing.`,'warn');
    const v1 = s1El.value === '' ? NaN : Number(s1El.value);
    const v2 = s2El.value === '' ? NaN : Number(s2El.value);
    if (Number.isNaN(v1) || Number.isNaN(v2)) return showToast(`${m.id}: enter both scores.`,'warn');
    if (v1 === v2) return showToast(`${m.id}: ties not allowed.`,'warn');
    winners.push( v1 > v2 ? m.a : m.b );
  }
  knockout.sf1 = { id:'SF1', name:'Semifinal 1', a: winners[0], b: winners[3] };
  knockout.sf2 = { id:'SF2', name:'Semifinal 2', a: winners[1], b: winners[2] };
  knockout.qf = null;
  renderSemifinals();
  updateBanner('Semifinals');
}

function prepareSemifinalsDirect(qualifiedList){
  const top = qualifiedList.slice(0,4);
  knockout = {
    qf: null,
    sf1: { id:'SF1', name:'Semifinal 1', a: top[0], b: top[3] },
    sf2: { id:'SF2', name:'Semifinal 2', a: top[1], b: top[2] },
    final: null,
    third: null
  };
  renderSemifinals();
  updateBanner('Semifinals');
}
function renderSemifinals(){
  const inner = $('knockoutsInner'); inner.innerHTML = '';
  [knockout.sf1, knockout.sf2].forEach(match=>{
    const div = document.createElement('div'); div.style.marginBottom='8px';
    const matchCard = document.createElement('div'); matchCard.className = 'match-card'; matchCard.style.padding='10px';
    const aName = (match.a && match.a.name) || 'Unknown';
    const bName = (match.b && match.b.name) || 'Unknown';
    const aPlayers = (match.a && match.a.players && match.a.players.length) ? (match.a.players.map(playerDisplay).join(' & ')) : '';
    const bPlayers = (match.b && match.b.players && match.b.players.length) ? (match.b.players.map(playerDisplay).join(' & ')) : '';
    matchCard.innerHTML = `<div style="font-weight:700;color:#eaf4ff;margin-bottom:6px;">${escapeHtml(match.name)}</div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(aName)}<div class="team-players">${aPlayers}</div></div>
        <input id="${match.id}-s1" class="score-input" type="number" min="0" placeholder="Score">
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(bName)}<div class="team-players">${bPlayers}</div></div>
        <input id="${match.id}-s2" class="score-input" type="number" min="0" placeholder="Score">
      </div>`;
    div.appendChild(matchCard);
    inner.appendChild(div);
  });

  const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='flex-end'; row.style.marginTop='8px';
  const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Proceed to Final & 3rd Place';
  btn.onclick = processSemifinals;
  row.appendChild(btn);
  inner.appendChild(row);

  document.querySelectorAll('#knockoutsInner input.score-input').forEach(inp => inp.addEventListener('input', scheduleAutoSave));
  $('knockoutsCard').style.display = 'block';
}
function processSemifinals(){
  const matches = [knockout.sf1, knockout.sf2];
  const winners = [], losers = [];
  for (const m of matches){
    const s1El = $(`${m.id}-s1`), s2El = $(`${m.id}-s2`);
    if (!s1El || !s2El) return showToast(`${m.id}: score fields missing.`,'warn');
    const v1 = s1El.value === '' ? NaN : Number(s1El.value);
    const v2 = s2El.value === '' ? NaN : Number(s2El.value);
    if (Number.isNaN(v1) || Number.isNaN(v2)) return showToast(`${m.id}: enter both scores.`,'warn');
    if (v1 === v2) return showToast(`${m.id}: ties not allowed.`,'warn');
    if (v1 > v2) { winners.push(m.a); losers.push(m.b); } else { winners.push(m.b); losers.push(m.a); }
  }
  knockout.final = { id:'FINAL', name:'Final', a: winners[0], b: winners[1] };
  knockout.third  = { id:'THIRD', name:'3rd Place', a: losers[0], b: losers[1] };
  renderFinals();
  updateBanner('Finals & 3rd Place');
}

function prepareDirectFinal(qualified){
  const a = qualified[0], b = qualified[1];
  knockout = { qf:null, sf1:null, sf2:null, final: { id:'FINAL', name:'Final', a, b }, third: null };
  renderFinals();
  updateBanner('Final');
}

function renderFinals(){
  const inner = $('knockoutsInner'); inner.innerHTML = '';

  if (knockout.final){
    const f = knockout.final;
    const divF = document.createElement('div'); divF.style.marginBottom='8px';
    const matchCardF = document.createElement('div'); matchCardF.className='match-card'; matchCardF.style.padding='10px';
    const aName = (f.a && f.a.name) || 'Unknown';
    const bName = (f.b && f.b.name) || 'Unknown';
    const aPlayers = (f.a && f.a.players && f.a.players.length) ? (f.a.players.map(playerDisplay).join(' & ')) : '';
    const bPlayers = (f.b && f.b.players && f.b.players.length) ? (f.b.players.map(playerDisplay).join(' & ')) : '';
    matchCardF.innerHTML = `<div style="font-weight:700;color:#eaf4ff;margin-bottom:6px;">Final</div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(aName)}<div class="team-players">${aPlayers}</div></div>
        <input id="FINAL-s1" class="score-input" type="number" min="0" placeholder="Score">
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(bName)}<div class="team-players">${bPlayers}</div></div>
        <input id="FINAL-s2" class="score-input" type="number" min="0" placeholder="Score">
      </div>`;
    divF.appendChild(matchCardF);
    inner.appendChild(divF);
  }

  if (knockout.third){
    const t = knockout.third;
    const divT = document.createElement('div'); divT.style.marginBottom='8px';
    const matchCardT = document.createElement('div'); matchCardT.className='match-card'; matchCardT.style.padding='10px';
    const aName = (t.a && t.a.name) || 'Unknown';
    const bName = (t.b && t.b.name) || 'Unknown';
    const aPlayers = (t.a && t.a.players && t.a.players.length) ? (t.a.players.map(playerDisplay).join(' & ')) : '';
    const bPlayers = (t.b && t.b.players && t.b.players.length) ? (t.b.players.map(playerDisplay).join(' & ')) : '';
    matchCardT.innerHTML = `<div style="font-weight:700;color:#eaf4ff;margin-bottom:6px;">3rd Place</div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(aName)}<div class="team-players">${aPlayers}</div></div>
        <input id="THIRD-s1" class="score-input" type="number" min="0" placeholder="Score">
      </div>
      <div style="height:8px"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="team-label">${escapeHtml(bName)}<div class="team-players">${bPlayers}</div></div>
        <input id="THIRD-s2" class="score-input" type="number" min="0" placeholder="Score">
      </div>`;
    divT.appendChild(matchCardT);
    inner.appendChild(divT);
  }

  const doneRow = document.createElement('div'); doneRow.style.display='flex'; doneRow.style.justifyContent='flex-end'; doneRow.style.marginTop='8px';
  const doneBtn = document.createElement('button'); doneBtn.className='btn'; doneBtn.textContent='Finalize Knockouts';
  doneBtn.onclick = finalizeKnockouts;
  doneRow.appendChild(doneBtn);
  inner.appendChild(doneRow);

  document.querySelectorAll('#knockoutsInner input.score-input').forEach(inp => inp.addEventListener('input', scheduleAutoSave));
  $('knockoutsCard').style.display = 'block';
}

function finalizeKnockouts(){
  if (knockout.final){
    const f1 = $('FINAL-s1'), f2 = $('FINAL-s2');
    if (!f1 || !f2) return showToast('Enter final scores.','warn');
    const v1 = f1.value === '' ? NaN : Number(f1.value);
    const v2 = f2.value === '' ? NaN : Number(f2.value);
    if (Number.isNaN(v1) || Number.isNaN(v2)) return showToast('Enter both final scores.','warn');
    if (v1 === v2) return showToast('Final: tie not allowed.','warn');
    const finalWinner = v1 > v2 ? knockout.final.a : knockout.final.b;
    const finalRunner  = v1 > v2 ? knockout.final.b : knockout.final.a;
    let thirdWinner = null, thirdRunner = null;
    if (knockout.third){
      const t1 = $('THIRD-s1'), t2 = $('THIRD-s2');
      if (!t1 || !t2) return showToast('Enter 3rd place scores.','warn');
      const tv1 = t1.value === '' ? NaN : Number(t1.value);
      const tv2 = t2.value === '' ? NaN : Number(t2.value);
      if (Number.isNaN(tv1) || Number.isNaN(tv2)) return showToast('Enter both 3rd place scores.','warn');
      if (tv1 === tv2) return showToast('3rd place: tie not allowed.','warn');
      thirdWinner = tv1 > tv2 ? knockout.third.a : knockout.third.b;
      thirdRunner = tv1 > tv2 ? knockout.third.b : knockout.third.a;
    }
    let msg = `Winner: ${finalWinner.isBye ? 'BYE' : finalWinner.name}\nRunner-up: ${finalRunner.isBye ? 'BYE' : finalRunner.name}`;
    if (thirdWinner) msg += `\n3rd Place: ${thirdWinner.name}\n4th Place: ${thirdRunner.name}`;
    showToast(msg.replace(/\n/g,' ‚Ä¢ '),'success');
    updateBanner('Tournament Complete');
    saveActiveTournament(false);
  } else {
    showToast('No final configured.','warn');
  }
}

/* ---------- Export CSV ---------- */
function exportRankingsCSV(){
  if (!rankings || Object.keys(rankings).length === 0) return showToast('No rankings to export.','warn');
  const rows=[['Group','Rank','ID','Name','Players','Club','MatchesWon','PtsWon','PtsLost','Diff']];
  Object.keys(rankings).forEach(g=>{
    (rankings[g]||[]).forEach(r=>{
      const playersCSV = (r.players||[]).map(p => (typeof p === 'string') ? p : `${p.name}${p.dupr ? ' ['+p.dupr+']' : ''}`).join(' & ');
      rows.push([g,String(r.rank||''),String(r.id||''),String(r.name||'').replace(/"/g,'""'),String(playersCSV).replace(/"/g,'""'),String(r.club||'').replace(/"/g,'""'),String(r.matchesWon||0),String(r.ptsWon||0),String(r.ptsLost||0),String(r.diff||0)]);
    });
  });
  const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'rankings.csv'; document.body.appendChild(a);
  a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
  showToast('Rankings CSV exported.','success');
}

/* ---------- Export Summary & Schedule ---------- */
function buildTeamsHtml(){
  let teamsHtml = '<h3>Teams / Players</h3><table style="width:100%;border-collapse:collapse;">';
  teamsHtml += '<thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Team/Player</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Players</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Group</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Club</th></tr></thead><tbody>';
  teams.forEach(t => {
    const players = (t.players||[]).map(p => (typeof p === 'string') ? p : `${escapeHtml(p.name)}${p.dupr ? ' ['+escapeHtml(p.dupr)+']' : ''}`).join(', ');
    teamsHtml += `<tr><td style="padding:6px;border-bottom:1px solid #eee;">${escapeHtml(t.name)}</td><td style="padding:6px;border-bottom:1px solid #eee;">${players}</td><td style="padding:6px;border-bottom:1px solid #eee;">${t.group||''}</td><td style="padding:6px;border-bottom:1px solid #eee;">${escapeHtml(t.club||'')}</td></tr>`;
  });
  teamsHtml += '</tbody></table>';
  return teamsHtml;
}

function buildRankHtml(){
  let rankHtml = '<h3>Rankings</h3>';
  if (!rankings || Object.keys(rankings).length===0) rankHtml += '<div>No rankings generated.</div>';
  else {
    Object.keys(rankings).forEach(k=>{
      rankHtml += `<h4>${k==='all' ? 'Overall' : 'Group ' + k}</h4>`;
      rankHtml += `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Rank</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Name</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Club</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Won</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Pts Won</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Pts Lost</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Diff</th></tr></thead><tbody>`;
      (rankings[k]||[]).forEach(r=>{
        const players = (r.players||[]).map(p => (typeof p === 'string') ? p : `${escapeHtml(p.name)}${p.dupr ? ' ['+escapeHtml(p.dupr)+']' : ''}`).join(' & ');
        rankHtml += `<tr><td style="padding:6px;border-bottom:1px solid #eee;">${r.rank}</td><td style="padding:6px;border-bottom:1px solid #eee;">${escapeHtml(r.name)}<div style="font-size:11px;color:#667085">${players}</div></td><td style="padding:6px;border-bottom:1px solid #eee;">${escapeHtml(r.club||'')}</td><td style="padding:6px;border-bottom:1px solid #eee;">${r.matchesWon||0}</td><td style="padding:6px;border-bottom:1px solid #eee;">${r.ptsWon||0}</td><td style="padding:6px;border-bottom:1px solid #eee;">${r.ptsLost||0}</td><td style="padding:6px;border-bottom:1px solid #eee;">${r.diff||0}</td></tr>`;
      });
      rankHtml += '</tbody></table>';
    });
  }
  return rankHtml;
}

function buildScheduleHtml(){
  let scheduleHtml = '<h3>Match Schedule</h3>';
  if (!fixtures || fixtures.length === 0) scheduleHtml += '<div>No fixtures generated.</div>';
  else {
    const sorted = fixtures.slice().sort((a,b)=>{
      const ra = a.round || 9999, rb = b.round || 9999;
      if (ra !== rb) return ra - rb;
      if (a.court !== b.court) return a.court - b.court;
      return a.matchNum - b.matchNum;
    });
    scheduleHtml += `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;font-size:12px;">
      <thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Round</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Match</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Court</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Team A (Players)</th><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd;">Team B (Players)</th></tr></thead><tbody>`;
    sorted.forEach(m=>{
      const rlabel = m.round ? `R${m.round}` : '';
      const t1players = (m.t1 && m.t1.players && m.t1.players.length) ? (m.t1.players.map(p => (p.dupr ? `${p.name} [${p.dupr}]` : p.name)).join(' & ')) : '';
      const t2players = (m.t2 && m.t2.players && m.t2.players.length) ? (m.t2.players.map(p => (p.dupr ? `${p.name} [${p.dupr}]` : p.name)).join(' & ')) : '';
      scheduleHtml += `<tr>
        <td style="padding:6px;border-bottom:1px solid #eee;">${rlabel}</td>
        <td style="padding:6px;border-bottom:1px solid #eee;">${m.matchNum}</td>
        <td style="padding:6px;border-bottom:1px solid #eee;">${m.court}</td>
        <td style="padding:6px;border-bottom:1px solid #eee;">${escapeHtml(m.t1.name)}<div style="font-size:11px;color:#667085">${escapeHtml(t1players)}</div></td>
        <td style="padding:6px;border-bottom:1px solid #eee;">${escapeHtml(m.t2.name)}<div style="font-size:11px;color:#667085">${escapeHtml(t2players)}</div></td>
      </tr>`;
    });
    scheduleHtml += '</tbody></table>';
  }
  return scheduleHtml;
}

function exportSummaryPDF(){
  const active = getActiveTournament();
  if (!active) return showToast('No active tournament to export.','warn');

  const title = active.name || 'Tournament';
  const created = new Date(active.createdAt).toLocaleString();
  const lastSaved = new Date(active.lastSaved || active.createdAt).toLocaleString();

  const page = `
    <html><head><title>${title}</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;color:#102238;padding:18px;}
      h1{font-size:20px;margin-bottom:6px;}
      h3{font-size:16px;margin-top:12px;margin-bottom:6px;}
      table{font-size:12px;}
      @media print { body { -webkit-print-color-adjust: exact; } }
    </style>
    </head><body>
      <h1>${title}</h1>
      <div style="color:#667085;font-size:12px;margin-bottom:10px;">Created: ${created} ‚Ä¢ Saved: ${lastSaved}</div>
      ${buildTeamsHtml()}
      ${buildRankHtml()}
      ${buildScheduleHtml()}
    </body></html>
  `;
  const w = window.open('', '_blank');
  if (!w) { showToast('Popup blocked ‚Äî allow popups to export PDF.','warn'); return; }
  w.document.open();
  w.document.write(page);
  w.document.close();
  setTimeout(()=>{ w.focus(); w.print(); }, 350);
}

function exportSchedulePDF(){
  const active = getActiveTournament();
  if (!active) return showToast('No active tournament to export.','warn');
  const title = (active.name || 'Tournament') + ' ‚Äî Schedule';
  const created = new Date(active.createdAt).toLocaleString();
  const page = `
    <html><head><title>${title}</title>
    <style>
      body{font-family:Arial,Helvetica,sans-serif;color:#102238;padding:18px;}
      h1{font-size:18px;margin-bottom:6px;}
      h3{font-size:14px;margin-top:12px;margin-bottom:6px;}
      table{font-size:12px;}
      @media print { body { -webkit-print-color-adjust: exact; } }
    </style>
    </head><body>
      <h1>${title}</h1>
      <div style="color:#667085;font-size:12px;margin-bottom:10px;">Created: ${created}</div>
      ${buildScheduleHtml()}
    </body></html>
  `;
  const w = window.open('', '_blank');
  if (!w) { showToast('Popup blocked ‚Äî allow popups to export PDF.','warn'); return; }
  w.document.open();
  w.document.write(page);
  w.document.close();
  setTimeout(()=>{ w.focus(); w.print(); }, 350);
}

function printScheduleOnly(){
  exportSchedulePDF();
}

/* ---------- Reset ---------- */
function resetAll(){
  if (!confirm('Reset all tournament data and UI?')) return;
  teams = []; fixtures = []; rankings = {}; knockout = {}; clubs = [];
  $('entryInner').innerHTML=''; $('entryCard').style.display='none';
  $('summaryInner').innerHTML=''; $('summaryCard').style.display='none';
  $('fixturesGrid').innerHTML=''; $('fixturesCard').style.display='none';
  $('rankingsInner').innerHTML=''; $('rankingsCard').style.display='none';
  $('knockoutsInner').innerHTML=''; $('knockoutsCard').style.display='none';
  $('gameType').value='doubles'; $('numTeams').value=8; $('numCourts').value=2; $('numGroups').value=2;
  $('courtAlloc').value='roundwise';
  updateQualifierDefaults(); if ($('enableQF')) $('enableQF').checked=false; $('rrType').value='within';
  $('enableDUPR').checked = false;
  onRRTypeChange();
  setActiveTournamentId(null);
  renderTournamentInfo();
  updateBanner('Round Robin');
  showToast('Reset complete.','success');
}

/* ---------- Render knockout from snapshot ---------- */
function renderAppropriateKnockoutView(){
  if (!knockout) { $('knockoutsCard').style.display = 'none'; return; }
  if (knockout.qf) renderQuarterfinals();
  else if (knockout.sf1 && knockout.sf2) renderSemifinals();
  else if (knockout.final) renderFinals();
  else $('knockoutsCard').style.display = 'none';
}

/* ---------- Bind UI (robust attachment) ---------- */
function bindUI(){
  $('startEntryBtn').onclick = startEntry;
  $('resetBtn').onclick = resetAll;
  $('genRRBtn').onclick = generateRoundRobinRankings;
  $('quickGenFixtures').onclick = generateFixtures;
  $('quickGenRanks').onclick = generateRoundRobinRankings;
  $('proceedKO').onclick = proceedToKnockouts;
  $('exportCSVBtn').onclick = exportRankingsCSV;
  $('exportPDFBtn').onclick = exportSummaryPDF;
  $('exportSchedulePdfBtn').onclick = exportSchedulePDF;
  $('printBtn').onclick = ()=> window.print();
  $('printScheduleBtn').onclick = printScheduleOnly;
  $('quickExportSchedule').onclick = exportSchedulePDF;
  $('numTeams').addEventListener('input', updateQualifierDefaults);
  $('numGroups').addEventListener('input', updateQualifierDefaults);
  $('qualPerGroup').addEventListener('change', onQualPerGroupManual);
  $('loadBtn').onclick = openLoadDialog;
  $('manualSaveBtn') && ($('manualSaveBtn').onclick = manualSaveFromUI);
  $('manualSaveBtnKO') && ($('manualSaveBtnKO').onclick = manualSaveFromUI);
  $('renameTourneyBtn') && ($('renameTourneyBtn').onclick = renameActiveTournament);

  // Ensure Manage Clubs button click always handled via addEventListener (safer)
  const manageBtn = $('manageClubsBtn');
  if (manageBtn) {
    manageBtn.setAttribute('type','button');
    try {
      const fresh = manageBtn.cloneNode(true);
      manageBtn.parentNode.replaceChild(fresh, manageBtn);
      fresh.addEventListener('click', (ev) => {
        console.log('Manage Clubs clicked');
        showToast('Opening Manage Clubs‚Ä¶','success');
        openClubDialog();
      });
    } catch (e){
      manageBtn.addEventListener('click', (ev) => { console.log('Manage Clubs clicked (fallback)'); showToast('Opening Manage Clubs‚Ä¶','success'); openClubDialog(); });
    }
  }

  const backBtn = $('backToSummaryBtn');
  if (backBtn) backBtn.onclick = () => { $('fixturesCard').style.display='none'; $('summaryCard').style.display='block'; updateBanner('Group Summary'); };
}

/* ---------- Init ---------- */
(function init(){
  onGameTypeChange();
  updateQualifierDefaults();
  bindUI();
  renderLoadControl();
  renderTournamentInfo();
  onRRTypeChange();
})();

/* ---------- Small helpers ---------- */
function escapeHtml(str){
  if (!str && str !== '') return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>





